<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AiOS — macOS Sonoma Enhanced</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
/* =============================================
   ROOT VARIABLES & RESET
   ============================================= */
:root {
  --accent: #0071e3;
  --accent-hover: #0077ed;
  --accent-rgb: 0,113,227;
  --bg-glass: rgba(255,255,255,0.72);
  --bg-glass-dark: rgba(28,28,30,0.82);
  --border: rgba(0,0,0,0.1);
  --border-dark: rgba(255,255,255,0.12);
  --text: #1d1d1f;
  --text-dark: #f5f5f7;
  --text-sec: rgba(60,60,67,0.6);
  --text-sec-dark: rgba(235,235,245,0.6);
  --shadow-sm: 0 2px 12px rgba(0,0,0,0.12);
  --shadow-md: 0 8px 32px rgba(0,0,0,0.2), 0 2px 8px rgba(0,0,0,0.1);
  --shadow-lg: 0 24px 64px rgba(0,0,0,0.28), 0 4px 16px rgba(0,0,0,0.14);
  --radius: 18px;
  --radius-sm: 10px;
  --radius-xs: 6px;
  --dock-sz: 56px;
  --menubar-h: 28px;
  --transition: all 0.2s cubic-bezier(0.4,0,0.2,1);
}

*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  overflow: hidden;
  width: 100vw; height: 100vh;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* =============================================
   DARK MODE
   ============================================= */
body.dark {
  --bg-glass: var(--bg-glass-dark);
  --border: var(--border-dark);
  --text: var(--text-dark);
  --text-sec: var(--text-sec-dark);
}

/* =============================================
   DESKTOP
   ============================================= */
#desktop {
  width: 100%; height: 100%;
  position: relative;
  overflow: hidden;
  background: linear-gradient(160deg, #1a6b9e 0%, #2d4f6c 30%, #1c3b55 60%, #0f2133 100%);
  background-size: cover;
  background-position: center;
}

#desktop-bg-overlay {
  position: absolute; inset: 0;
  pointer-events: none;
  z-index: 0;
}

/* =============================================
   MENUBAR
   ============================================= */
#menubar {
  position: fixed;
  top: 0; left: 0; right: 0;
  height: var(--menubar-h);
  background: var(--bg-glass);
  backdrop-filter: blur(24px) saturate(1.8);
  -webkit-backdrop-filter: blur(24px) saturate(1.8);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center;
  justify-content: space-between;
  padding: 0 14px;
  z-index: 10000;
  font-size: 13px;
  font-weight: 500;
  color: var(--text);
  gap: 0;
}

body.dark #menubar { background: rgba(20,20,22,0.88); }

.menubar-left, .menubar-right {
  display: flex; align-items: center;
  flex: 1;
}

.menubar-right { justify-content: flex-end; gap: 4px; }

.mb-apple {
  font-size: 16px;
  cursor: pointer;
  padding: 2px 8px;
  border-radius: 4px;
  margin-right: 4px;
  transition: var(--transition);
  line-height: 1;
}
.mb-apple:hover { background: rgba(0,0,0,0.08); }
body.dark .mb-apple:hover { background: rgba(255,255,255,0.1); }

.mb-item {
  cursor: pointer;
  padding: 2px 8px;
  border-radius: 4px;
  white-space: nowrap;
  transition: var(--transition);
  font-size: 13px;
  color: var(--text);
}
.mb-item:hover { background: rgba(0,0,0,0.08); }
body.dark .mb-item:hover { background: rgba(255,255,255,0.1); }

#mb-active-app { font-weight: 700; }

.mb-icon {
  cursor: pointer;
  padding: 3px 6px;
  border-radius: 4px;
  font-size: 13px;
  color: var(--text);
  display: flex; align-items: center;
  transition: var(--transition);
}
.mb-icon:hover { background: rgba(0,0,0,0.08); }
body.dark .mb-icon:hover { background: rgba(255,255,255,0.1); }

#clock {
  font-size: 12px;
  font-weight: 500;
  cursor: default;
  padding: 2px 6px;
  white-space: nowrap;
}

/* =============================================
   APPLE MENU DROPDOWN
   ============================================= */
.sys-dropdown {
  display: none;
  position: fixed;
  top: var(--menubar-h);
  background: var(--bg-glass);
  backdrop-filter: blur(40px) saturate(2);
  -webkit-backdrop-filter: blur(40px) saturate(2);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 5px 0;
  box-shadow: var(--shadow-lg);
  z-index: 20000;
  font-size: 13px;
  min-width: 200px;
  animation: menuAppear 0.12s ease;
}
body.dark .sys-dropdown { background: rgba(35,35,38,0.95); }

@keyframes menuAppear {
  from { opacity:0; transform:scale(0.95) translateY(-4px); }
  to { opacity:1; transform:scale(1) translateY(0); }
}

#apple-dropdown { left: 8px; }

.dd-item {
  padding: 5px 20px;
  cursor: pointer;
  color: var(--text);
  display: flex; align-items: center; gap: 10px;
  font-size: 13px;
  border-radius: 0;
  transition: none;
}
.dd-item:hover { background: var(--accent); color: #fff !important; }
.dd-item:hover * { color: #fff !important; }
.dd-sep { height: 1px; background: var(--border); margin: 4px 10px; }
.dd-icon { width: 16px; text-align: center; font-size: 12px; opacity: 0.7; }

/* =============================================
   DESKTOP ICONS
   ============================================= */
.desktop-icon {
  position: absolute;
  display: flex; flex-direction: column;
  align-items: center; gap: 4px;
  cursor: pointer;
  padding: 8px 6px;
  border-radius: 12px;
  width: 82px;
  transition: background 0.15s;
  z-index: 100;
  user-select: none;
}
.desktop-icon:hover { background: rgba(255,255,255,0.18); }
.desktop-icon.selected { background: rgba(0,112,227,0.4); outline: 2px solid rgba(0,112,227,0.6); }
.desktop-icon.dragging { opacity: 0.75; z-index: 500; }

.di-icon {
  width: 52px; height: 52px;
  border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  font-size: 30px;
  pointer-events: none;
  flex-shrink: 0;
}
.di-label {
  font-size: 11px;
  color: #fff;
  text-shadow: 0 1px 4px rgba(0,0,0,0.8), 0 0 8px rgba(0,0,0,0.4);
  text-align: center;
  word-break: break-word;
  max-width: 74px;
  line-height: 1.3;
  pointer-events: none;
}
body.dark .di-label { color: #fff; }

/* =============================================
   WINDOW SYSTEM
   ============================================= */
#windows-layer {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 1000;
}

.window {
  position: fixed;
  min-width: 280px; min-height: 180px;
  background: var(--bg-glass);
  backdrop-filter: blur(40px) saturate(1.8);
  -webkit-backdrop-filter: blur(40px) saturate(1.8);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow-lg);
  display: flex; flex-direction: column;
  overflow: hidden;
  pointer-events: all;
  transform-origin: center bottom;
  will-change: transform;
}
body.dark .window { background: rgba(28,28,30,0.88); }

.window.anim-open { animation: winOpen 0.28s cubic-bezier(0.34,1.56,0.64,1) forwards; }
.window.anim-close { animation: winClose 0.18s ease forwards; }
.window.anim-minimize { animation: winMinimize 0.38s cubic-bezier(0.4,0,1,1) forwards; }

@keyframes winOpen {
  from { opacity:0; transform:scale(0.82) translateY(12px); }
  to { opacity:1; transform:scale(1) translateY(0); }
}
@keyframes winClose {
  from { opacity:1; transform:scale(1); }
  to { opacity:0; transform:scale(0.9) translateY(-8px); }
}
@keyframes winMinimize {
  to { opacity:0; transform:scale(0.15) translateY(80vh) translateX(var(--min-tx,0)); }
}

/* Titlebar */
.win-bar {
  height: 40px; min-height: 40px;
  display: flex; align-items: center;
  padding: 0 14px;
  cursor: move;
  position: relative;
  flex-shrink: 0;
  border-bottom: 1px solid var(--border);
}
body.dark .win-bar { background: rgba(255,255,255,0.04); }

/* Traffic lights */
.tl-wrap { display: flex; gap: 7px; align-items: center; z-index: 2; flex-shrink: 0; }

.tl {
  width: 12px; height: 12px;
  border-radius: 50%;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  font-size: 0; font-weight: 700;
  transition: filter 0.12s;
  border: 0.5px solid rgba(0,0,0,0.1);
  flex-shrink: 0;
}
.tl:hover { font-size: 7px; color: rgba(0,0,0,0.6); }
.tl-red { background: #ff5f57; }
.tl-yel { background: #febc2e; }
.tl-grn { background: #28c840; }

.win-bar:not(:hover) .tl { /* subtle when not hovering */ }
.win-title {
  position: absolute; left: 50%; top: 50%;
  transform: translate(-50%,-50%);
  font-size: 13px; font-weight: 600;
  color: var(--text); max-width: 55%;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  pointer-events: none;
}

/* Window content */
.win-body {
  flex: 1;
  overflow: auto;
  position: relative;
  color: var(--text);
}

/* Resize handle */
.win-resize {
  position: absolute; bottom: 0; right: 0;
  width: 18px; height: 18px;
  cursor: nwse-resize;
  z-index: 5;
}
.win-resize::before {
  content: '';
  position: absolute; bottom: 4px; right: 4px;
  width: 9px; height: 9px;
  border-right: 2px solid var(--text-sec);
  border-bottom: 2px solid var(--text-sec);
  border-radius: 1px;
}

/* =============================================
   DOCK
   ============================================= */
#dock-wrap {
  position: fixed;
  bottom: 10px; left: 50%;
  transform: translateX(-50%);
  z-index: 9000;
}

#dock {
  background: rgba(255,255,255,0.26);
  backdrop-filter: blur(32px) saturate(2);
  -webkit-backdrop-filter: blur(32px) saturate(2);
  border: 1px solid rgba(255,255,255,0.52);
  border-radius: 22px;
  padding: 8px 14px;
  display: flex; align-items: flex-end;
  gap: 7px;
  box-shadow: 0 8px 40px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.7);
}
body.dark #dock {
  background: rgba(25,25,28,0.55);
  border-color: rgba(255,255,255,0.18);
  box-shadow: 0 8px 40px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.08);
}

.d-item {
  display: flex; flex-direction: column;
  align-items: center; gap: 2px;
  cursor: pointer;
  position: relative;
}

.d-icon {
  width: var(--dock-sz); height: var(--dock-sz);
  border-radius: calc(var(--dock-sz) * 0.225);
  display: flex; align-items: center; justify-content: center;
  font-size: calc(var(--dock-sz) * 0.52);
  box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  transition: transform 0.22s cubic-bezier(0.34,1.56,0.64,1);
  position: relative;
  overflow: hidden;
  flex-shrink: 0;
}

.d-item:hover .d-icon { transform: translateY(-14px) scale(1.22); }
.d-item:hover .d-tooltip { opacity: 1; transform: translateX(-50%) translateY(0); pointer-events: none; }

.d-dot {
  width: 4px; height: 4px;
  border-radius: 50%;
  background: rgba(0,0,0,0.45);
  transition: opacity 0.2s;
}
body.dark .d-dot { background: rgba(255,255,255,0.55); }

.d-tooltip {
  position: absolute;
  bottom: calc(100% + 14px);
  left: 50%; transform: translateX(-50%) translateY(4px);
  background: rgba(20,20,22,0.85);
  color: #fff;
  font-size: 12px;
  font-weight: 500;
  padding: 4px 12px;
  border-radius: 7px;
  white-space: nowrap;
  opacity: 0;
  transition: all 0.15s;
  backdrop-filter: blur(8px);
  pointer-events: none;
}

.d-sep {
  width: 1px;
  height: calc(var(--dock-sz) - 10px);
  background: var(--border);
  margin: 0 2px;
  align-self: center;
  opacity: 0.6;
}

/* Dock bounce */
@keyframes dockBounce {
  0%,100% { transform: translateY(0); }
  30% { transform: translateY(-22px); }
  60% { transform: translateY(-8px); }
  80% { transform: translateY(-16px); }
}
.d-item.bouncing .d-icon { animation: dockBounce 0.7s ease 0s 2; }

/* =============================================
   CONTEXT MENU
   ============================================= */
#ctx-menu {
  display: none;
  position: fixed;
  background: var(--bg-glass);
  backdrop-filter: blur(40px) saturate(2);
  -webkit-backdrop-filter: blur(40px) saturate(2);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 5px 0;
  box-shadow: var(--shadow-lg);
  z-index: 30000;
  min-width: 196px;
  animation: menuAppear 0.12s ease;
}
body.dark #ctx-menu { background: rgba(35,35,38,0.96); }

.ctx-item {
  padding: 5px 16px;
  cursor: pointer;
  color: var(--text);
  font-size: 13px;
  display: flex; align-items: center; gap: 9px;
  transition: none;
}
.ctx-item:hover { background: var(--accent); color: #fff; margin: 0 4px; padding: 5px 12px; border-radius: 6px; }
.ctx-sub { font-size: 11px; opacity: 0.55; margin-left: auto; }
.ctx-sep { height: 1px; background: var(--border); margin: 4px 10px; }
.ctx-disabled { opacity: 0.38; cursor: default; }
.ctx-disabled:hover { background: none !important; color: var(--text) !important; margin: 0; padding: 5px 16px; }

/* =============================================
   DOCK CONTEXT MENU (for dock items)
   ============================================= */
#dock-ctx {
  display: none;
  position: fixed;
  background: var(--bg-glass);
  backdrop-filter: blur(40px) saturate(2);
  -webkit-backdrop-filter: blur(40px) saturate(2);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 5px 0;
  box-shadow: var(--shadow-lg);
  z-index: 30001;
  min-width: 170px;
  animation: menuAppear 0.1s ease;
}
body.dark #dock-ctx { background: rgba(35,35,38,0.96); }
.dctx-item {
  padding: 5px 16px;
  cursor: pointer;
  color: var(--text);
  font-size: 13px;
  display: flex; align-items: center; gap: 9px;
}
.dctx-item:hover { background: var(--accent); color: #fff; margin: 0 4px; padding: 5px 12px; border-radius: 6px; }
.dctx-title {
  padding: 4px 16px 2px;
  font-size: 12px; font-weight: 700;
  color: var(--text-sec);
  cursor: default;
}
.dctx-sep { height: 1px; background: var(--border); margin: 4px 10px; }

/* =============================================
   NOTIFICATIONS
   ============================================= */
#notif-container {
  position: fixed;
  top: calc(var(--menubar-h) + 10px);
  right: 12px;
  z-index: 25000;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.notif {
  background: var(--bg-glass);
  backdrop-filter: blur(30px) saturate(1.8);
  -webkit-backdrop-filter: blur(30px) saturate(1.8);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 12px 16px;
  max-width: 300px;
  box-shadow: var(--shadow-md);
  font-size: 13px;
  color: var(--text);
  display: flex; gap: 10px; align-items: flex-start;
  animation: notifIn 0.3s cubic-bezier(0.34,1.2,0.64,1);
}
body.dark .notif { background: rgba(38,38,42,0.95); }

.notif-icon { font-size: 20px; flex-shrink: 0; }
.notif-body { flex: 1; }
.notif-title { font-weight: 600; margin-bottom: 2px; }
.notif-msg { font-size: 12px; color: var(--text-sec); }
.notif-close { cursor: pointer; opacity: 0.5; font-size: 14px; flex-shrink: 0; }
.notif-close:hover { opacity: 1; }

@keyframes notifIn {
  from { opacity:0; transform:translateX(120%); }
  to { opacity:1; transform:translateX(0); }
}
@keyframes notifOut {
  from { opacity:1; transform:translateX(0); max-height:200px; }
  to { opacity:0; transform:translateX(120%); max-height:0; padding:0; margin:0; }
}

/* =============================================
   SPOTLIGHT
   ============================================= */
#spotlight-wrap {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  z-index: 22000;
  background: rgba(0,0,0,0.25);
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
  align-items: flex-start;
  justify-content: center;
  padding-top: 18vh;
}

#spotlight-box {
  width: 660px;
  max-width: 90vw;
  background: var(--bg-glass);
  backdrop-filter: blur(50px) saturate(2);
  -webkit-backdrop-filter: blur(50px) saturate(2);
  border: 1px solid rgba(255,255,255,0.5);
  border-radius: 16px;
  box-shadow: var(--shadow-lg);
  overflow: hidden;
  animation: menuAppear 0.2s ease;
}
body.dark #spotlight-box { background: rgba(35,35,40,0.95); border-color: rgba(255,255,255,0.15); }

#spotlight-input-wrap {
  display: flex; align-items: center;
  padding: 0 18px;
  border-bottom: 1px solid var(--border);
}
#spotlight-icon { font-size: 18px; color: var(--text-sec); flex-shrink: 0; }
#spotlight-input {
  flex: 1;
  padding: 18px 12px;
  font-size: 20px;
  border: none; outline: none;
  background: transparent;
  color: var(--text);
  font-family: inherit;
}

#spotlight-results { padding: 5px 0; max-height: 400px; overflow-y: auto; }
.sp-result {
  padding: 8px 18px;
  cursor: pointer;
  display: flex; align-items: center; gap: 12px;
  font-size: 14px;
  color: var(--text);
}
.sp-result:hover, .sp-result.focused { background: var(--accent); color: #fff; }
.sp-result:hover .sp-sub, .sp-result.focused .sp-sub { color: rgba(255,255,255,0.75); }
.sp-icon { width: 36px; height: 36px; border-radius: 9px; display:flex; align-items:center; justify-content:center; font-size:20px; flex-shrink:0; }
.sp-info { flex: 1; }
.sp-name { font-weight: 600; }
.sp-sub { font-size: 12px; color: var(--text-sec); }

/* =============================================
   LAUNCHPAD
   ============================================= */
#launchpad {
  display: none;
  position: fixed; inset: 0;
  z-index: 8500;
  background: rgba(0,0,0,0.45);
  backdrop-filter: blur(36px) saturate(1.2);
  -webkit-backdrop-filter: blur(36px) saturate(1.2);
  flex-direction: column;
  align-items: center;
  padding-top: 14vh;
}

#lp-search-wrap {
  margin-bottom: 36px;
}
#lp-search {
  width: 260px;
  padding: 9px 18px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.3);
  background: rgba(255,255,255,0.18);
  color: #fff;
  font-size: 16px;
  outline: none;
  backdrop-filter: blur(10px);
  text-align: center;
  font-family: inherit;
}
#lp-search::placeholder { color: rgba(255,255,255,0.6); }

#lp-grid {
  display: grid;
  grid-template-columns: repeat(7, 90px);
  gap: 20px 10px;
  padding: 0 40px;
  max-width: 700px;
}

.lp-item {
  display: flex; flex-direction: column;
  align-items: center; gap: 8px;
  cursor: pointer;
  padding: 10px 6px;
  border-radius: 14px;
  transition: background 0.15s;
}
.lp-item:hover { background: rgba(255,255,255,0.1); }

.lp-icon {
  width: 64px; height: 64px;
  border-radius: 16px;
  display: flex; align-items: center; justify-content: center;
  font-size: 34px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.3);
  flex-shrink: 0;
}
.lp-name {
  font-size: 12px;
  color: #fff;
  text-shadow: 0 1px 4px rgba(0,0,0,0.5);
  text-align: center;
  max-width: 80px;
  word-break: break-word;
}

/* =============================================
   COMMON UI COMPONENTS
   ============================================= */
/* Scrollbars */
::-webkit-scrollbar { width: 7px; height: 7px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(128,128,128,0.3); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: rgba(128,128,128,0.5); }

/* Button base */
.btn {
  padding: 5px 14px;
  border-radius: 7px;
  border: 1px solid var(--border);
  background: rgba(0,0,0,0.05);
  color: var(--text);
  font-size: 13px;
  cursor: pointer;
  font-family: inherit;
  font-weight: 500;
  transition: var(--transition);
}
.btn:hover { background: rgba(0,0,0,0.1); }
body.dark .btn { background: rgba(255,255,255,0.08); }
body.dark .btn:hover { background: rgba(255,255,255,0.15); }
.btn-primary { background: var(--accent); color: #fff; border-color: var(--accent); }
.btn-primary:hover { background: var(--accent-hover); }
.btn-danger { background: #ff3b30; color: #fff; border-color: #ff3b30; }
.btn-danger:hover { background: #ff2d20; }
.btn-sm { padding: 3px 10px; font-size: 12px; }

/* Input */
.input {
  padding: 6px 12px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: rgba(0,0,0,0.05);
  color: var(--text);
  font-size: 13px;
  outline: none;
  font-family: inherit;
  transition: border-color 0.15s;
  width: 100%;
}
.input:focus { border-color: var(--accent); }
body.dark .input { background: rgba(255,255,255,0.08); }

/* Toggle */
.toggle {
  width: 40px; height: 24px;
  border-radius: 12px;
  background: #d1d1d6;
  cursor: pointer;
  position: relative;
  transition: background 0.2s;
  flex-shrink: 0;
}
.toggle.on { background: #34c759; }
.toggle::after {
  content: '';
  position: absolute;
  width: 20px; height: 20px;
  background: #fff;
  border-radius: 50%;
  top: 2px; left: 2px;
  transition: left 0.2s cubic-bezier(0.4,0,0.2,1);
  box-shadow: 0 1px 4px rgba(0,0,0,0.25);
}
.toggle.on::after { left: 18px; }

/* Range */
.range {
  -webkit-appearance: none;
  appearance: none;
  width: 100%;
  height: 4px;
  border-radius: 2px;
  background: rgba(0,0,0,0.12);
  outline: none;
  cursor: pointer;
}
.range::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 18px; height: 18px;
  border-radius: 50%;
  background: var(--accent);
  cursor: pointer;
  box-shadow: 0 1px 4px rgba(0,0,0,0.2);
}
body.dark .range { background: rgba(255,255,255,0.12); }

/* =============================================
   LIQUID GLASS EFFECT
   ============================================= */
#dock {
  background: rgba(255,255,255,0.14) !important;
  backdrop-filter: blur(60px) saturate(2.5) brightness(1.15) !important;
  -webkit-backdrop-filter: blur(60px) saturate(2.5) brightness(1.15) !important;
  border: 1px solid rgba(255,255,255,0.6) !important;
  box-shadow:
    0 8px 40px rgba(0,0,0,0.30),
    0 1.5px 0 rgba(255,255,255,0.85) inset,
    0 -1px 0 rgba(0,0,0,0.08) inset,
    0 0 0 0.5px rgba(255,255,255,0.4) !important;
  position: relative;
  overflow: visible;
}

#dock::before {
  content: '';
  position: absolute;
  inset: 0;
  border-radius: 22px;
  background: linear-gradient(180deg,
    rgba(255,255,255,0.28) 0%,
    rgba(255,255,255,0.06) 40%,
    rgba(255,255,255,0.10) 100%
  );
  pointer-events: none;
  z-index: 0;
}

body.dark #dock {
  background: rgba(18,18,22,0.38) !important;
  border-color: rgba(255,255,255,0.14) !important;
  box-shadow:
    0 8px 40px rgba(0,0,0,0.55),
    0 1px 0 rgba(255,255,255,0.12) inset !important;
}

body.dark #dock::before {
  background: linear-gradient(180deg,
    rgba(255,255,255,0.10) 0%,
    rgba(255,255,255,0.02) 100%
  );
}

/* Liquid glass for menubar */
#menubar {
  background: rgba(255,255,255,0.60) !important;
  backdrop-filter: blur(48px) saturate(2.2) brightness(1.08) !important;
  -webkit-backdrop-filter: blur(48px) saturate(2.2) brightness(1.08) !important;
  border-bottom: 1px solid rgba(255,255,255,0.55) !important;
  box-shadow: 0 1px 0 rgba(0,0,0,0.06), 0 0 0 0.5px rgba(255,255,255,0.5) inset !important;
}

body.dark #menubar {
  background: rgba(15,15,18,0.72) !important;
  border-bottom-color: rgba(255,255,255,0.10) !important;
}

/* Glass windows */
.window {
  box-shadow:
    0 24px 64px rgba(0,0,0,0.28),
    0 4px 16px rgba(0,0,0,0.14),
    0 1px 0 rgba(255,255,255,0.8) inset,
    0 -1px 0 rgba(0,0,0,0.05) inset !important;
}

/* Liquid glass dock items */
.d-icon {
  box-shadow:
    0 4px 16px rgba(0,0,0,0.25),
    0 1px 0 rgba(255,255,255,0.35) inset !important;
}

/* Liquid glass dropdown */
.sys-dropdown {
  backdrop-filter: blur(56px) saturate(2.4) brightness(1.1) !important;
  -webkit-backdrop-filter: blur(56px) saturate(2.4) brightness(1.1) !important;
  border: 1px solid rgba(255,255,255,0.55) !important;
  box-shadow:
    0 8px 32px rgba(0,0,0,0.22),
    0 1px 0 rgba(255,255,255,0.8) inset !important;
}

/* =============================================
   MENUBAR DROPDOWN MENUS
   ============================================= */
.mb-menu-dropdown {
  display: none;
  position: fixed;
  top: var(--menubar-h);
  background: rgba(248,248,250,0.85);
  backdrop-filter: blur(56px) saturate(2.4) brightness(1.1);
  -webkit-backdrop-filter: blur(56px) saturate(2.4) brightness(1.1);
  border: 1px solid rgba(255,255,255,0.6);
  border-top: none;
  border-radius: 0 0 12px 12px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.22), 0 1px 0 rgba(255,255,255,0.8) inset;
  padding: 5px 0;
  min-width: 220px;
  z-index: 20001;
  animation: menuAppear 0.12s ease;
}
body.dark .mb-menu-dropdown {
  background: rgba(30,30,34,0.92);
  border-color: rgba(255,255,255,0.12);
}
.mb-menu-dropdown.active { display: block; }

.mbd-item {
  padding: 5px 20px;
  cursor: pointer;
  color: var(--text);
  font-size: 13px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  white-space: nowrap;
}
.mbd-item:hover { background: var(--accent); color: #fff; }
.mbd-item .mbd-shortcut {
  font-size: 11px;
  opacity: 0.5;
  font-weight: 400;
}
.mbd-item:hover .mbd-shortcut { opacity: 0.8; color: rgba(255,255,255,0.85); }
.mbd-sep { height: 1px; background: var(--border); margin: 4px 10px; }
.mbd-item.disabled { opacity: 0.4; pointer-events: none; }
.mbd-item.checked::before { content: '✓'; margin-right: 6px; font-size: 12px; }

/* Active menubar item */
.mb-item.mb-open { background: var(--accent) !important; color: #fff !important; border-radius: 4px; }

/* =============================================
   NOTIFICATION CENTER
   ============================================= */
#notif-center {
  position: fixed;
  top: var(--menubar-h);
  right: 0;
  width: 350px;
  height: calc(100vh - var(--menubar-h));
  background: rgba(242,242,247,0.88);
  backdrop-filter: blur(50px) saturate(2);
  -webkit-backdrop-filter: blur(50px) saturate(2);
  border-left: 1px solid var(--border);
  z-index: 19999;
  padding: 16px 12px;
  overflow-y: auto;
  transform: translateX(100%);
  transition: transform 0.35s cubic-bezier(0.4,0,0.2,1);
}
body.dark #notif-center { background: rgba(22,22,26,0.92); }
#notif-center.open { transform: translateX(0); }
.nc-title { font-size: 16px; font-weight: 700; color: var(--text); margin-bottom: 14px; }
.nc-widget {
  background: rgba(255,255,255,0.7);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 14px 16px;
  margin-bottom: 10px;
  backdrop-filter: blur(20px);
}
body.dark .nc-widget { background: rgba(44,44,48,0.9); }
.nc-widget-title { font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.6px; color: var(--text-sec); margin-bottom: 8px; }

/* =============================================
   CONTROL CENTER
   ============================================= */
#control-center {
  position: fixed;
  top: var(--menubar-h);
  right: 8px;
  width: 320px;
  background: rgba(242,242,247,0.82);
  backdrop-filter: blur(60px) saturate(2.5) brightness(1.1);
  -webkit-backdrop-filter: blur(60px) saturate(2.5) brightness(1.1);
  border: 1px solid rgba(255,255,255,0.65);
  border-radius: 0 0 18px 18px;
  box-shadow: 0 8px 40px rgba(0,0,0,0.22), 0 1px 0 rgba(255,255,255,0.8) inset;
  z-index: 19998;
  padding: 14px;
  display: none;
  animation: menuAppear 0.15s ease;
}
body.dark #control-center {
  background: rgba(22,22,26,0.90);
  border-color: rgba(255,255,255,0.12);
}
.cc-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  margin-bottom: 10px;
}
.cc-btn {
  background: rgba(255,255,255,0.7);
  border: 1px solid rgba(255,255,255,0.5);
  border-radius: 12px;
  padding: 12px;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  gap: 4px;
  transition: var(--transition);
  position: relative;
  overflow: hidden;
}
body.dark .cc-btn { background: rgba(60,60,64,0.9); }
.cc-btn:hover { transform: scale(0.97); }
.cc-btn.on { background: var(--accent); color: #fff; }
.cc-btn.on .cc-btn-label { color: #fff; }
.cc-btn-icon { font-size: 20px; }
.cc-btn-label { font-size: 11px; font-weight: 600; color: var(--text); }
.cc-btn.on .cc-btn-label { color: rgba(255,255,255,0.9); }
.cc-slider-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
.cc-slider-icon { font-size: 16px; }
.cc-slider { flex: 1; height: 4px; border-radius: 2px; cursor: pointer; accent-color: var(--accent); }
.cc-sep { height: 1px; background: var(--border); margin: 8px 0; }

/* =============================================
   EXTRA WALLPAPERS
   ============================================= */
.wp-opt.wp-glass {
  position: relative;
  overflow: hidden;
}
.wp-opt.wp-glass::after {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 40%;
  background: linear-gradient(180deg, rgba(255,255,255,0.3), transparent);
  pointer-events: none;
}

/* =============================================
   TERMINAL APP
   ============================================= */
.terminal-wrap {
  display: flex;
  flex-direction: column;
  height: 100%;
  background: #1a1b1e;
  font-family: 'SF Mono', 'Menlo', monospace;
  font-size: 13px;
  color: #c9d1d9;
}
.terminal-titlebar {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 14px;
  background: #2d2e32;
  border-bottom: 1px solid #3a3b3f;
  font-size: 12px;
  color: #8b9094;
}
.terminal-body {
  flex: 1;
  overflow-y: auto;
  padding: 10px 14px;
}
.terminal-line {
  margin-bottom: 2px;
  line-height: 1.6;
  white-space: pre-wrap;
  word-break: break-all;
}
.terminal-prompt { color: #58a6ff; }
.terminal-prompt-sym { color: #3fb950; }
.terminal-error { color: #f85149; }
.terminal-success { color: #3fb950; }
.terminal-info { color: #79c0ff; }
.terminal-warning { color: #e3b341; }
.terminal-input-row {
  display: flex;
  align-items: center;
  padding: 6px 14px 10px;
  border-top: 1px solid #3a3b3f;
  gap: 6px;
}
.terminal-input-prompt { color: #3fb950; font-size: 13px; white-space: nowrap; }
.terminal-input {
  flex: 1;
  background: transparent;
  border: none;
  outline: none;
  color: #c9d1d9;
  font-family: inherit;
  font-size: 13px;
  caret-color: #58a6ff;
}

/* =============================================
   NOTES APP
   ============================================= */
.notes-wrap { display: flex; height: 100%; }
.notes-sidebar {
  width: 220px;
  background: rgba(255,248,210,0.6);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  flex-shrink: 0;
}
body.dark .notes-sidebar { background: rgba(40,36,20,0.6); }
.notes-toolbar {
  padding: 10px 12px;
  border-bottom: 1px solid var(--border);
  display: flex;
  gap: 6px;
}
.notes-list { flex: 1; overflow-y: auto; }
.note-item {
  padding: 10px 14px;
  cursor: pointer;
  border-bottom: 1px solid var(--border);
  transition: background 0.1s;
}
.note-item:hover { background: rgba(255,200,0,0.15); }
.note-item.active { background: rgba(255,193,7,0.25); }
.note-item-title { font-size: 13px; font-weight: 600; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.note-item-preview { font-size: 11px; color: var(--text-sec); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.note-item-date { font-size: 10px; color: var(--text-sec); margin-top: 2px; }
.notes-main {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.notes-main-toolbar {
  padding: 8px 14px;
  border-bottom: 1px solid var(--border);
  display: flex;
  gap: 6px;
  background: rgba(255,248,210,0.3);
}
body.dark .notes-main-toolbar { background: rgba(40,36,20,0.3); }
.notes-editor {
  flex: 1;
  outline: none;
  padding: 20px 24px;
  font-size: 14px;
  line-height: 1.8;
  color: var(--text);
  overflow-y: auto;
  background: rgba(255,248,220,0.25);
}
body.dark .notes-editor { background: rgba(35,30,10,0.3); }
.notes-editor:empty::before { content: 'Začněte psát poznámku...'; color: var(--text-sec); }

/* =============================================
   MAPS APP
   ============================================= */
.maps-wrap { display: flex; flex-direction: column; height: 100%; position: relative; }
.maps-search-bar {
  position: absolute;
  top: 12px; left: 12px;
  z-index: 10;
  display: flex;
  gap: 8px;
  background: var(--bg-glass);
  backdrop-filter: blur(30px) saturate(2);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 8px 12px;
  box-shadow: var(--shadow-md);
  width: calc(100% - 24px);
}
.maps-input {
  flex: 1;
  border: none;
  outline: none;
  background: transparent;
  font-size: 14px;
  color: var(--text);
  font-family: inherit;
}
.maps-canvas {
  flex: 1;
  background: linear-gradient(135deg,#d4e6c3,#a8d5a2,#7dbf8e);
  position: relative;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
}
.maps-grid-overlay {
  position: absolute;
  inset: 0;
  background-image:
    linear-gradient(rgba(255,255,255,0.08) 1px, transparent 1px),
    linear-gradient(90deg, rgba(255,255,255,0.08) 1px, transparent 1px);
  background-size: 40px 40px;
}
.maps-road-h {
  position: absolute;
  height: 4px;
  background: #fff;
  border-radius: 2px;
  opacity: 0.8;
}
.maps-road-v {
  position: absolute;
  width: 4px;
  background: #fff;
  border-radius: 2px;
  opacity: 0.8;
}
.maps-pin {
  font-size: 32px;
  animation: mapPinBounce 1s ease-in-out;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -100%);
  text-shadow: 0 4px 12px rgba(0,0,0,0.3);
}
@keyframes mapPinBounce {
  0% { transform: translate(-50%, -200%); opacity: 0; }
  60% { transform: translate(-50%, -90%); }
  80% { transform: translate(-50%, -110%); }
  100% { transform: translate(-50%, -100%); opacity: 1; }
}
.maps-building {
  position: absolute;
  background: rgba(255,255,255,0.4);
  border: 1px solid rgba(255,255,255,0.6);
  border-radius: 4px;
}
.maps-info-panel {
  position: absolute;
  bottom: 0; left: 0; right: 0;
  background: var(--bg-glass);
  backdrop-filter: blur(30px);
  border-top: 1px solid var(--border);
  padding: 14px 16px;
  display: none;
  font-size: 13px;
}
.maps-info-panel.visible { display: block; }

/* =============================================
   CLOCK APP
   ============================================= */
.clock-wrap { display: flex; flex-direction: column; height: 100%; }
.clock-tabs {
  display: flex;
  border-bottom: 1px solid var(--border);
  padding: 0 16px;
}
.clock-tab {
  padding: 10px 16px;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  color: var(--text-sec);
  border-bottom: 2px solid transparent;
  margin-bottom: -1px;
  transition: color 0.15s;
}
.clock-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
.clock-body { flex: 1; overflow: auto; padding: 20px; }

/* Analog clock */
.analog-clock-wrap {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 16px;
}
.analog-clock {
  width: 200px; height: 200px;
  border-radius: 50%;
  background: linear-gradient(145deg, #f8f8fa, #e8e8f0);
  border: 3px solid rgba(0,0,0,0.12);
  position: relative;
  box-shadow: 0 8px 32px rgba(0,0,0,0.15), inset 0 2px 8px rgba(255,255,255,0.8);
}
body.dark .analog-clock {
  background: linear-gradient(145deg, #2a2a30, #1a1a22);
  border-color: rgba(255,255,255,0.12);
}
.clock-hand {
  position: absolute;
  bottom: 50%;
  left: 50%;
  transform-origin: bottom center;
  border-radius: 4px;
}
.clock-hand-hour {
  width: 5px; height: 55px;
  margin-left: -2.5px;
  background: var(--text);
}
.clock-hand-min {
  width: 3px; height: 75px;
  margin-left: -1.5px;
  background: var(--text);
}
.clock-hand-sec {
  width: 1.5px; height: 85px;
  margin-left: -0.75px;
  background: #ff3b30;
}
.clock-center-dot {
  position: absolute;
  width: 10px; height: 10px;
  background: #ff3b30;
  border-radius: 50%;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  z-index: 2;
}
.clock-tick {
  position: absolute;
  top: 4px;
  left: 50%;
  transform-origin: 0 96px;
  width: 2px;
  height: 8px;
  background: var(--text-sec);
  margin-left: -1px;
  border-radius: 1px;
}
.clock-tick.major { height: 12px; width: 3px; margin-left: -1.5px; background: var(--text); }

/* World clocks */
.worldclock-list { display: flex; flex-direction: column; gap: 10px; }
.worldclock-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  background: rgba(0,0,0,0.04);
  border-radius: 12px;
}
body.dark .worldclock-item { background: rgba(255,255,255,0.06); }
.wc-city { font-size: 16px; font-weight: 600; color: var(--text); }
.wc-country { font-size: 12px; color: var(--text-sec); }
.wc-time { font-size: 28px; font-weight: 300; color: var(--text); letter-spacing: -0.5px; }
.wc-ampm { font-size: 14px; font-weight: 400; }

/* Stopwatch */
.stopwatch-display {
  font-size: 60px;
  font-weight: 200;
  text-align: center;
  letter-spacing: -2px;
  color: var(--text);
  margin: 30px 0 24px;
  font-variant-numeric: tabular-nums;
}
.stopwatch-laps {
  max-height: 180px;
  overflow-y: auto;
  font-size: 13px;
  color: var(--text-sec);
}
.lap-row {
  display: flex;
  justify-content: space-between;
  padding: 6px 0;
  border-bottom: 1px solid var(--border);
}

/* =============================================
   WEATHER APP
   ============================================= */
.weather-wrap { display: flex; flex-direction: column; height: 100%; overflow: hidden; position: relative; }
.weather-bg-gradient {
  position: absolute; inset: 0;
  background: linear-gradient(160deg, #4facfe 0%, #00f2fe 50%, #a18cd1 100%);
  z-index: 0;
}
.weather-content { position: relative; z-index: 1; padding: 24px; color: #fff; flex: 1; overflow-y: auto; }
.weather-city { font-size: 26px; font-weight: 700; text-shadow: 0 2px 8px rgba(0,0,0,0.2); }
.weather-conditions { font-size: 14px; opacity: 0.85; margin-top: 2px; }
.weather-temp-big { font-size: 80px; font-weight: 100; line-height: 1; margin: 16px 0; letter-spacing: -4px; text-shadow: 0 4px 16px rgba(0,0,0,0.15); }
.weather-forecast {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 6px;
  margin-top: 20px;
}
.weather-day {
  background: rgba(255,255,255,0.18);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.28);
  border-radius: 12px;
  padding: 10px 6px;
  text-align: center;
}
.weather-day-name { font-size: 11px; font-weight: 600; opacity: 0.8; }
.weather-day-emoji { font-size: 22px; margin: 6px 0; }
.weather-day-hi { font-size: 14px; font-weight: 600; }
.weather-day-lo { font-size: 12px; opacity: 0.7; }
.weather-hourly {
  display: flex;
  gap: 8px;
  overflow-x: auto;
  padding-bottom: 8px;
  margin-top: 16px;
}
.weather-hour {
  background: rgba(255,255,255,0.18);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.28);
  border-radius: 12px;
  padding: 10px 12px;
  text-align: center;
  min-width: 56px;
  flex-shrink: 0;
}
.weather-hour-time { font-size: 11px; opacity: 0.8; }
.weather-hour-emoji { font-size: 20px; margin: 4px 0; }
.weather-hour-temp { font-size: 14px; font-weight: 600; }
.weather-details {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  margin-top: 16px;
}
.weather-detail {
  background: rgba(255,255,255,0.18);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.28);
  border-radius: 12px;
  padding: 12px 14px;
}
.weather-detail-label { font-size: 11px; font-weight: 600; opacity: 0.7; text-transform: uppercase; letter-spacing: 0.5px; }
.weather-detail-val { font-size: 20px; font-weight: 600; margin-top: 4px; }
.weather-detail-sub { font-size: 11px; opacity: 0.75; }

/* =============================================
   TETRIS GAME
   ============================================= */
.tetris-wrap {
  display: flex;
  height: 100%;
  background: #0a0a0f;
  color: #e0e0f0;
  font-family: 'SF Mono', 'Menlo', monospace;
}
.tetris-board-wrap {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  flex: 1;
  gap: 14px;
  padding: 16px;
}
.tetris-canvas {
  border: 2px solid rgba(100,100,200,0.4);
  border-radius: 4px;
  box-shadow: 0 0 30px rgba(80,80,200,0.2), inset 0 0 20px rgba(0,0,20,0.5);
  display: block;
}
.tetris-side {
  width: 160px;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 16px;
  border-left: 1px solid rgba(100,100,200,0.2);
}
.tetris-stat { background: rgba(255,255,255,0.04); border: 1px solid rgba(100,100,200,0.2); border-radius: 10px; padding: 10px 14px; }
.tetris-stat-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: #8888aa; margin-bottom: 4px; }
.tetris-stat-val { font-size: 22px; font-weight: 700; color: #c8c8ff; }
.tetris-next-canvas { display: block; border: 1px solid rgba(100,100,200,0.2); border-radius: 8px; }
.tetris-controls { font-size: 11px; color: #6666aa; line-height: 2; }
.tetris-overlay {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.75);
  backdrop-filter: blur(8px);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 16px;
  border-radius: 4px;
}
.tetris-overlay-title {
  font-size: 28px;
  font-weight: 700;
  color: #c8c8ff;
  text-shadow: 0 0 20px rgba(100,100,255,0.5);
}

/* =============================================
   STOCKS APP
   ============================================= */
.stocks-wrap { display: flex; flex-direction: column; height: 100%; }
.stocks-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
.stocks-date { font-size: 20px; font-weight: 700; color: var(--text); }
.stocks-list { flex: 1; overflow-y: auto; }
.stock-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 20px;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  transition: background 0.1s;
}
.stock-row:hover { background: rgba(0,0,0,0.04); }
body.dark .stock-row:hover { background: rgba(255,255,255,0.04); }
.stock-ticker { font-size: 16px; font-weight: 700; color: var(--text); }
.stock-company { font-size: 12px; color: var(--text-sec); }
.stock-price { font-size: 16px; font-weight: 600; color: var(--text); }
.stock-change { font-size: 13px; font-weight: 600; padding: 3px 8px; border-radius: 6px; }
.stock-change.up { background: #30d158; color: #fff; }
.stock-change.down { background: #ff3b30; color: #fff; }
.stock-sparkline { width: 60px; height: 30px; }
.stock-detail {
  padding: 20px;
  display: none;
}
.stock-detail.visible { display: block; }
.stock-chart-canvas { width: 100%; height: 180px; display: block; }

/* =============================================
   FINDER APP
   ============================================= */
.finder-wrap { display: flex; height: 100%; }
.finder-sidebar {
  width: 176px;
  background: rgba(0,0,0,0.04);
  border-right: 1px solid var(--border);
  padding: 10px 0;
  overflow-y: auto;
  flex-shrink: 0;
}
body.dark .finder-sidebar { background: rgba(255,255,255,0.03); }

.finder-sec-title {
  font-size: 11px; font-weight: 700;
  color: var(--text-sec);
  text-transform: uppercase;
  letter-spacing: 0.6px;
  padding: 8px 16px 4px;
}

.finder-loc {
  display: flex; align-items: center; gap: 8px;
  padding: 5px 14px;
  font-size: 13px;
  color: var(--text);
  cursor: pointer;
  border-radius: 7px;
  margin: 1px 4px;
  transition: background 0.12s;
}
.finder-loc:hover { background: rgba(0,0,0,0.06); }
.finder-loc.active { background: var(--accent); color: #fff; }
body.dark .finder-loc:hover { background: rgba(255,255,255,0.07); }
.finder-loc-icon { font-size: 14px; flex-shrink: 0; }

.finder-main-area { flex: 1; display: flex; flex-direction: column; min-width: 0; }

.finder-toolbar {
  display: flex; align-items: center; gap: 8px;
  padding: 8px 12px;
  border-bottom: 1px solid var(--border);
  background: rgba(0,0,0,0.02);
  flex-shrink: 0;
}
body.dark .finder-toolbar { background: rgba(255,255,255,0.02); }
.finder-path {
  font-size: 12px;
  color: var(--text-sec);
  flex: 1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.finder-files-grid {
  display: flex; flex-wrap: wrap;
  gap: 8px; padding: 14px;
  align-content: flex-start;
  overflow-y: auto;
  flex: 1;
}

.f-file {
  width: 76px;
  display: flex; flex-direction: column;
  align-items: center; gap: 4px;
  padding: 8px 4px;
  border-radius: 10px;
  cursor: pointer;
  transition: background 0.12s;
}
.f-file:hover { background: rgba(0,0,0,0.06); }
.f-file.selected { background: rgba(0,112,227,0.15); outline: 1.5px solid var(--accent); }
body.dark .f-file:hover { background: rgba(255,255,255,0.07); }
.f-file-icon { font-size: 38px; line-height: 1; }
.f-file-name {
  font-size: 10.5px;
  color: var(--text);
  text-align: center;
  word-break: break-all;
  max-width: 72px;
  line-height: 1.2;
}

.finder-empty {
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  height: 200px; color: var(--text-sec);
  font-size: 14px; gap: 8px;
}

/* =============================================
   CALCULATOR APP
   ============================================= */
.calc-wrap { display: flex; flex-direction: column; height: 100%; }

.calc-display {
  padding: 16px 20px 10px;
  text-align: right;
  flex-shrink: 0;
}
.calc-expr { font-size: 13px; color: var(--text-sec); min-height: 18px; word-break: break-all; }
.calc-num {
  font-size: 46px; font-weight: 300;
  color: var(--text);
  word-break: break-all;
  line-height: 1.1;
}

.calc-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  flex: 1;
  gap: 1px;
  background: rgba(0,0,0,0.08);
}
body.dark .calc-grid { background: rgba(0,0,0,0.35); }

.calc-btn {
  display: flex; align-items: center; justify-content: center;
  font-size: 20px;
  font-family: inherit;
  font-weight: 400;
  cursor: pointer;
  border: none;
  outline: none;
  background: rgba(255,255,255,0.75);
  color: var(--text);
  transition: filter 0.1s;
  user-select: none;
}
body.dark .calc-btn { background: rgba(55,55,58,0.85); }
.calc-btn:active { filter: brightness(0.78); }
.calc-btn:hover { filter: brightness(0.92); }
.calc-top { background: rgba(168,168,173,0.45); font-size: 18px; }
body.dark .calc-top { background: rgba(90,90,95,0.6); color: var(--text); }
.calc-op { background: #ff9500; color: #fff; }
.calc-op:hover { filter: brightness(1.1); }
.calc-op.active { background: #fff; color: #ff9500; }
.calc-span2 { grid-column: span 2; justify-content: flex-start; padding-left: 28px; }

/* =============================================
   SAFARI APP
   ============================================= */
.safari-wrap { display: flex; flex-direction: column; height: 100%; }
.safari-toolbar {
  display: flex; align-items: center;
  gap: 8px; padding: 8px 12px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.safari-nav-btn {
  background: none; border: none;
  color: var(--text-sec); font-size: 18px;
  cursor: pointer; padding: 2px 6px;
  border-radius: 5px;
}
.safari-nav-btn:hover { background: rgba(0,0,0,0.07); color: var(--text); }
.safari-url {
  flex: 1; padding: 5px 14px;
  border-radius: 9px;
  border: 1px solid var(--border);
  background: rgba(0,0,0,0.05);
  color: var(--text);
  font-size: 13px;
  text-align: center;
  outline: none;
  font-family: inherit;
  transition: border-color 0.15s;
}
.safari-url:focus { border-color: var(--accent); background: rgba(255,255,255,0.9); }
body.dark .safari-url { background: rgba(255,255,255,0.07); }
body.dark .safari-url:focus { background: rgba(255,255,255,0.12); }
.safari-body { flex: 1; position: relative; overflow: hidden; }
.safari-iframe { width: 100%; height: 100%; border: none; display: block; }

.safari-new-tab {
  position: absolute; inset: 0;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 24px;
  background: var(--bg-glass);
}
.safari-fav-grid {
  display: grid;
  grid-template-columns: repeat(4, 90px);
  gap: 16px;
}
.safari-fav {
  display: flex; flex-direction: column;
  align-items: center; gap: 6px;
  cursor: pointer;
  padding: 10px;
  border-radius: 14px;
  transition: background 0.15s;
}
.safari-fav:hover { background: rgba(0,0,0,0.06); }
.safari-fav-icon {
  width: 52px; height: 52px;
  border-radius: 13px;
  display: flex; align-items: center; justify-content: center;
  font-size: 26px;
  background: rgba(255,255,255,0.7);
  box-shadow: var(--shadow-sm);
}
body.dark .safari-fav-icon { background: rgba(255,255,255,0.1); }
.safari-fav-name { font-size: 11px; color: var(--text-sec); }

/* =============================================
   MUSIC APP
   ============================================= */
.music-wrap { display: flex; height: 100%; }
.music-sidebar {
  width: 200px;
  border-right: 1px solid var(--border);
  padding: 12px 0;
  overflow-y: auto;
  flex-shrink: 0;
  background: rgba(0,0,0,0.03);
}
body.dark .music-sidebar { background: rgba(0,0,0,0.2); }
.music-sec { font-size: 11px; font-weight: 700; color: var(--text-sec); text-transform: uppercase; letter-spacing: 0.6px; padding: 8px 16px 4px; }
.music-nav-item {
  display: flex; align-items: center; gap: 9px;
  padding: 6px 16px;
  font-size: 13px;
  color: var(--text);
  cursor: pointer;
  border-radius: 7px;
  margin: 1px 5px;
  transition: background 0.12s;
}
.music-nav-item:hover { background: rgba(0,0,0,0.05); }
.music-nav-item.active { background: rgba(255,45,85,0.12); color: #ff2d55; }
body.dark .music-nav-item:hover { background: rgba(255,255,255,0.06); }
body.dark .music-nav-item.active { background: rgba(255,45,85,0.2); }

.music-main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

.music-now-playing {
  padding: 20px;
  display: flex; flex-direction: column;
  align-items: center; gap: 12px;
  border-bottom: 1px solid var(--border);
}

.music-art {
  width: 160px; height: 160px;
  border-radius: 14px;
  display: flex; align-items: center; justify-content: center;
  font-size: 72px;
  box-shadow: 0 12px 40px rgba(0,0,0,0.3);
  flex-shrink: 0;
}
.music-track-info { text-align: center; }
.music-track-name { font-size: 16px; font-weight: 700; color: var(--text); }
.music-track-artist { font-size: 13px; color: #ff2d55; margin-top: 2px; }
.music-track-album { font-size: 12px; color: var(--text-sec); }

.music-progress-wrap {
  width: 100%;
  display: flex; align-items: center; gap: 10px;
  font-size: 11px; color: var(--text-sec);
}
.music-progress {
  flex: 1;
  -webkit-appearance: none; appearance: none;
  height: 4px;
  border-radius: 2px;
  background: rgba(0,0,0,0.12);
  outline: none;
  cursor: pointer;
}
.music-progress::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 14px; height: 14px;
  border-radius: 50%;
  background: var(--text);
  cursor: pointer;
}
body.dark .music-progress { background: rgba(255,255,255,0.12); }

.music-controls {
  display: flex; align-items: center; gap: 24px;
}
.mc-btn {
  background: none; border: none;
  cursor: pointer;
  color: var(--text-sec);
  font-size: 22px;
  padding: 6px;
  border-radius: 50%;
  transition: var(--transition);
}
.mc-btn:hover { color: var(--text); background: rgba(0,0,0,0.06); }
.mc-btn.play { font-size: 36px; color: var(--text); }
.mc-btn.active { color: #ff2d55; }

.music-volume {
  display: flex; align-items: center; gap: 8px;
  font-size: 13px; color: var(--text-sec);
  width: 100%;
}
.music-volume .range { flex: 1; }

.music-list { flex: 1; overflow-y: auto; }
.music-track-row {
  display: flex; align-items: center; gap: 12px;
  padding: 8px 16px;
  cursor: pointer;
  transition: background 0.12s;
  border-radius: 8px;
  margin: 1px 6px;
}
.music-track-row:hover { background: rgba(0,0,0,0.05); }
.music-track-row.playing { background: rgba(255,45,85,0.1); }
body.dark .music-track-row:hover { background: rgba(255,255,255,0.05); }
.mtr-num { width: 24px; text-align: center; font-size: 13px; color: var(--text-sec); flex-shrink: 0; }
.mtr-art { width: 40px; height: 40px; border-radius: 8px; display:flex; align-items:center; justify-content:center; font-size:20px; flex-shrink:0; }
.mtr-info { flex: 1; min-width: 0; }
.mtr-name { font-size: 13px; font-weight: 500; color: var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.mtr-artist { font-size: 11px; color: var(--text-sec); }
.mtr-dur { font-size: 12px; color: var(--text-sec); flex-shrink: 0; }

/* =============================================
   APPLE TV
   ============================================= */
.tv-wrap { display: flex; flex-direction: column; height: 100%; }
.tv-top-nav {
  display: flex; gap: 0;
  background: rgba(0,0,0,0.04);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
  padding: 0 16px;
}
body.dark .tv-top-nav { background: rgba(0,0,0,0.25); }
.tv-nav-item {
  padding: 10px 16px;
  font-size: 13px; font-weight: 500;
  color: var(--text-sec);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: var(--transition);
}
.tv-nav-item:hover { color: var(--text); }
.tv-nav-item.active { color: var(--accent); border-bottom-color: var(--accent); }

.tv-search-bar {
  display: flex; gap: 8px;
  padding: 10px 16px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.tv-content-area { flex: 1; overflow-y: auto; padding: 16px; }
.tv-section-title { font-size: 18px; font-weight: 700; color: var(--text); margin-bottom: 12px; }
.tv-row { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 8px; margin-bottom: 24px; }
.tv-card {
  flex-shrink: 0;
  width: 180px;
  cursor: pointer;
  border-radius: 12px;
  overflow: hidden;
  transition: transform 0.2s, box-shadow 0.2s;
}
.tv-card:hover { transform: scale(1.04); box-shadow: var(--shadow-md); }
.tv-card-thumb {
  width: 100%; height: 100px;
  display: flex; align-items: center; justify-content: center;
  font-size: 44px;
}
.tv-card-info { padding: 8px; background: rgba(0,0,0,0.04); }
body.dark .tv-card-info { background: rgba(255,255,255,0.04); }
.tv-card-title { font-size: 13px; font-weight: 600; color: var(--text); }
.tv-card-sub { font-size: 11px; color: var(--text-sec); }

.tv-player-wrap { height: 100%; display: flex; flex-direction: column; }
.tv-player-title { padding: 12px 16px; font-size: 15px; font-weight: 600; color: var(--text); }
.tv-iframe-box { flex: 1; padding: 0 16px 16px; }
.tv-iframe-box iframe { width: 100%; height: 100%; border: none; border-radius: 12px; }

/* =============================================
   VS CODE
   ============================================= */
.vsc-wrap { display: flex; height: 100%; }
.vsc-activity { width: 46px; background: rgba(0,0,0,0.08); border-right: 1px solid var(--border); display:flex; flex-direction:column; align-items:center; padding: 12px 0; gap: 20px; flex-shrink:0; }
body.dark .vsc-activity { background: rgba(0,0,0,0.3); }
.vsc-act-btn { font-size: 20px; cursor: pointer; opacity: 0.55; padding: 4px; border-radius: 6px; }
.vsc-act-btn:hover, .vsc-act-btn.active { opacity: 1; background: rgba(0,0,0,0.08); }
body.dark .vsc-act-btn:hover { background: rgba(255,255,255,0.1); }

.vsc-sidebar { width: 180px; border-right: 1px solid var(--border); background: rgba(0,0,0,0.03); flex-shrink:0; display:flex; flex-direction:column; }
body.dark .vsc-sidebar { background: rgba(0,0,0,0.2); }
.vsc-sidebar-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; color: var(--text-sec); padding: 10px 14px 6px; }
.vsc-file-item {
  display: flex; align-items: center; gap: 6px;
  padding: 5px 14px;
  font-size: 12px;
  color: var(--text);
  cursor: pointer;
  border-radius: 5px; margin: 1px 4px;
}
.vsc-file-item:hover { background: rgba(0,0,0,0.06); }
.vsc-file-item.active { background: rgba(0,112,227,0.15); color: var(--accent); }
body.dark .vsc-file-item:hover { background: rgba(255,255,255,0.06); }
body.dark .vsc-file-item.active { background: rgba(0,112,227,0.25); }

.vsc-main { flex: 1; display: flex; flex-direction: column; min-width: 0; }
.vsc-tabs { display: flex; background: rgba(0,0,0,0.04); border-bottom: 1px solid var(--border); overflow-x: auto; flex-shrink:0; }
body.dark .vsc-tabs { background: rgba(0,0,0,0.2); }
.vsc-tab { padding: 7px 18px; font-size: 12px; color: var(--text-sec); cursor: pointer; white-space: nowrap; border-right: 1px solid var(--border); display: flex; align-items: center; gap: 6px; }
.vsc-tab.active { background: rgba(255,255,255,0.5); color: var(--text); }
body.dark .vsc-tab.active { background: rgba(255,255,255,0.08); }
.vsc-tab-close { font-size: 11px; opacity: 0.5; }
.vsc-tab-close:hover { opacity: 1; }

.vsc-run-bar { display: flex; align-items: center; gap: 8px; padding: 6px 12px; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.02); flex-shrink:0; }
body.dark .vsc-run-bar { background: rgba(0,0,0,0.15); }
.vsc-lang-sel { padding: 3px 10px; border-radius: 5px; border: 1px solid var(--border); background: rgba(0,0,0,0.05); font-size: 12px; color: var(--text); cursor: pointer; font-family: inherit; }
body.dark .vsc-lang-sel { background: rgba(255,255,255,0.07); }
.vsc-run-btn { padding: 3px 14px; border-radius: 5px; background: #28c840; color: #fff; border: none; font-size: 12px; cursor: pointer; font-weight: 600; font-family: inherit; display: flex; align-items: center; gap: 5px; }
.vsc-run-btn:hover { background: #25b33a; }
.vsc-save-btn { padding: 3px 12px; border-radius: 5px; background: var(--accent); color: #fff; border: none; font-size: 12px; cursor: pointer; font-family: inherit; }

.vsc-editor-wrap { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
.vsc-editor {
  flex: 1;
  font-family: 'SF Mono', 'Fira Code', 'Courier New', monospace;
  font-size: 13px;
  line-height: 1.6;
  padding: 14px;
  border: none;
  outline: none;
  background: transparent;
  color: var(--text);
  resize: none;
  tab-size: 2;
  white-space: pre;
  overflow: auto;
}

.vsc-output {
  height: 140px;
  border-top: 2px solid var(--border);
  background: rgba(0,0,0,0.06);
  padding: 10px 14px;
  font-family: 'SF Mono', monospace;
  font-size: 12px;
  color: #4ade80;
  overflow-y: auto;
  flex-shrink: 0;
}
body.dark .vsc-output { background: rgba(0,0,0,0.5); }
.vsc-out-line { margin-bottom: 2px; }
.vsc-out-error { color: #f87171; }
.vsc-out-prompt { color: rgba(128,200,128,0.6); }

.vsc-status { display: flex; align-items: center; gap: 12px; padding: 3px 12px; background: var(--accent); color: #fff; font-size: 11px; flex-shrink:0; }

/* =============================================
   WORD APP
   ============================================= */
.word-wrap { display: flex; flex-direction: column; height: 100%; }
.word-toolbar {
  display: flex; align-items: center;
  flex-wrap: wrap;
  gap: 4px; padding: 6px 12px;
  border-bottom: 1px solid var(--border);
  background: rgba(0,0,0,0.02);
  flex-shrink: 0;
}
body.dark .word-toolbar { background: rgba(255,255,255,0.02); }
.wt-group { display: flex; gap: 2px; align-items: center; padding-right: 8px; border-right: 1px solid var(--border); margin-right: 4px; }
.wt-group:last-child { border-right: none; }
.wt-btn {
  width: 28px; height: 26px;
  display: flex; align-items: center; justify-content: center;
  border-radius: 5px; cursor: pointer;
  font-size: 13px; font-weight: 600;
  color: var(--text);
  transition: background 0.12s;
  border: none; background: none;
  font-family: inherit;
}
.wt-btn:hover { background: rgba(0,0,0,0.08); }
.wt-btn.active { background: rgba(0,112,227,0.15); color: var(--accent); }
body.dark .wt-btn:hover { background: rgba(255,255,255,0.1); }
.wt-sel { padding: 3px 6px; border-radius: 5px; border: 1px solid var(--border); font-size: 12px; background: rgba(0,0,0,0.04); color: var(--text); cursor: pointer; font-family: inherit; }
body.dark .wt-sel { background: rgba(255,255,255,0.06); }

.word-canvas-wrap {
  flex: 1;
  overflow-y: auto;
  padding: 30px;
  background: rgba(0,0,0,0.04);
}
body.dark .word-canvas-wrap { background: rgba(0,0,0,0.2); }
.word-page {
  background: #fff;
  max-width: 660px;
  min-height: 900px;
  margin: 0 auto;
  padding: 72px 80px;
  border-radius: 2px;
  box-shadow: 0 2px 24px rgba(0,0,0,0.12);
}
body.dark .word-page { background: #2a2a2e; }
.word-editor {
  min-height: 756px;
  outline: none;
  font-size: 14px;
  line-height: 1.7;
  color: #1d1d1f;
}
body.dark .word-editor { color: #f5f5f7; }
.word-editor:empty::before {
  content: 'Začněte psát...';
  color: rgba(128,128,128,0.5);
}

/* =============================================
   SETTINGS APP
   ============================================= */
.settings-wrap { display: flex; height: 100%; }
.settings-sidebar {
  width: 220px;
  background: rgba(0,0,0,0.04);
  border-right: 1px solid var(--border);
  padding: 12px 8px;
  overflow-y: auto;
  flex-shrink: 0;
}
body.dark .settings-sidebar { background: rgba(255,255,255,0.03); }
.settings-nav-item {
  display: flex; align-items: center; gap: 10px;
  padding: 8px 12px;
  border-radius: 9px;
  cursor: pointer;
  font-size: 13px;
  color: var(--text);
  transition: background 0.12s;
  margin: 2px 0;
}
.settings-nav-item:hover { background: rgba(0,0,0,0.06); }
.settings-nav-item.active { background: var(--accent); color: #fff; }
body.dark .settings-nav-item:hover { background: rgba(255,255,255,0.07); }
.sni-icon { width: 28px; height: 28px; border-radius: 7px; display:flex; align-items:center; justify-content:center; font-size:15px; flex-shrink:0; }

.settings-main-area { flex: 1; overflow-y: auto; padding: 24px; }
.set-title { font-size: 20px; font-weight: 700; color: var(--text); margin-bottom: 20px; }
.set-section { margin-bottom: 20px; }
.set-section-title { font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.6px; color: var(--text-sec); margin-bottom: 8px; padding: 0 14px; }

.set-card {
  background: rgba(255,255,255,0.6);
  border: 1px solid var(--border);
  border-radius: 12px;
  overflow: hidden;
}
body.dark .set-card { background: rgba(255,255,255,0.06); }

.set-row {
  display: flex; align-items: center;
  padding: 11px 16px;
  gap: 12px;
  border-bottom: 1px solid var(--border);
}
.set-row:last-child { border-bottom: none; }
.set-row-icon { font-size: 18px; flex-shrink: 0; }
.set-row-info { flex: 1; }
.set-row-label { font-size: 13px; font-weight: 500; color: var(--text); }
.set-row-sub { font-size: 11px; color: var(--text-sec); margin-top: 1px; }
.set-row-ctrl { flex-shrink: 0; }
.set-row-val { font-size: 13px; color: var(--text-sec); }

.wallpaper-grid { display: flex; flex-wrap: wrap; gap: 10px; }
.wp-opt {
  width: 110px; height: 70px;
  border-radius: 10px;
  cursor: pointer;
  border: 3px solid transparent;
  background-size: cover;
  background-position: center;
  transition: border-color 0.15s, transform 0.15s;
  position: relative;
}
.wp-opt:hover { transform: scale(1.05); }
.wp-opt.selected { border-color: var(--accent); }
.wp-opt-label { position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); font-size: 9px; background: rgba(0,0,0,0.6); color: #fff; padding: 2px 6px; border-radius: 4px; white-space: nowrap; }

/* =============================================
   APP STORE
   ============================================= */
.appst-wrap { display: flex; flex-direction: column; height: 100%; }
.appst-header {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  background: rgba(0,0,0,0.02);
  flex-shrink: 0;
}
body.dark .appst-header { background: rgba(0,0,0,0.15); }
.appst-title { font-size: 22px; font-weight: 700; color: var(--text); margin-bottom: 8px; }
.appst-cats { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 2px; }
.appst-cat {
  padding: 5px 14px;
  border-radius: 20px;
  font-size: 13px;
  cursor: pointer;
  white-space: nowrap;
  background: rgba(0,0,0,0.06);
  color: var(--text);
  transition: var(--transition);
  font-weight: 500;
}
.appst-cat:hover { background: rgba(0,0,0,0.1); }
.appst-cat.active { background: var(--accent); color: #fff; }
body.dark .appst-cat { background: rgba(255,255,255,0.08); }
body.dark .appst-cat:hover { background: rgba(255,255,255,0.14); }

.appst-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 14px; padding: 16px;
  overflow-y: auto;
  flex: 1;
}
.app-card {
  background: rgba(255,255,255,0.5);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 14px;
  display: flex; gap: 12px;
}
body.dark .app-card { background: rgba(255,255,255,0.06); }
.app-card-ico {
  width: 60px; height: 60px;
  border-radius: 14px;
  display: flex; align-items: center; justify-content: center;
  font-size: 30px;
  flex-shrink: 0;
  box-shadow: var(--shadow-sm);
}
.app-card-body { flex: 1; min-width: 0; }
.app-card-name { font-size: 14px; font-weight: 600; color: var(--text); }
.app-card-cat { font-size: 11px; color: var(--text-sec); margin: 2px 0 4px; }
.app-card-stars { color: #ff9500; font-size: 11px; }
.app-card-desc { font-size: 11px; color: var(--text-sec); margin: 4px 0; line-height: 1.4; }
.inst-btn {
  margin-top: 6px;
  padding: 4px 16px;
  border-radius: 20px;
  background: var(--accent);
  color: #fff;
  border: none;
  font-size: 12px; font-weight: 700;
  cursor: pointer;
  font-family: inherit;
  transition: var(--transition);
}
.inst-btn:hover { background: var(--accent-hover); }
.inst-btn.installed { background: rgba(0,0,0,0.08); color: var(--accent); }
body.dark .inst-btn.installed { background: rgba(255,255,255,0.1); }
.inst-btn.installed:hover { background: rgba(255,59,48,0.12); color: #ff3b30; }

/* =============================================
   PHOTOS APP
   ============================================= */
.photos-wrap { display: flex; height: 100%; }
.photos-sidebar {
  width: 180px; border-right: 1px solid var(--border);
  padding: 12px 0; background: rgba(0,0,0,0.03); flex-shrink:0;
}
body.dark .photos-sidebar { background: rgba(0,0,0,0.15); }
.photos-nav {
  display: flex; align-items: center; gap: 8px;
  padding: 6px 14px; font-size: 13px; cursor: pointer;
  border-radius: 7px; margin: 1px 5px; color: var(--text);
}
.photos-nav:hover { background: rgba(0,0,0,0.05); }
.photos-nav.active { background: rgba(0,112,227,0.12); color: var(--accent); }
body.dark .photos-nav:hover { background: rgba(255,255,255,0.06); }

.photos-main { flex: 1; overflow-y: auto; padding: 16px; }
.photos-year { font-size: 22px; font-weight: 700; color: var(--text); margin-bottom: 12px; }
.photos-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: 4px;
}
.photo-thumb {
  aspect-ratio: 1;
  border-radius: 4px;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  font-size: 48px;
  transition: opacity 0.15s, transform 0.15s;
  overflow: hidden;
}
.photo-thumb:hover { opacity: 0.85; transform: scale(1.02); }

/* =============================================
   MAIL APP
   ============================================= */
.mail-wrap { display: flex; height: 100%; }
.mail-sidebar { width: 200px; border-right: 1px solid var(--border); padding: 12px 0; background: rgba(0,0,0,0.03); flex-shrink:0; }
body.dark .mail-sidebar { background: rgba(0,0,0,0.15); }
.mail-box { display:flex; align-items:center; gap:9px; padding: 6px 14px; font-size:13px; cursor:pointer; border-radius:7px; margin:1px 5px; color:var(--text); }
.mail-box:hover { background:rgba(0,0,0,0.05); }
.mail-box.active { background:var(--accent); color:#fff; }
.mail-cnt { margin-left:auto; font-size:11px; font-weight:700; background:var(--accent); color:#fff; border-radius:10px; padding:1px 6px; }
.mail-box.active .mail-cnt { background:rgba(255,255,255,0.3); }

.mail-list { width: 280px; border-right: 1px solid var(--border); overflow-y: auto; flex-shrink:0; }
.mail-item {
  padding: 12px 14px;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  transition: background 0.12s;
}
.mail-item:hover { background: rgba(0,0,0,0.04); }
.mail-item.selected { background: rgba(0,112,227,0.08); }
body.dark .mail-item:hover { background: rgba(255,255,255,0.04); }
.mail-sender { font-size: 13px; font-weight: 600; color: var(--text); display:flex; justify-content:space-between; }
.mail-subject { font-size: 12px; font-weight: 500; color: var(--text); margin: 2px 0; }
.mail-preview { font-size: 11px; color: var(--text-sec); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.mail-date { font-size: 11px; color: var(--text-sec); }
.mail-unread::before { content:'●'; color:var(--accent); margin-right:6px; font-size:8px; }

.mail-viewer { flex: 1; overflow-y: auto; padding: 24px; }
.mv-subject { font-size: 20px; font-weight: 700; color: var(--text); margin-bottom: 16px; }
.mv-meta { display:flex; gap:8px; align-items:center; margin-bottom:20px; padding-bottom:16px; border-bottom:1px solid var(--border); }
.mv-avatar { width:40px; height:40px; border-radius:50%; background:var(--accent); display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; font-size:16px; flex-shrink:0; }
.mv-sender-info { flex:1; }
.mv-from { font-size:13px; font-weight:600; color:var(--text); }
.mv-to { font-size:12px; color:var(--text-sec); }
.mv-body { font-size:14px; color:var(--text); line-height:1.7; }

/* =============================================
   TRASH APP
   ============================================= */
.trash-wrap { display:flex; flex-direction:column; height:100%; }
.trash-header { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid var(--border); flex-shrink:0; }
.trash-title { font-size:15px; font-weight:700; color:var(--text); }
.trash-list { flex:1; overflow-y:auto; padding:12px; }
.trash-item { display:flex; align-items:center; gap:12px; padding:10px 12px; border-radius:10px; }
.trash-item:hover { background:rgba(0,0,0,0.05); }
.ti-icon { font-size:32px; flex-shrink:0; }
.ti-info { flex:1; }
.ti-name { font-size:13px; font-weight:500; color:var(--text); }
.ti-date { font-size:11px; color:var(--text-sec); }

/* =============================================
   SNAKE GAME
   ============================================= */
.snake-wrap { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; gap:16px; padding:20px; }
#snake-canvas { border-radius:12px; box-shadow:var(--shadow-md); display:block; }
.snake-hud { display:flex; gap:32px; align-items:center; }
.snake-score-box { text-align:center; }
.snake-score-label { font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-sec); }
.snake-score-val { font-size:28px; font-weight:700; color:var(--text); }
.snake-controls { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
.snake-ctrl-hint { font-size:12px; color:var(--text-sec); text-align:center; }

/* =============================================
   MEMORY GAME
   ============================================= */
.memory-wrap { display:flex; flex-direction:column; align-items:center; height:100%; padding:20px; gap:16px; }
.memory-hud { display:flex; gap:24px; }
.memory-stat { text-align:center; }
.memory-stat-label { font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-sec); }
.memory-stat-val { font-size:22px; font-weight:700; color:var(--text); }
#memory-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:10px; }
.mem-card {
  width:80px; height:80px;
  border-radius:12px;
  cursor:pointer;
  display:flex; align-items:center; justify-content:center;
  font-size:36px;
  transition:transform 0.3s, background 0.3s;
  transform-style:preserve-3d;
  position:relative;
}
.mem-card-front, .mem-card-back {
  position:absolute; inset:0;
  border-radius:12px;
  display:flex; align-items:center; justify-content:center;
  backface-visibility:hidden;
  -webkit-backface-visibility:hidden;
}
.mem-card-front { background:var(--accent); font-size:28px; color:#fff; font-weight:700; }
.mem-card-back { background:rgba(0,0,0,0.08); transform:rotateY(180deg); font-size:36px; }
body.dark .mem-card-back { background:rgba(255,255,255,0.08); }
.mem-card.flipped { transform:rotateY(180deg); }
.mem-card.matched .mem-card-back { background:rgba(52,199,89,0.2); }

/* =============================================
   SELECTION BOX
   ============================================= */
#sel-box {
  position:fixed;
  border:1.5px solid var(--accent);
  background:rgba(var(--accent-rgb),0.12);
  pointer-events:none;
  z-index:200;
  display:none;
  border-radius:2px;
}
</style>

</head>
<body>
<div id="desktop" oncontextmenu="ctxDesktop(event)" onmousedown="selStart(event)">
  <div id="desktop-icons-layer"></div>
  <div id="windows-layer"></div>
  <div id="sel-box"></div>
</div>
<div id="menubar">
  <div class="menubar-left">
    <span class="mb-apple" id="mb-apple-btn" onclick="mbToggle('apple-dropdown',this,event)">&#63743;</span>
    <span class="mb-item" id="mb-active-app" onclick="mbToggle('app-dropdown',this,event)">Finder</span>
    <span class="mb-item" onclick="mbToggle('file-dropdown',this,event)">Soubor</span>
    <span class="mb-item" onclick="mbToggle('edit-dropdown',this,event)">Upravit</span>
    <span class="mb-item" onclick="mbToggle('view-dropdown',this,event)">Zobrazit</span>
    <span class="mb-item" onclick="mbToggle('win-dropdown',this,event)">Okno</span>
    <span class="mb-item" onclick="mbToggle('help-dropdown',this,event)">Nápověda</span>
  </div>
  <div class="menubar-right">
    <span class="mb-icon" onclick="toggleControlCenter(event)">
      <i class="fas fa-sliders" style="font-size:12px"></i>
    </span>
    <span class="mb-icon" onclick="toggleSpotlight()"><i class="fas fa-magnifying-glass" style="font-size:12px"></i></span>
    <span class="mb-icon" id="mb-wifi-icon"><i class="fas fa-wifi" style="font-size:12px"></i></span>
    <span class="mb-icon" id="mb-battery-icon"><i class="fas fa-battery-three-quarters" style="font-size:12px"></i> <span id="mb-battery-pct" style="font-size:10px">87%</span></span>
    <span class="mb-icon" onclick="mbToggle('vol-dropdown',this,event)"><i class="fas fa-volume-high" style="font-size:12px"></i></span>
    <span id="clock" class="mb-icon"></span>
    <span class="mb-icon" onclick="toggleNotifCenter()" title="Centrum oznámení">🔔</span>
  </div>
</div>

<!-- Apple Menu -->
<div class="mb-menu-dropdown" id="apple-dropdown" style="left:8px">
  <div class="mbd-item" onclick="aboutMac();mbCloseAll()">🍎 O tomto Macu</div>
  <div class="mbd-sep"></div>
  <div class="mbd-item" onclick="openApp('settings');mbCloseAll()">⚙️ Předvolby systému...<span class="mbd-shortcut">⌘,</span></div>
  <div class="mbd-item" onclick="openApp('appstore');mbCloseAll()">🛍️ App Store...</div>
  <div class="mbd-sep"></div>
  <div class="mbd-item" onclick="toggleDarkMode();mbCloseAll()">🌙 Přepnout Dark Mode<span class="mbd-shortcut">⌃⇧D</span></div>
  <div class="mbd-item" onclick="toggleSpotlight();mbCloseAll()">🔍 Spotlight<span class="mbd-shortcut">⌘Space</span></div>
  <div class="mbd-item" onclick="toggleControlCenter();mbCloseAll()">🎛️ Ovládací centrum</div>
  <div class="mbd-sep"></div>
  <div class="mbd-item" onclick="lockScreen();mbCloseAll()">🔒 Zamknout obrazovku<span class="mbd-shortcut">⌃⌘Q</span></div>
  <div class="mbd-item" onclick="restartConfirm()">🔄 Restartovat...</div>
  <div class="mbd-item" onclick="resetSystem()">⏻ Vypnout...</div>
</div>

<!-- App Menu (dynamic) -->
<div class="mb-menu-dropdown" id="app-dropdown" style="left:60px">
  <div class="mbd-item" onclick="mbCloseAll()">ℹ️ O aplikaci</div>
  <div class="mbd-sep"></div>
  <div class="mbd-item" onclick="mbCloseAll()">Skrýt<span class="mbd-shortcut">⌘H</span></div>
  <div class="mbd-item" onclick="mbCloseAll()">Skrýt ostatní<span class="mbd-shortcut">⌥⌘H</span></div>
  <div class="mbd-sep"></div>
  <div class="mbd-item" onclick="mbCloseAll()">Ukončit<span class="mbd-shortcut">⌘Q</span></div>
</div>

<!-- File Menu -->
<div class="mb-menu-dropdown" id="file-dropdown" style="left:116px">
  <div class="mbd-item" onclick="mbNewFile()">📄 Nový soubor<span class="mbd-shortcut">⌘N</span></div>
  <div class="mbd-item" onclick="mbOpenFile()">📂 Otevřít...<span class="mbd-shortcut">⌘O</span></div>
  <div class="mbd-sep"></div>
  <div class="mbd-item" onclick="mbSaveFile()">💾 Uložit<span class="mbd-shortcut">⌘S</span></div>
  <div class="mbd-item" onclick="mbCloseAll()">📤 Exportovat jako...</div>
  <div class="mbd-item" onclick="mbPrintFile()">🖨️ Tisk...<span class="mbd-shortcut">⌘P</span></div>
  <div class="mbd-sep"></div>
  <div class="mbd-item" onclick="openApp('finder');mbCloseAll()">🗂️ Otevřít Finder<span class="mbd-shortcut">⌘F</span></div>
</div>

<!-- Edit Menu -->
<div class="mb-menu-dropdown" id="edit-dropdown" style="left:160px">
  <div class="mbd-item" onclick="document.execCommand('undo');mbCloseAll()">↩ Zpět<span class="mbd-shortcut">⌘Z</span></div>
  <div class="mbd-item" onclick="document.execCommand('redo');mbCloseAll()">↪ Znovu<span class="mbd-shortcut">⌘⇧Z</span></div>
  <div class="mbd-sep"></div>
  <div class="mbd-item" onclick="document.execCommand('cut');mbCloseAll()">✂️ Vyjmout<span class="mbd-shortcut">⌘X</span></div>
  <div class="mbd-item" onclick="document.execCommand('copy');mbCloseAll()">📋 Kopírovat<span class="mbd-shortcut">⌘C</span></div>
  <div class="mbd-item" onclick="document.execCommand('paste');mbCloseAll()">📌 Vložit<span class="mbd-shortcut">⌘V</span></div>
  <div class="mbd-item" onclick="document.execCommand('selectAll');mbCloseAll()">Vybrat vše<span class="mbd-shortcut">⌘A</span></div>
  <div class="mbd-sep"></div>
  <div class="mbd-item" onclick="toggleSpotlight();mbCloseAll()">🔍 Najít...<span class="mbd-shortcut">⌘F</span></div>
</div>

<!-- View Menu -->
<div class="mb-menu-dropdown" id="view-dropdown" style="left:208px">
  <div class="mbd-item" onclick="toggleDarkMode();mbCloseAll()">🌙 Přepnout Dark/Light mode</div>
  <div class="mbd-sep"></div>
  <div class="mbd-item" onclick="mbEnterFullscreen()">⛶ Celá obrazovka<span class="mbd-shortcut">⌃⌘F</span></div>
  <div class="mbd-item" onclick="mbTileWindows()">⊞ Dlaždice oken</div>
  <div class="mbd-sep"></div>
  <div class="mbd-item" onclick="openApp('launchpad');mbCloseAll()">🚀 Launchpad</div>
  <div class="mbd-item" onclick="toggleMissionControl()">🖥️ Mission Control<span class="mbd-shortcut">⌃↑</span></div>
  <div class="mbd-sep"></div>
  <div class="mbd-item" onclick="cycleWallpaper();mbCloseAll()">🖼️ Náhodná tapeta</div>
</div>

<!-- Window Menu -->
<div class="mb-menu-dropdown" id="win-dropdown" style="left:260px">
  <div class="mbd-item" onclick="mbMinimizeFront()">− Minimalizovat<span class="mbd-shortcut">⌘M</span></div>
  <div class="mbd-item" onclick="mbZoomFront()">⊕ Maximalizovat</div>
  <div class="mbd-item" onclick="mbCloseFront()">✕ Zavřít<span class="mbd-shortcut">⌘W</span></div>
  <div class="mbd-sep"></div>
  <div id="win-dropdown-list"><div class="mbd-item disabled">Žádná okna</div></div>
</div>

<!-- Help Menu -->
<div class="mb-menu-dropdown" id="help-dropdown" style="left:304px">
  <div class="mbd-item" onclick="toggleSpotlight();mbCloseAll()">🔍 Vyhledat nápovědu<span class="mbd-shortcut">⌘?</span></div>
  <div class="mbd-sep"></div>
  <div class="mbd-item" onclick="notify('ℹ️ Nápověda','AiOS – macOS Simulace v prohlížeči. Zkuste otevřít aplikace z Docku nebo Launchpadu!');mbCloseAll()">📖 Přehled AiOS</div>
  <div class="mbd-item" onclick="notify('⌨️ Klávesové zkratky','⌘Space – Spotlight | ⌃⇧D – Dark mode | ⌘M – Minimalizovat');mbCloseAll()">⌨️ Klávesové zkratky</div>
  <div class="mbd-item" onclick="openSafari('https://claude.ai');mbCloseAll()">🤖 Claude AI</div>
</div>

<!-- Volume Dropdown -->
<div class="mb-menu-dropdown" id="vol-dropdown" style="right:8px;left:auto;min-width:200px">
  <div style="padding:12px 16px">
    <div style="font-size:12px;font-weight:600;color:var(--text-sec);margin-bottom:8px">🔊 Hlasitost</div>
    <div style="display:flex;align-items:center;gap:8px;font-size:13px;color:var(--text-sec)">
      <i class="fas fa-volume-low"></i>
      <input type="range" class="range" id="vol-slider" min="0" max="100" value="70" oninput="setVolume(this.value)" style="flex:1">
      <i class="fas fa-volume-high"></i>
    </div>
    <div id="vol-pct" style="font-size:11px;color:var(--text-sec);text-align:center;margin-top:6px">70%</div>
  </div>
  <div class="mbd-sep"></div>
  <div class="mbd-item" onclick="mbCloseAll()">🎵 Vstup: Mikrofon</div>
  <div class="mbd-item" onclick="mbCloseAll()">🔊 Výstup: Reproduktory</div>
</div>

<!-- Control Center -->
<div id="control-center">
  <div class="cc-grid">
    <div class="cc-btn on" id="cc-wifi" onclick="toggleCCWifi()">
      <div class="cc-btn-icon"><i class="fas fa-wifi"></i></div>
      <div class="cc-btn-label">Wi-Fi</div>
    </div>
    <div class="cc-btn" id="cc-bt" onclick="toggleCCBtn('cc-bt')">
      <div class="cc-btn-icon">🔵</div>
      <div class="cc-btn-label">Bluetooth</div>
    </div>
    <div class="cc-btn" id="cc-airdrop" onclick="toggleCCBtn('cc-airdrop')">
      <div class="cc-btn-icon">📡</div>
      <div class="cc-btn-label">AirDrop</div>
    </div>
    <div class="cc-btn on" id="cc-darkmode" onclick="toggleCCDarkmode()">
      <div class="cc-btn-icon">🌙</div>
      <div class="cc-btn-label">Dark Mode</div>
    </div>
  </div>
  <div class="cc-slider-row">
    <span class="cc-slider-icon">☀️</span>
    <input type="range" class="cc-slider" min="20" max="100" value="80" oninput="document.getElementById('desktop').style.filter='brightness('+this.value+'%)'">
    <span style="font-size:11px;color:var(--text-sec)">Jas</span>
  </div>
  <div class="cc-slider-row">
    <span class="cc-slider-icon">🔈</span>
    <input type="range" class="cc-slider" id="cc-vol-slider" min="0" max="100" value="70" oninput="setVolume(this.value)">
    <span style="font-size:11px;color:var(--text-sec)">Zvuk</span>
  </div>
  <div class="cc-sep"></div>
  <div style="display:flex;gap:8px;flex-wrap:wrap">
    <div class="cc-btn" onclick="openApp('music');toggleControlCenter()" style="flex:1;min-width:0">
      <div class="cc-btn-icon">🎵</div>
      <div class="cc-btn-label">Hudba</div>
    </div>
    <div class="cc-btn" onclick="toggleSpotlight();toggleControlCenter()" style="flex:1;min-width:0">
      <div class="cc-btn-icon">🔍</div>
      <div class="cc-btn-label">Spotlight</div>
    </div>
    <div class="cc-btn" onclick="cycleWallpaper();toggleControlCenter()" style="flex:1;min-width:0">
      <div class="cc-btn-icon">🖼️</div>
      <div class="cc-btn-label">Tapeta</div>
    </div>
  </div>
</div>

<!-- Notification Center -->
<div id="notif-center">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
    <div class="nc-title">Centrum oznámení</div>
    <button class="btn btn-sm" onclick="toggleNotifCenter()">✕</button>
  </div>
  <div class="nc-widget">
    <div class="nc-widget-title">⏰ Hodiny</div>
    <div id="nc-clock-big" style="font-size:42px;font-weight:100;color:var(--text);text-align:center;letter-spacing:-2px"></div>
    <div id="nc-date-label" style="text-align:center;color:var(--text-sec);font-size:13px;margin-top:4px"></div>
  </div>
  <div class="nc-widget">
    <div class="nc-widget-title">🌤️ Počasí</div>
    <div style="display:flex;align-items:center;gap:12px">
      <div style="font-size:36px">⛅</div>
      <div>
        <div style="font-size:24px;font-weight:300;color:var(--text)">18°C</div>
        <div style="font-size:12px;color:var(--text-sec)">Praha • Polojasno</div>
      </div>
    </div>
  </div>
  <div class="nc-widget">
    <div class="nc-widget-title">🎵 Nyní hraje</div>
    <div id="nc-music-info">
      <div style="font-size:13px;font-weight:600;color:var(--text)">Žádná hudba</div>
      <div style="font-size:11px;color:var(--text-sec)">Otevři Apple Music</div>
    </div>
  </div>
  <div class="nc-widget">
    <div class="nc-widget-title">📅 Dnešní datum</div>
    <div id="nc-calendar-label" style="font-size:13px;color:var(--text)"></div>
  </div>
</div>
<div id="dock-wrap"><div id="dock"></div></div>
<div id="dock-ctx"></div>
<div id="ctx-menu"></div>
<div id="notif-container"></div>
<div id="spotlight-wrap" onclick="closeSpotlightIfOutside(event)">
  <div id="spotlight-box">
    <div id="spotlight-input-wrap">
      <i class="fas fa-magnifying-glass" id="spotlight-icon"></i>
      <input id="spotlight-input" placeholder="Spotlight – hledání" oninput="spotlightSearch(this.value)" onkeydown="spotlightKeydown(event)" autocomplete="off">
    </div>
    <div id="spotlight-results"></div>
  </div>
</div>
<div id="launchpad" onclick="closeLaunchpadIfOutside(event)">
  <div id="lp-search-wrap">
    <input id="lp-search" type="text" placeholder="Hledat" oninput="filterLaunchpad(this.value)" autocomplete="off">
  </div>
  <div id="lp-grid"></div>
</div>
<script>
'use strict';
// ================================================================
//   STATE
// ================================================================
const S = (() => {
  const defaults = {
    fs:{},installedApps:['finder','safari','calculator','music','tv','photos','settings','appstore','mail','trash','launchpad'],
    dockPinned:['finder','launchpad','safari','music','tv','notes','maps','weather','clock','settings','appstore','calculator'],
    darkMode:false,dockSize:56,wallpaper:'sonoma',trash:[],desktopIcons:[],nextIconId:1,volume:70,
    musicCurrentIdx:0,musicPlaying:false,currentMusicProgress:0,
    notes:[{id:1,title:'Vítejte v Poznámkách!',content:'Toto je vaše první poznámka.\nMůžete psát cokoliv chcete.',date:'Dnes'}],
    notesCurrentId:1,
  };
  try{const s=JSON.parse(localStorage.getItem('macos24_v4')||'{}');return Object.assign({},defaults,s);}
  catch(e){return Object.assign({},defaults);}
})();
function saveState(){try{localStorage.setItem('macos24_v4',JSON.stringify(S));}catch(e){}}

// ================================================================
//   APP REGISTRY
// ================================================================
const APPS={
  finder:    {name:'Finder',     icon:'🗂️',bg:'linear-gradient(145deg,#5da0e0,#2a7cd6)'},
  launchpad: {name:'Launchpad',  icon:'🚀',bg:'linear-gradient(145deg,#e45b9e,#a02070)'},
  safari:    {name:'Safari',     icon:'🧭',bg:'linear-gradient(145deg,#5bd15b,#2a9a2a)'},
  mail:      {name:'Mail',       icon:'✉️',bg:'linear-gradient(145deg,#5da0e0,#1a60b0)'},
  music:     {name:'Hudba',      icon:'🎵',bg:'linear-gradient(145deg,#fc6c7c,#d42040)'},
  tv:        {name:'Apple TV',   icon:'📺',bg:'linear-gradient(145deg,#2a2a2a,#000)'},
  photos:    {name:'Fotky',      icon:'🖼️',bg:'linear-gradient(135deg,#f6e05e,#ed8936,#fc8181,#9f7aea)'},
  settings:  {name:'Nastavení',  icon:'⚙️',bg:'linear-gradient(145deg,#9fa8ba,#6b7a8d)'},
  appstore:  {name:'App Store',  icon:'🛍️',bg:'linear-gradient(145deg,#5da0e0,#0a5bc4)'},
  vscode:    {name:'VS Code',    icon:'💻',bg:'linear-gradient(145deg,#5da0e0,#1a4080)'},
  word:      {name:'Word',       icon:'📝',bg:'linear-gradient(145deg,#2b6cb0,#1a3f70)'},
  calculator:{name:'Kalkulačka', icon:'🔢',bg:'linear-gradient(145deg,#fc8181,#c02020)'},
  snake:     {name:'Snake',      icon:'🐍',bg:'linear-gradient(145deg,#43e97b,#1a9040)'},
  memory:    {name:'Paměť',      icon:'🧠',bg:'linear-gradient(145deg,#667eea,#5040c0)'},
  tetris:    {name:'Tetris',     icon:'🎮',bg:'linear-gradient(145deg,#12c2e9,#c471ed,#f64f59)'},
  terminal:  {name:'Terminál',   icon:'⌨️',bg:'linear-gradient(145deg,#1a1b1e,#2d2e32)'},
  notes:     {name:'Poznámky',   icon:'📒',bg:'linear-gradient(145deg,#ffd60a,#e6a800)'},
  maps:      {name:'Mapy',       icon:'🗺️',bg:'linear-gradient(145deg,#43e97b,#1a6640)'},
  clock:     {name:'Hodiny',     icon:'🕐',bg:'linear-gradient(145deg,#1a1a1a,#4a4a4a)'},
  weather:   {name:'Počasí',     icon:'🌤️',bg:'linear-gradient(145deg,#4facfe,#00f2fe)'},
  stocks:    {name:'Akcie',      icon:'📈',bg:'linear-gradient(145deg,#43e97b,#2c7a3c)'},
  trash:     {name:'Koš',        icon:'🗑️',bg:'linear-gradient(145deg,#9fa8ba,#4a5468)'},
};
const STORE_APPS=[
  {id:'vscode',name:'Visual Studio Code',cat:'Vývojáři',stars:4.9,desc:'Výkonný editor kódu od Microsoftu.',bg:'linear-gradient(145deg,#5da0e0,#1a4080)'},
  {id:'word',name:'Microsoft Word',cat:'Kancelář',stars:4.6,desc:'Profesionální textový editor.',bg:'linear-gradient(145deg,#2b6cb0,#1a3f70)'},
  {id:'snake',name:'Snake Game',cat:'Hry',stars:4.5,desc:'Klasická hra had. Sněz jablka!',bg:'linear-gradient(145deg,#43e97b,#1a9040)'},
  {id:'memory',name:'Memory Game',cat:'Hry',stars:4.3,desc:'Otáčej kartičky a hledej páry.',bg:'linear-gradient(145deg,#667eea,#5040c0)'},
  {id:'tetris',name:'Tetris',cat:'Hry',stars:4.8,desc:'Slavná puzzle hra. Skládej bloky!',bg:'linear-gradient(145deg,#12c2e9,#c471ed,#f64f59)'},
  {id:'photos',name:'Fotky',cat:'Grafika',stars:4.7,desc:'Organizuj a sdílej fotografie.',bg:'linear-gradient(135deg,#f6e05e,#9f7aea)'},
  {id:'mail',name:'Mail',cat:'Komunikace',stars:4.4,desc:'Elegantní emailový klient.',bg:'linear-gradient(145deg,#5da0e0,#1a60b0)'},
  {id:'terminal',name:'Terminál',cat:'Vývojáři',stars:4.7,desc:'Příkazový řádek pro pokročilé uživatele.',bg:'linear-gradient(145deg,#1a1b1e,#2d2e32)'},
  {id:'notes',name:'Poznámky',cat:'Produktivita',stars:4.5,desc:'Jednoduché a elegantní poznámky.',bg:'linear-gradient(145deg,#ffd60a,#e6a800)'},
  {id:'maps',name:'Mapy',cat:'Navigace',stars:4.6,desc:'Mapy a navigace Apple.',bg:'linear-gradient(145deg,#43e97b,#1a6640)'},
  {id:'weather',name:'Počasí',cat:'Lifestyle',stars:4.4,desc:'Přesná předpověď počasí.',bg:'linear-gradient(145deg,#4facfe,#00f2fe)'},
  {id:'stocks',name:'Akcie',cat:'Finance',stars:4.2,desc:'Sleduj burzu a akcie v reálném čase.',bg:'linear-gradient(145deg,#43e97b,#2c7a3c)'},
];
const WALLPAPERS={
  sonoma:{label:'Sonoma',bg:'linear-gradient(160deg,#1a6b9e 0%,#2d4f6c 30%,#1c3b55 60%,#0f2133 100%)'},
  sequoia:{label:'Sequoia',bg:'linear-gradient(160deg,#2d6a2d 0%,#1a4a1a 40%,#0f2e0f 100%)'},
  aurora:{label:'Aurora',bg:'linear-gradient(160deg,#0f0c29,#302b63,#24243e)'},
  sunset:{label:'Západ',bg:'linear-gradient(160deg,#f093fb,#f5576c,#fda085)'},
  ocean:{label:'Oceán',bg:'linear-gradient(160deg,#2980b9,#6dd5fa,rgba(255,255,255,0.08))'},
  midnight:{label:'Noc',bg:'linear-gradient(160deg,#0c0c0c,#1a1a2e,#16213e)'},
  mojave:{label:'Mojave',bg:'linear-gradient(160deg,#e85d04,#f77f00,#fcbf49,#eae2b7)'},
  catalina:{label:'Catalina',bg:'linear-gradient(160deg,#4facfe,#00f2fe)'},
  monterey:{label:'Monterey',bg:'linear-gradient(160deg,#6a11cb,#2575fc)'},
  ventura:{label:'Ventura',bg:'linear-gradient(160deg,#0c3483,#a2b6df,#6b8cce,#a2b6df)'},
  bigsur:{label:'Big Sur',bg:'linear-gradient(160deg,#f7971e,#ffd200,#ff6f61,#de4313)'},
  sierra:{label:'Sierra',bg:'linear-gradient(160deg,#314755,#26a0da)'},
  deepspace:{label:'Vesmír',bg:'radial-gradient(ellipse at center,#0d0d2b 0%,#1a0d3e 40%,#0a0a1a 100%)'},
  neon:{label:'Neon',bg:'linear-gradient(160deg,#0f0c1a,#1a0f3e,#3d1060)'},
  arctic:{label:'Arktida',bg:'linear-gradient(160deg,#a8edea,#fed6e3,#d299c2)'},
  lava:{label:'Láva',bg:'linear-gradient(160deg,#1f0000,#6b0f0f,#ff4500,#ff8c00)'},
  forest:{label:'Les',bg:'linear-gradient(160deg,#0a2e0a,#1a5c1a,#2d7a2d,#4a9a4a)'},
  rosegold:{label:'Růžové zlato',bg:'linear-gradient(160deg,#f7c5a0,#e0859d,#b56576,#6c3483)'},
  cyberpunk:{label:'Cyberpunk',bg:'linear-gradient(160deg,#0d001a,#1a0033,#0d1a33),radial-gradient(circle at 70% 30%,rgba(255,0,200,0.15),transparent 50%)'},
  dawn:{label:'Úsvit',bg:'linear-gradient(160deg,#1a0040,#5c0080,#ff4040,#ff8040,#ffcc00)'},
};
const MUSIC_LIBRARY=[
  {title:'Bohemian Rhapsody',artist:'Queen',album:'A Night at the Opera',dur:'5:55',emoji:'🎸',bg:'linear-gradient(135deg,#4a00e0,#8e2de2)'},
  {title:'Hotel California',artist:'Eagles',album:'Hotel California',dur:'6:30',emoji:'🌅',bg:'linear-gradient(135deg,#f6d365,#fda085)'},
  {title:'Imagine',artist:'John Lennon',album:'Imagine',dur:'3:07',emoji:'🕊️',bg:'linear-gradient(135deg,#43e97b,#38f9d7)'},
  {title:'Smells Like Teen Spirit',artist:'Nirvana',album:'Nevermind',dur:'5:01',emoji:'🤘',bg:'linear-gradient(135deg,#232526,#414345)'},
  {title:'Billie Jean',artist:'Michael Jackson',album:'Thriller',dur:'4:54',emoji:'🕺',bg:'linear-gradient(135deg,#ec008c,#fc6767)'},
  {title:'Like a Rolling Stone',artist:'Bob Dylan',album:'Highway 61 Revisited',dur:'6:13',emoji:'🪨',bg:'linear-gradient(135deg,#bdc3c7,#2c3e50)'},
  {title:'Purple Haze',artist:'Jimi Hendrix',album:'Are You Experienced',dur:'2:51',emoji:'💜',bg:'linear-gradient(135deg,#a18cd1,#fbc2eb)'},
  {title:'Blinding Lights',artist:'The Weeknd',album:'After Hours',dur:'3:20',emoji:'🌃',bg:'linear-gradient(135deg,#f953c6,#b91d73)'},
  {title:'Levitating',artist:'Dua Lipa',album:'Future Nostalgia',dur:'3:23',emoji:'✨',bg:'linear-gradient(135deg,#12c2e9,#c471ed,#f64f59)'},
  {title:'Shape of You',artist:'Ed Sheeran',album:'÷ (Divide)',dur:'3:53',emoji:'❤️',bg:'linear-gradient(135deg,#ff9a9e,#fecfef)'},
  {title:'Starboy',artist:'The Weeknd',album:'Starboy',dur:'3:50',emoji:'⭐',bg:'linear-gradient(135deg,#1a1a2e,#16213e,#0f3460)'},
  {title:'Bad Guy',artist:'Billie Eilish',album:'WHEN WE ALL FALL ASLEEP',dur:'3:14',emoji:'😈',bg:'linear-gradient(135deg,#00b09b,#96c93d)'},
  {title:'Watermelon Sugar',artist:'Harry Styles',album:'Fine Line',dur:'2:54',emoji:'🍉',bg:'linear-gradient(135deg,#f7971e,#ffd200)'},
  {title:'Stay With Me',artist:'Sam Smith',album:'In the Lonely Hour',dur:'2:52',emoji:'🎤',bg:'linear-gradient(135deg,#f093fb,#f5576c)'},
  {title:'Numb',artist:'Linkin Park',album:'Meteora',dur:'3:05',emoji:'🎙️',bg:'linear-gradient(135deg,#232526,#414345)'},
];
const TV_CONTENT={
  featured:[
    {title:'Planet Earth III',emoji:'🌍',genre:'Dokumentární',id:'dQw4w9WgXcQ',sub:'BBC • 2023'},
    {title:'Cosmic Safari',emoji:'🌌',genre:'Věda',id:'9D05ej8u-gU',sub:'NASA • 2024'},
    {title:'Deep Ocean',emoji:'🐋',genre:'Příroda',id:'1La4QzGeaaQ',sub:'Netflix • 2023'},
    {title:'Formula One: Drive',emoji:'🏎️',genre:'Sport',id:'S3vkPlpFH7I',sub:'F1 • 2024'},
  ],
  originals:[
    {title:'Ted Lasso',emoji:'⚽',genre:'Komedie',id:'3u7EIiohs6U',sub:'Apple TV+ • S3'},
    {title:'Severance',emoji:'🏢',genre:'Thriller',id:'xEQP4VVuyrY',sub:'Apple TV+ • S2'},
    {title:'The Morning Show',emoji:'📺',genre:'Drama',id:'qAFZfIb92sw',sub:'Apple TV+ • S3'},
    {title:'Silo',emoji:'🏗️',genre:'Sci-Fi',id:'8ZKh3845Zss',sub:'Apple TV+ • S2'},
  ],
  trending:[
    {title:'Oppenheimer',emoji:'💥',genre:'Historie',id:'uYPbbksJxIg',sub:'Universal • 2023'},
    {title:'Dune Part Two',emoji:'🏜️',genre:'Sci-Fi',id:'Way9Dexny3w',sub:'Warner • 2024'},
    {title:'Interstellar',emoji:'🚀',genre:'Sci-Fi',id:'zSWdZVtXT7E',sub:'Paramount • 2014'},
    {title:'Avatar 2',emoji:'💧',genre:'Fantasy',id:'a8Gx8wiNbs8',sub:'Disney • 2022'},
  ],
};
const PHOTO_ITEMS=[
  {emoji:'🌅',bg:'linear-gradient(135deg,#f6d365,#fda085)',name:'Západ slunce'},
  {emoji:'🏔️',bg:'linear-gradient(135deg,#4facfe,#00f2fe)',name:'Horská krajina'},
  {emoji:'🌊',bg:'linear-gradient(135deg,#2980b9,#6dd5fa)',name:'Oceánské vlny'},
  {emoji:'🌸',bg:'linear-gradient(135deg,#f093fb,#f5576c)',name:'Třešňový květ'},
  {emoji:'🦁',bg:'linear-gradient(135deg,#f7971e,#ffd200)',name:'Lev savana'},
  {emoji:'🌌',bg:'linear-gradient(135deg,#1a1a2e,#16213e)',name:'Mléčná dráha'},
  {emoji:'🏙️',bg:'linear-gradient(135deg,#232526,#414345)',name:'Noční město'},
  {emoji:'🌿',bg:'linear-gradient(135deg,#43e97b,#38f9d7)',name:'Zelený les'},
  {emoji:'🦋',bg:'linear-gradient(135deg,#a18cd1,#fbc2eb)',name:'Motýl'},
  {emoji:'🌺',bg:'linear-gradient(135deg,#fc466b,#3f5efb)',name:'Červené květy'},
  {emoji:'🐧',bg:'linear-gradient(135deg,#0c0c0c,#4a4a8a)',name:'Tučňáci'},
  {emoji:'🌈',bg:'linear-gradient(135deg,#f093fb,#43e97b)',name:'Duha'},
];
const MAIL_MESSAGES=[
  {from:'Tim Cook',email:'tim@apple.com',subject:'Re: macOS Update',preview:'Skvělá práce celého týmu!',body:'Ahoj,\n\nmacOS Sonoma simulace je úžasná práce. Gratuluju celému týmu k vydání!\n\nS pozdravem,\nTim',date:'Dnes 9:15',unread:true},
  {from:'Jony Ive',email:'jony@apple.com',subject:'Designový brief Q1',preview:'Posílám nové návrhy pro nadcházející projekt...',body:'Dobrý den,\n\nPosílám vám nové designové návrhy pro nadcházející projekt. Zaměřili jsme se na čistotu linek a minimalistický přístup.\n\nS pozdravem,\nJony',date:'Včera 18:42',unread:true},
  {from:'Craig Federighi',email:'craig@apple.com',subject:'Bug report - Safari',preview:'Našli jsme kritický bug v Safari...',body:'Zdravím,\n\nNašli jsme kritický bug v Safari renderu. Potřebujeme to opravit před vydáním.\n\nCraig',date:'Pon 11:30',unread:false},
  {from:'Phil Schiller',email:'phil@apple.com',subject:'Marketing kampaň',preview:'Přikládám plán pro letní marketingovou kampaň...',body:'Dobrý den,\n\nPřikládám kompletní plán pro letní marketingovou kampaň. Prosím zkontrolujte a dejte feedback.\n\nPhil',date:'Pon 8:00',unread:false},
  {from:'Lisa Jackson',email:'lisa@apple.com',subject:'Udržitelnost 2024',preview:'Zpráva o pokroku v oblasti ekologie...',body:'Ahoj týme,\n\nPřikládám roční zprávu o našem pokroku v oblasti udržitelnosti. Letos jsme dosáhli 100% obnovitelné energie.\n\nLisa',date:'Ne 14:22',unread:true},
];
const SAFARI_FAVS=[
  {name:'Google',icon:'🌐',url:'https://google.com'},
  {name:'YouTube',icon:'▶️',url:'https://www.youtube.com'},
  {name:'Wikipedia',icon:'📚',url:'https://cs.wikipedia.org'},
  {name:'GitHub',icon:'🐙',url:'https://github.com'},
  {name:'MDN',icon:'🦊',url:'https://developer.mozilla.org'},
  {name:'Maps',icon:'🗺️',url:'https://maps.google.com'},
  {name:'News',icon:'📰',url:'https://news.google.com'},
  {name:'AI Chat',icon:'🤖',url:'https://claude.ai'},
];

// ================================================================
//   WINDOW MANAGER
// ================================================================
let WID=0;const WINS={};let Z=1000;
function createWindow(appId,title,w,h,buildContent){
  for(const[wid,win]of Object.entries(WINS)){
    if(win.appId===appId&&win.minimized){restoreWindow(wid);return win.el;}
  }
  const multi=['finder','word','vscode','photos'];
  if(!multi.includes(appId)){
    for(const[wid,win]of Object.entries(WINS)){
      if(win.appId===appId&&!win.minimized){focusWindow(wid);return win.el;}
    }
  }
  WID++;const wid='w'+WID;
  const el=document.createElement('div');
  el.className='window anim-open';
  el.dataset.wid=wid;el.dataset.app=appId;
  el.style.cssText=`width:${w}px;height:${h}px;left:${80+Math.random()*180}px;top:${46+Math.random()*80}px;z-index:${++Z}`;
  el.innerHTML=`
    <div class="win-bar" onmousedown="winDragStart(event,'${wid}')">
      <div class="tl-wrap">
        <div class="tl tl-red" onclick="closeWindow('${wid}')">✕</div>
        <div class="tl tl-yel" onclick="minimizeWindow('${wid}')">−</div>
        <div class="tl tl-grn" onclick="toggleMaxWin('${wid}')">+</div>
      </div>
      <div class="win-title">${title}</div>
    </div>
    <div class="win-body" id="wb-${wid}"></div>
    <div class="win-resize" onmousedown="winResizeStart(event,'${wid}')"></div>`;
  document.getElementById('windows-layer').appendChild(el);
  setTimeout(()=>el.classList.remove('anim-open'),300);
  WINS[wid]={el,appId,minimized:false,title};
  el.addEventListener('mousedown',()=>focusWindow(wid));
  const body=document.getElementById('wb-'+wid);
  if(typeof buildContent==='function')buildContent(body,wid);
  else body.innerHTML=buildContent;
  showDockDot(appId,true);
  updateMenubarApp(appId);
  focusWindow(wid);
  return el;
}
function focusWindow(wid){
  const win=WINS[wid];if(!win)return;
  win.el.style.zIndex=++Z;
  updateMenubarApp(win.appId);
}
function closeWindow(wid){
  const win=WINS[wid];if(!win)return;
  win.el.classList.add('anim-close');
  const appId=win.appId;
  setTimeout(()=>{
    win.el.remove();delete WINS[wid];
    if(!Object.values(WINS).some(w=>w.appId===appId))showDockDot(appId,false);
  },200);
}
function minimizeWindow(wid){
  const win=WINS[wid];if(!win||win.minimized)return;
  const dockEl=document.getElementById('di-'+win.appId);
  let tx=0;
  if(dockEl){const dr=dockEl.getBoundingClientRect(),wr=win.el.getBoundingClientRect();tx=(dr.left+dr.width/2)-(wr.left+wr.width/2);}
  win.el.style.setProperty('--min-tx',tx+'px');
  win.el.classList.add('anim-minimize');
  setTimeout(()=>{win.el.style.display='none';win.el.classList.remove('anim-minimize');win.minimized=true;},400);
  dockBounce(win.appId);
}
function restoreWindow(wid){
  const win=WINS[wid];if(!win)return;
  win.el.style.display='';
  win.el.classList.add('anim-open');
  setTimeout(()=>win.el.classList.remove('anim-open'),300);
  win.minimized=false;
  focusWindow(wid);
}
function toggleMaxWin(wid){
  const win=WINS[wid];if(!win)return;
  const el=win.el;
  if(el.dataset.maxed==='1'){
    const r=JSON.parse(el.dataset.origR||'{}');
    el.style.left=r.l;el.style.top=r.t;el.style.width=r.w;el.style.height=r.h;
    el.dataset.maxed='0';
  }else{
    el.dataset.origR=JSON.stringify({l:el.style.left,t:el.style.top,w:el.style.width,h:el.style.height});
    el.style.left='0';el.style.top='28px';el.style.width='100vw';el.style.height='calc(100vh - 28px - 90px)';
    el.dataset.maxed='1';
  }
}
let _drag=null;
function winDragStart(e,wid){
  if(e.target.classList.contains('tl'))return;
  e.preventDefault();
  focusWindow(wid);
  const win=WINS[wid];
  _drag={wid,ox:e.clientX-parseInt(win.el.style.left||0),oy:e.clientY-parseInt(win.el.style.top||0)};
  document.addEventListener('mousemove',winDragMove,{passive:true});
  document.addEventListener('mouseup',winDragEnd);
}
function winDragMove(e){
  if(!_drag)return;
  const win=WINS[_drag.wid];
  win.el.style.left=(e.clientX-_drag.ox)+'px';
  win.el.style.top=Math.max(28,e.clientY-_drag.oy)+'px';
}
function winDragEnd(){_drag=null;document.removeEventListener('mousemove',winDragMove);document.removeEventListener('mouseup',winDragEnd);}
let _rsz=null;
function winResizeStart(e,wid){
  e.preventDefault();e.stopPropagation();
  _rsz={wid,ox:e.clientX,oy:e.clientY,ow:WINS[wid].el.offsetWidth,oh:WINS[wid].el.offsetHeight};
  document.addEventListener('mousemove',winResizeMove,{passive:true});
  document.addEventListener('mouseup',winResizeEnd);
}
function winResizeMove(e){
  if(!_rsz)return;
  const win=WINS[_rsz.wid];
  win.el.style.width=Math.max(320,_rsz.ow+e.clientX-_rsz.ox)+'px';
  win.el.style.height=Math.max(200,_rsz.oh+e.clientY-_rsz.oy)+'px';
}
function winResizeEnd(){_rsz=null;document.removeEventListener('mousemove',winResizeMove);document.removeEventListener('mouseup',winResizeEnd);}
function updateMenubarApp(appId){const a=APPS[appId];document.getElementById('mb-active-app').textContent=a?a.name:'Finder';}

// ================================================================
//   DOCK
// ================================================================
function buildDock(){
  const dock=document.getElementById('dock');dock.innerHTML='';
  const pinned=S.dockPinned.filter(id=>S.installedApps.includes(id)||['finder','launchpad'].includes(id));
  pinned.forEach(id=>dock.appendChild(makeDockItem(id)));
  const running=[...new Set(Object.values(WINS).map(w=>w.appId))].filter(id=>!pinned.includes(id)&&id!=='trash');
  if(running.length){dock.appendChild(makeSep());running.forEach(id=>dock.appendChild(makeDockItem(id)));}
  dock.appendChild(makeSep());
  dock.appendChild(makeDockItem('trash'));
}
function makeDockItem(appId){
  const app=APPS[appId];if(!app)return document.createDocumentFragment();
  const wrap=document.createElement('div');
  wrap.className='d-item';wrap.id='di-'+appId;
  const hasWin=Object.values(WINS).some(w=>w.appId===appId);
  wrap.innerHTML=`<div class="d-icon" style="background:${app.bg}">${app.icon}</div><div class="d-tooltip">${app.name}</div><div class="d-dot" style="${hasWin?'':'opacity:0'}"></div>`;
  wrap.addEventListener('click',e=>{
    e.stopPropagation();
    for(const[wid,win]of Object.entries(WINS)){if(win.appId===appId&&win.minimized){restoreWindow(wid);return;}}
    for(const[wid,win]of Object.entries(WINS)){if(win.appId===appId&&!win.minimized){focusWindow(wid);return;}}
    openApp(appId);
  });
  wrap.addEventListener('contextmenu',e=>{e.preventDefault();e.stopPropagation();showDockCtx(e,appId);});
  return wrap;
}
function makeSep(){const s=document.createElement('div');s.className='d-sep';return s;}
function showDockDot(appId,show){
  const di=document.getElementById('di-'+appId);
  if(!di){buildDock();return;}
  const dot=di.querySelector('.d-dot');if(dot)dot.style.opacity=show?'1':'0';
}
function dockBounce(appId){
  const el=document.getElementById('di-'+appId);if(!el)return;
  el.classList.add('bouncing');setTimeout(()=>el.classList.remove('bouncing'),1500);
}
let _dockCtxApp=null;
function showDockCtx(e,appId){
  _dockCtxApp=appId;
  const menu=document.getElementById('dock-ctx');
  const app=APPS[appId];
  const isPinned=S.dockPinned.includes(appId);
  const hasWin=Object.values(WINS).some(w=>w.appId===appId);
  const isMin=Object.values(WINS).some(w=>w.appId===appId&&w.minimized);
  let html=`<div class="dctx-title">${app.name}</div><div class="dctx-sep"></div>`;
  if(hasWin&&!isMin){html+=`<div class="dctx-item" onclick="dockCtxAction('hide')">🙈 Skrýt okno</div><div class="dctx-item" onclick="dockCtxAction('quit')">✕ Ukončit</div>`;}
  else if(isMin){html+=`<div class="dctx-item" onclick="dockCtxAction('show')">👁 Zobrazit okno</div>`;}
  else{html+=`<div class="dctx-item" onclick="dockCtxAction('open')">🚀 Otevřít</div>`;}
  html+=`<div class="dctx-sep"></div>`;
  if(!['trash','launchpad','finder'].includes(appId)){
    html+=isPinned?`<div class="dctx-item" onclick="dockCtxAction('unpin')">📌 Odebrat z Docku</div>`:`<div class="dctx-item" onclick="dockCtxAction('pin')">📌 Přidat do Docku</div>`;
  }
  html+=`<div class="dctx-item" onclick="dockCtxAction('addDesktop')">🖥 Přidat na plochu</div>`;
  menu.innerHTML=html;menu.style.display='block';
  let x=e.clientX,y=e.clientY-10;
  if(x+180>window.innerWidth)x=window.innerWidth-190;
  if(y+200>window.innerHeight)y=window.innerHeight-210;
  menu.style.left=x+'px';menu.style.top=y+'px';
  setTimeout(()=>document.addEventListener('click',hideDockCtx,{once:true}),10);
}
function dockCtxAction(action){
  const appId=_dockCtxApp;hideDockCtx();if(!appId)return;
  if(action==='open')openApp(appId);
  else if(action==='quit'){for(const[wid,w]of Object.entries(WINS))if(w.appId===appId)closeWindow(wid);}
  else if(action==='hide'){for(const[wid,w]of Object.entries(WINS))if(w.appId===appId&&!w.minimized)minimizeWindow(wid);}
  else if(action==='show'){for(const[wid,w]of Object.entries(WINS))if(w.appId===appId&&w.minimized)restoreWindow(wid);}
  else if(action==='pin'){if(!S.dockPinned.includes(appId)){S.dockPinned.push(appId);saveState();buildDock();notify('📌 Přidáno',APPS[appId]?.name+' přidáno do Docku.');}}
  else if(action==='unpin'){S.dockPinned=S.dockPinned.filter(id=>id!==appId);saveState();buildDock();notify('📌 Odebráno',APPS[appId]?.name+' odebráno z Docku.');}
  else if(action==='addDesktop')addDesktopIcon(appId);
}
function hideDockCtx(){document.getElementById('dock-ctx').style.display='none';_dockCtxApp=null;}

// ================================================================
//   DESKTOP ICONS
// ================================================================
function renderDesktopIcons(){
  const layer=document.getElementById('desktop-icons-layer');layer.innerHTML='';
  layer.appendChild(makeDesktopIcon({id:'__trash__',type:'app',appId:'trash',name:'Koš',x:window.innerWidth-100,y:50,fixed:true}));
  S.desktopIcons.forEach(ico=>layer.appendChild(makeDesktopIcon(ico)));
}
function makeDesktopIcon(ico){
  const el=document.createElement('div');
  el.className='desktop-icon';el.id='dico-'+ico.id;
  el.style.left=(ico.x||window.innerWidth-100)+'px';
  el.style.top=(ico.y||60)+'px';
  let iconHtml='';
  if(ico.type==='app'){const app=APPS[ico.appId];iconHtml=`<div class="di-icon" style="background:${app?.bg||'#888'}">${app?.icon||'📄'}</div>`;}
  else if(ico.type==='file'){const ext=(ico.name||'').split('.').pop().toLowerCase();const fi=ext==='txt'?'📄':ext==='js'?'📜':ext==='html'?'🌐':ext==='py'?'🐍':ext==='mp3'?'🎵':['png','jpg','img','jpeg'].includes(ext)?'🖼️':'📄';iconHtml=`<div class="di-icon" style="background:linear-gradient(135deg,#e8e8e8,#d0d0d0);font-size:28px">${fi}</div>`;}
  else if(ico.type==='folder'){iconHtml=`<div class="di-icon" style="background:linear-gradient(135deg,#5da0e0,#2a7cd6)">📁</div>`;}
  el.innerHTML=`${iconHtml}<div class="di-label">${ico.name}</div>`;
  let clicks=0,ct=null;
  el.addEventListener('click',e=>{
    e.stopPropagation();
    clicks++;
    if(clicks===1)ct=setTimeout(()=>{clicks=0;selectDesktopIcon(ico.id);},260);
    else{clearTimeout(ct);clicks=0;openDesktopIcon(ico);}
  });
  el.addEventListener('contextmenu',e=>{e.preventDefault();e.stopPropagation();showCtxDesktopIcon(e,ico);});
  if(!ico.fixed)makeDraggableIcon(el,ico);
  return el;
}
function selectDesktopIcon(id){
  document.querySelectorAll('.desktop-icon').forEach(el=>el.classList.remove('selected'));
  document.getElementById('dico-'+id)?.classList.add('selected');
}
function openDesktopIcon(ico){
  if(ico.type==='app')openApp(ico.appId);
  else if(ico.type==='file')openFSFile(ico.filePath,ico.name);
  else if(ico.type==='folder')openFinder(ico.folderPath||'/');
}
function addDesktopIcon(appId,x,y){
  const ico={id:'ico_'+(S.nextIconId++),type:'app',appId,name:APPS[appId]?.name||appId,x:x||window.innerWidth-140-Math.floor(Math.random()*200),y:y||60+Math.floor(Math.random()*300)};
  S.desktopIcons.push(ico);saveState();renderDesktopIcons();
  notify('🖥️ Přidáno',APPS[appId]?.name+' přidán na plochu.');
}
function addFileDesktopIcon(filePath,name,x,y){
  const ico={id:'ico_'+(S.nextIconId++),type:'file',filePath,name,x:x||100,y:y||100};
  S.desktopIcons.push(ico);saveState();renderDesktopIcons();
}
function makeDraggableIcon(el,ico){
  let dragging=false,ox=0,oy=0;
  el.addEventListener('mousedown',e=>{
    if(e.button!==0)return;e.stopPropagation();
    const rect=el.getBoundingClientRect();ox=e.clientX-rect.left;oy=e.clientY-rect.top;
    const onMove=ev=>{
      if(!dragging&&Math.abs(ev.clientX-e.clientX)<4&&Math.abs(ev.clientY-e.clientY)<4)return;
      dragging=true;el.classList.add('dragging');
      el.style.left=Math.max(0,Math.min(window.innerWidth-82,ev.clientX-ox))+'px';
      el.style.top=Math.max(28,Math.min(window.innerHeight-100,ev.clientY-oy))+'px';
    };
    const onUp=()=>{
      document.removeEventListener('mousemove',onMove);document.removeEventListener('mouseup',onUp);
      if(dragging){dragging=false;el.classList.remove('dragging');ico.x=parseInt(el.style.left);ico.y=parseInt(el.style.top);
        const si=S.desktopIcons.find(i=>i.id===ico.id);if(si){si.x=ico.x;si.y=ico.y;}saveState();}
    };
    document.addEventListener('mousemove',onMove);document.addEventListener('mouseup',onUp);
  });
}
function showCtxDesktopIcon(e,ico){
  let items=[];
  if(ico.type==='app'){items=[{label:'🚀 Otevřít',action:()=>openApp(ico.appId)},null,{label:'🗑️ Odebrat z plochy',action:()=>removeDesktopIcon(ico.id)}];}
  else{items=[{label:'📂 Otevřít',action:()=>openDesktopIcon(ico)},null,{label:'🗑️ Odebrat z plochy',action:()=>removeDesktopIcon(ico.id)}];}
  showCtxMenu(e,items);
}
function removeDesktopIcon(id){S.desktopIcons=S.desktopIcons.filter(i=>i.id!==id);saveState();renderDesktopIcons();}

// ================================================================
//   APP OPENER
// ================================================================
function openApp(appId){
  mbCloseAll();hideCtxMenu();
  if(!S.installedApps.includes(appId)&&!['finder','settings','appstore','launchpad','trash'].includes(appId)){
    notify('⚠️ Chyba',APPS[appId]?.name||appId+' není nainstalován. Otevřete App Store.');return;
  }
  dockBounce(appId);
  const map={
    finder:()=>openFinder('/'),
    launchpad:openLaunchpad,
    safari:openSafari,
    calculator:openCalculator,
    music:openMusic,
    tv:openTV,
    settings:openSettings,
    appstore:openAppStore,
    vscode:()=>openVSCode(null,null,null),
    word:()=>openWord(null,null),
    mail:openMail,
    trash:openTrash,
    photos:openPhotos,
    snake:openSnake,
    memory:openMemory,
    tetris:openTetris,
    terminal:openTerminal,
    notes:openNotes,
    maps:openMaps,
    clock:openClock,
    weather:openWeather,
    stocks:openStocks,
  };
  if(map[appId])map[appId]();
  else notify('ℹ️ Info','Aplikace "'+appId+'" není k dispozici.');
  setTimeout(()=>buildDock(),100);
}

// ================================================================
//   FILESYSTEM
// ================================================================
function getExt(name){return(name||'').split('.').pop().toLowerCase();}
function getFileIcon(name,type){
  if(type==='dir')return'📁';if(type==='app'){const appId=S.fs['__dummy']?.appId;return APPS[appId]?.icon||'📦';}
  const ext=getExt(name);
  return ext==='txt'?'📄':ext==='js'?'📜':ext==='html'?'🌐':ext==='py'?'🐍':ext==='mp3'?'🎵':['png','jpg','jpeg','img'].includes(ext)?'🖼️':ext==='app'?'📦':'📄';
}
function initFS(){
  const d=S.fs;
  if(!d['/'])d['/']={type:'dir',children:['Desktop','Documents','Applications','Trash','Pictures','Music']};
  if(!d['/Desktop'])d['/Desktop']={type:'dir',children:[]};
  if(!d['/Documents'])d['/Documents']={type:'dir',children:['Vitejte.txt','Notes.txt']};
  if(!d['/Applications'])d['/Applications']={type:'dir',children:[]};
  if(!d['/Trash'])d['/Trash']={type:'dir',children:[]};
  if(!d['/Pictures'])d['/Pictures']={type:'dir',children:[]};
  if(!d['/Music'])d['/Music']={type:'dir',children:[]};
  if(!d['/Documents/Vitejte.txt'])d['/Documents/Vitejte.txt']={type:'file',ext:'txt',content:'Vítejte v macOS Sonoma simulaci! 🍎\n\nToto je virtuální operační systém běžící ve vašem prohlížeči.\n\nMůžete:\n• Otevírat aplikace z Docku nebo Launchpadu\n• Vytvářet a editovat soubory\n• Spouštět JavaScript kód ve VS Code\n• Sledovat videa v Apple TV\n• Hrát hry Snake a Paměť\n\nDvojklikem na soubor ho otevřete ve správné aplikaci.'};
  if(!d['/Documents/Notes.txt'])d['/Documents/Notes.txt']={type:'file',ext:'txt',content:'Moje poznámky\n==============\n\n• Todo: Nainstalovat VS Code\n• Todo: Napsat nový dokument\n• Oblíbená hudba: Bohemian Rhapsody\n'};
  S.installedApps.forEach(appId=>{
    const app=APPS[appId];if(!app||['finder','trash','launchpad'].includes(appId))return;
    const fname=app.name+'.app';const fpath='/Applications/'+fname;
    if(!d[fpath])d[fpath]={type:'app',appId,ext:'app'};
    const dir=d['/Applications'];if(dir&&!dir.children.includes(fname))dir.children.push(fname);
  });
  saveState();
}
function openFSFile(fpath,name){
  const f=S.fs[fpath];if(!f){notify('⚠️ Chyba','Soubor nenalezen.');return;}
  const ext=getExt(name);
  if(f.type==='app'){openApp(f.appId);return;}
  if(ext==='txt'){if(!S.installedApps.includes('word')){notify('⚠️ Word není nainstalován','Pro otevření .txt souborů nainstalujte Word z App Store.');return;}openWord(fpath,name);}
  else if(['png','jpg','jpeg','img','gif','webp'].includes(ext)){if(!S.installedApps.includes('photos')){notify('⚠️ Fotky nejsou nainstalovány','Pro otevření obrázků nainstalujte Fotky z App Store.');return;}openPhotosFile(fpath,name,f);}
  else if(ext==='mp3'){if(!S.installedApps.includes('music')){notify('⚠️ Hudba není nainstalována','Pro přehrávání .mp3 nainstalujte Hudbu z App Store.');return;}openMusic();notify('🎵 Přehráváno',name);}
  else openVSCode(fpath,name,f);
}

// ================================================================
//   FINDER
// ================================================================
let finderPath='/';
let finderHistStack=['/'],finderHistIdx=0;
function openFinder(path){
  path=path||'/';finderPath=path;
  createWindow('finder','Finder',800,520,(body)=>{body.innerHTML=buildFinderUI();renderFinderFiles(path);});
}
function buildFinderUI(){return`<div class="finder-wrap"><div class="finder-sidebar"><div class="finder-sec-title">Oblíbené</div><div class="finder-loc" onclick="navFinder('/')"><span class="finder-loc-icon">🖥️</span>Tento Mac</div><div class="finder-loc" onclick="navFinder('/Desktop')"><span class="finder-loc-icon">🖼️</span>Plocha</div><div class="finder-loc" onclick="navFinder('/Documents')"><span class="finder-loc-icon">📄</span>Dokumenty</div><div class="finder-loc" onclick="navFinder('/Pictures')"><span class="finder-loc-icon">📷</span>Obrázky</div><div class="finder-loc" onclick="navFinder('/Music')"><span class="finder-loc-icon">🎵</span>Hudba</div><div class="finder-sec-title">Místa</div><div class="finder-loc" onclick="navFinder('/Applications')"><span class="finder-loc-icon">📦</span>Aplikace</div><div class="finder-loc" onclick="navFinder('/Trash')"><span class="finder-loc-icon">🗑️</span>Koš</div></div><div class="finder-main-area"><div class="finder-toolbar"><button class="btn btn-sm" onclick="finderBack()">‹</button><button class="btn btn-sm" onclick="finderForward()">›</button><span class="finder-path" id="finder-path-label">/</span><input class="input" style="width:150px;font-size:12px" placeholder="🔍 Hledat..." oninput="finderSearch(this.value)"><label class="btn btn-sm" style="cursor:pointer">📥 Import<input type="file" multiple style="display:none" onchange="importFiles(event)"></label><button class="btn btn-sm" onclick="createFinderFile()">+ Soubor</button><button class="btn btn-sm" onclick="createFinderFolder()">+ Složka</button></div><div class="finder-files-grid" id="finder-grid"></div></div></div>`;}
function navFinder(path){
  finderPath=path;finderHistStack=finderHistStack.slice(0,finderHistIdx+1);finderHistStack.push(path);finderHistIdx=finderHistStack.length-1;
  renderFinderFiles(path);
}
function finderBack(){if(finderHistIdx>0){finderHistIdx--;finderPath=finderHistStack[finderHistIdx];renderFinderFiles(finderPath);}}
function finderForward(){if(finderHistIdx<finderHistStack.length-1){finderHistIdx++;finderPath=finderHistStack[finderHistIdx];renderFinderFiles(finderPath);}}
function renderFinderFiles(path){
  const grid=document.getElementById('finder-grid');const lbl=document.getElementById('finder-path-label');
  if(!grid)return;finderPath=path;if(lbl)lbl.textContent=path;
  const dir=S.fs[path];
  if(!dir||dir.type!=='dir'){grid.innerHTML=`<div class="finder-empty">📭<span>Složka nenalezena</span></div>`;return;}
  const ch=dir.children||[];
  if(!ch.length){grid.innerHTML=`<div class="finder-empty">📭<span>Tato složka je prázdná</span></div>`;return;}
  grid.innerHTML='';
  ch.forEach(name=>{
    const fpath=(path==='/'?'':path)+'/'+name;
    const fobj=S.fs[fpath]||{type:'file',ext:getExt(name)};
    const icon=fobj.type==='app'?(APPS[fobj.appId]?.icon||'📦'):getFileIcon(name,fobj.type);
    const el=document.createElement('div');el.className='f-file';
    el.innerHTML=`<div class="f-file-icon">${icon}</div><div class="f-file-name">${name}</div>`;
    let cl=0,ct=null;
    el.addEventListener('click',e=>{e.stopPropagation();cl++;if(cl===1)ct=setTimeout(()=>{cl=0;el.classList.toggle('selected');},260);else{clearTimeout(ct);cl=0;if(fobj.type==='dir')navFinder(fpath);else openFSFile(fpath,name);}});
    el.addEventListener('contextmenu',e=>{e.preventDefault();showCtxFile(e,fpath,name,fobj);});
    grid.appendChild(el);
  });
  document.querySelectorAll('.finder-loc').forEach(loc=>{
    const onclick=loc.getAttribute('onclick')||'';loc.classList.toggle('active',onclick.includes("'"+path+"'"));
  });
}
function finderSearch(q){
  if(!q){renderFinderFiles(finderPath);return;}
  const grid=document.getElementById('finder-grid');if(!grid)return;grid.innerHTML='';
  const results=Object.keys(S.fs).filter(k=>k!=='/'&&k.split('/').pop().toLowerCase().includes(q.toLowerCase()));
  results.slice(0,40).forEach(fpath=>{
    const name=fpath.split('/').pop();const fobj=S.fs[fpath];const icon=getFileIcon(name,fobj?.type);
    const el=document.createElement('div');el.className='f-file';
    el.innerHTML=`<div class="f-file-icon">${icon}</div><div class="f-file-name">${name}</div>`;
    el.ondblclick=()=>fobj?.type==='dir'?navFinder(fpath):openFSFile(fpath,name);
    grid.appendChild(el);
  });
  if(!results.length)grid.innerHTML=`<div class="finder-empty">🔍<span>Nic nenalezeno pro "${q}"</span></div>`;
}
function createFinderFile(){const name=prompt('Název souboru (s příponou):');if(!name)return;const fpath=(finderPath==='/'?'':finderPath)+'/'+name;S.fs[fpath]={type:'file',ext:getExt(name),content:''};const dir=S.fs[finderPath];if(dir&&!dir.children.includes(name))dir.children.push(name);saveState();renderFinderFiles(finderPath);}
function createFinderFolder(){const name=prompt('Název složky:');if(!name)return;const fpath=(finderPath==='/'?'':finderPath)+'/'+name;S.fs[fpath]={type:'dir',children:[]};const dir=S.fs[finderPath];if(dir&&!dir.children.includes(name))dir.children.push(name);saveState();renderFinderFiles(finderPath);}
function importFiles(e){
  Array.from(e.target.files).forEach(file=>{
    const reader=new FileReader();
    reader.onload=ev=>{const fpath=(finderPath==='/'?'':finderPath)+'/'+file.name;S.fs[fpath]={type:'file',ext:getExt(file.name),content:ev.target.result};const dir=S.fs[finderPath];if(dir&&!dir.children.includes(file.name))dir.children.push(file.name);saveState();renderFinderFiles(finderPath);notify('📥 Importováno',file.name+' přidán.');};
    reader.readAsText(file);
  });
}
function showCtxFile(e,fpath,name,fobj){
  showCtxMenu(e,[
    {label:'📂 Otevřít',action:()=>fobj.type==='dir'?navFinder(fpath):openFSFile(fpath,name)},
    null,
    {label:'✏️ Přejmenovat',action:()=>{const nn=prompt('Nový název:',name);if(!nn||nn===name)return;const pp=findParentDir(fpath);const np=fpath.replace(/\/[^/]+$/,'/'+nn);S.fs[np]=S.fs[fpath];delete S.fs[fpath];const d=S.fs[pp];if(d){const i=d.children.indexOf(name);if(i>=0)d.children[i]=nn;}saveState();renderFinderFiles(finderPath);}},
    {label:'🖥️ Přidat na plochu',action:()=>addFileDesktopIcon(fpath,name)},
    {label:'🗑️ Přesunout do koše',action:()=>trashFile(fpath,name)},
    null,
    {label:'ℹ️ Informace',action:()=>notify('ℹ️ '+name,'Typ: '+fobj.type+'\nVelikost: '+(fobj.content?.length||0)+' znaků\nCesta: '+fpath)},
  ]);
}
function trashFile(fpath,name){
  const pp=findParentDir(fpath);const d=S.fs[pp];if(d)d.children=d.children.filter(n=>n!==name);
  const tp='/Trash/'+name;S.fs[tp]=S.fs[fpath];delete S.fs[fpath];
  const tr=S.fs['/Trash'];if(tr&&!tr.children.includes(name))tr.children.push(name);
  S.trash.push({name,date:new Date().toLocaleDateString('cs-CZ')});
  saveState();renderFinderFiles(finderPath);notify('🗑️ Odstraněno',name+' přesunut do Koše.');
}
function findParentDir(fpath){const parts=fpath.split('/');parts.pop();return parts.join('/')||'/';}

// ================================================================
//   SAFARI
// ================================================================
function openSafari(url){
  createWindow('safari','Safari',950,620,body=>{
    body.innerHTML=`<div class="safari-wrap"><div class="safari-toolbar"><button class="safari-nav-btn" onclick="try{document.getElementById('safari-frame')?.contentWindow?.history?.back();}catch(e){}" title="Zpět">‹</button><button class="safari-nav-btn" onclick="try{document.getElementById('safari-frame')?.contentWindow?.history?.forward();}catch(e){}" title="Vpřed">›</button><button class="safari-nav-btn" onclick="const f=document.getElementById('safari-frame');if(f)f.src=f.src;" title="Obnovit">↺</button><input class="safari-url" id="safari-url-bar" value="${url||''}" placeholder="Hledat nebo zadej adresu" onkeydown="if(event.key==='Enter')safariGo()"><button class="btn btn-primary btn-sm" onclick="safariGo()">Přejít</button></div><div class="safari-body"><div class="safari-new-tab" id="safari-newtab" style="${url?'display:none':''}"><div style="font-size:22px;font-weight:700;color:var(--text);margin-bottom:8px">Oblíbené</div><div class="safari-fav-grid">${SAFARI_FAVS.map(f=>`<div class="safari-fav" onclick="safariLoad('${f.url}')"><div class="safari-fav-icon">${f.icon}</div><div class="safari-fav-name">${f.name}</div></div>`).join('')}</div></div><iframe class="safari-iframe" id="safari-frame" style="${url?'':'display:none'}" src="${url||''}" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe></div></div>`;
    if(url)safariLoad(url);
  });
}
function safariGo(){let url=(document.getElementById('safari-url-bar')?.value||'').trim();if(!url)return;if(!url.startsWith('http'))url='https://www.google.com/search?q='+encodeURIComponent(url);safariLoad(url);}
function safariLoad(url){const f=document.getElementById('safari-frame');const n=document.getElementById('safari-newtab');const b=document.getElementById('safari-url-bar');if(!f)return;f.src=url;f.style.display='';if(n)n.style.display='none';if(b)b.value=url;}

// ================================================================
//   CALCULATOR
// ================================================================
let calcState={cur:'0',prev:null,op:null,newN:true};
function openCalculator(){
  createWindow('calculator','Kalkulačka',320,520,body=>{
    body.innerHTML=`<div class="calc-wrap"><div class="calc-display"><div class="calc-expr" id="calc-expr"></div><div class="calc-num" id="calc-num">0</div></div><div class="calc-grid"><button class="calc-btn calc-top" onclick="cAC()">AC</button><button class="calc-btn calc-top" onclick="cSign()">+/-</button><button class="calc-btn calc-top" onclick="cPct()">%</button><button class="calc-btn calc-op" id="cop-/" onclick="cOp('/')">÷</button><button class="calc-btn" onclick="cNum(7)">7</button><button class="calc-btn" onclick="cNum(8)">8</button><button class="calc-btn" onclick="cNum(9)">9</button><button class="calc-btn calc-op" id="cop-*" onclick="cOp('*')">×</button><button class="calc-btn" onclick="cNum(4)">4</button><button class="calc-btn" onclick="cNum(5)">5</button><button class="calc-btn" onclick="cNum(6)">6</button><button class="calc-btn calc-op" id="cop--" onclick="cOp('-')">−</button><button class="calc-btn" onclick="cNum(1)">1</button><button class="calc-btn" onclick="cNum(2)">2</button><button class="calc-btn" onclick="cNum(3)">3</button><button class="calc-btn calc-op" id="cop-+" onclick="cOp('+')">+</button><button class="calc-btn calc-span2" onclick="cNum(0)">0</button><button class="calc-btn" onclick="cDot()">.</button><button class="calc-btn calc-op" onclick="cEq()">=</button></div></div>`;
    calcState={cur:'0',prev:null,op:null,newN:true};
  });
}
function cUpdate(){const n=document.getElementById('calc-num');const ex=document.getElementById('calc-expr');if(n)n.textContent=calcState.cur;if(ex&&calcState.prev!==null)ex.textContent=calcState.prev+' '+(calcState.op==='*'?'×':calcState.op==='/'?'÷':calcState.op);['/','+','-','*'].forEach(op=>{const el=document.getElementById('cop-'+op);if(el)el.classList.toggle('active',calcState.op===op&&calcState.newN);});}
function cNum(n){if(calcState.newN){calcState.cur=String(n);calcState.newN=false;}else calcState.cur=calcState.cur==='0'?String(n):calcState.cur+n;cUpdate();}
function cDot(){if(calcState.newN){calcState.cur='0.';calcState.newN=false;}else if(!calcState.cur.includes('.'))calcState.cur+='.';cUpdate();}
function cOp(op){if(calcState.prev!==null&&!calcState.newN)cEq();calcState.prev=parseFloat(calcState.cur);calcState.op=op;calcState.newN=true;cUpdate();}
function cEq(){if(calcState.prev===null||!calcState.op)return;const a=calcState.prev,b=parseFloat(calcState.cur);let r;switch(calcState.op){case'+':r=a+b;break;case'-':r=a-b;break;case'*':r=a*b;break;case'/':r=b===0?'Chyba':a/b;break;}const ex=document.getElementById('calc-expr');if(ex)ex.textContent=a+' '+(calcState.op==='*'?'×':calcState.op==='/'?'÷':calcState.op)+' '+b+' =';calcState.cur=typeof r==='number'?String(Math.round(r*1e10)/1e10):r;calcState.prev=null;calcState.op=null;calcState.newN=true;cUpdate();}
function cAC(){calcState={cur:'0',prev:null,op:null,newN:true};const ex=document.getElementById('calc-expr');if(ex)ex.textContent='';cUpdate();}
function cSign(){calcState.cur=String(-parseFloat(calcState.cur)||0);cUpdate();}
function cPct(){calcState.cur=String(parseFloat(calcState.cur)/100);cUpdate();}

// ================================================================
//   MUSIC
// ================================================================
let musicTimerInt=null,musicSec=0;
let localMusicFiles = []; // Stores {name, url, file}
let musicAudio = null; // HTMLAudioElement for local MP3 playback
let musicMode = 'library'; // 'library' or 'local'

function openMusic(){
  createWindow('music','Hudba',740,580,body=>{
    body.innerHTML=`
    <div class="music-wrap">
      <div class="music-sidebar">
        <div class="music-sec" style="margin-top:6px">Knihovna</div>
        <div class="music-nav-item active" id="mn-library" onclick="musicNavSelect('library',this)">🎵 Všechny skladby</div>
        <div class="music-nav-item" id="mn-local" onclick="musicNavSelect('local',this)">📁 Moje soubory</div>
        <div class="music-nav-item" id="mn-albums" onclick="musicNavSelect('albums',this)">💿 Alba</div>
        <div class="music-nav-item" id="mn-artists" onclick="musicNavSelect('artists',this)">🎤 Interpreti</div>
        <div class="music-sec">Přidat hudbu</div>
        <div style="padding:8px 12px">
          <label for="music-file-input" class="btn btn-primary" style="display:block;text-align:center;cursor:pointer;font-size:12px;padding:7px">
            ➕ Přidat MP3 soubory
          </label>
          <input type="file" id="music-file-input" accept="audio/*,.mp3,.m4a,.wav,.flac,.aac,.ogg" multiple style="display:none" onchange="importMusicFiles(this)">
        </div>
        <div class="music-sec">Oblíbené</div>
        <div class="music-nav-item">❤️ Oblíbené</div>
        <div class="music-nav-item">📻 Rádio</div>
        <div class="music-sec">Playlisty</div>
        <div class="music-nav-item">🎧 Playback Queue</div>
      </div>
      <div class="music-main">
        <div class="music-now-playing" id="music-now-playing"></div>
        <div id="music-list-container">
          <div class="music-list" id="music-list"></div>
        </div>
      </div>
    </div>`;
    renderMusicNP();
    renderMusicList();
  });
}

function musicNavSelect(mode, el) {
  document.querySelectorAll('.music-nav-item').forEach(e => e.classList.remove('active'));
  if (el) el.classList.add('active');
  musicMode = mode;
  if (mode === 'library') renderMusicList();
  else if (mode === 'local') renderLocalMusicList();
  else if (mode === 'albums') renderMusicAlbums();
  else if (mode === 'artists') renderMusicArtists();
}

function importMusicFiles(input) {
  const files = Array.from(input.files);
  if (!files.length) return;
  files.forEach(file => {
    const url = URL.createObjectURL(file);
    localMusicFiles.push({name: file.name.replace(/\.[^.]+$/, ''), url, file, type: 'local'});
  });
  notify('🎵 Hudba přidána', files.length + ' soubor(ů) importováno. Otevři "Moje soubory".');
  if (musicMode === 'local') renderLocalMusicList();
  input.value = '';
}

function renderLocalMusicList() {
  const el = document.getElementById('music-list');
  if (!el) return;
  if (!localMusicFiles.length) {
    el.innerHTML = `<div style="text-align:center;padding:40px;color:var(--text-sec)">
      <div style="font-size:48px;margin-bottom:12px">🎵</div>
      <div style="font-size:15px;font-weight:600;margin-bottom:6px">Žádné soubory</div>
      <div style="font-size:13px">Klikni na "+ Přidat MP3 soubory" v postranním panelu<br>a přidej svou hudbu.</div>
      <div style="font-size:12px;margin-top:8px;opacity:0.6">Podporované formáty: MP3, M4A, WAV, FLAC, AAC, OGG</div>
    </div>`;
    return;
  }
  el.innerHTML = localMusicFiles.map((t, i) => `
    <div class="music-track-row" id="lf-${i}" onclick="playLocalFile(${i})">
      <div class="mtr-num">${i+1}</div>
      <div class="mtr-art" style="background:linear-gradient(135deg,hsl(${i*40%360},60%,40%),hsl(${(i*40+120)%360},60%,30%));font-size:18px">🎵</div>
      <div class="mtr-info">
        <div class="mtr-name">${t.name}</div>
        <div class="mtr-artist">Lokální soubor</div>
      </div>
      <button class="btn btn-sm" onclick="event.stopPropagation();openInAppleMusic(${i})" title="Otevřít v Apple Music" style="font-size:11px;padding:3px 8px;background:linear-gradient(145deg,#fc6c7c,#d42040);color:#fff;border:none">🎵 Apple Music</button>
    </div>`).join('');
}

function playLocalFile(idx) {
  if (musicAudio) { musicAudio.pause(); musicAudio = null; }
  clearInterval(musicTimerInt);
  const track = localMusicFiles[idx];
  if (!track) return;
  musicAudio = new Audio(track.url);
  musicAudio.volume = (S.volume || 70) / 100;
  S.musicPlaying = true;
  musicMode = 'local';
  // Update now playing area
  const np = document.getElementById('music-now-playing');
  if (np) {
    const hue = idx * 40 % 360;
    np.innerHTML = `
      <div class="music-art" style="background:linear-gradient(135deg,hsl(${hue},60%,35%),hsl(${(hue+120)%360},60%,25%));font-size:60px">🎵</div>
      <div class="music-track-info">
        <div class="music-track-name">${track.name}</div>
        <div class="music-track-artist" style="color:#ff2d55">Lokální soubor</div>
        <div class="music-track-album">Moje hudba</div>
      </div>
      <div class="music-progress-wrap" style="max-width:280px;width:100%">
        <span id="lf-cur">0:00</span>
        <input type="range" class="music-progress" id="lf-prog" min="0" max="100" value="0" oninput="seekLocalFile(this.value)">
        <span id="lf-dur">–:––</span>
      </div>
      <div class="music-controls">
        <button class="mc-btn" onclick="playLocalFile(${Math.max(0,idx-1)})">⏮</button>
        <button class="mc-btn play" id="lf-play-btn" onclick="toggleLocalAudio()">⏸</button>
        <button class="mc-btn" onclick="playLocalFile(${idx+1 < localMusicFiles.length ? idx+1 : 0})">⏭</button>
      </div>
      <div class="music-volume" style="max-width:240px">
        <span style="font-size:16px">🔈</span>
        <input type="range" class="range" min="0" max="100" value="${S.volume}" oninput="setVolume(this.value)">
        <span style="font-size:16px">🔊</span>
      </div>
      <button class="btn btn-sm" onclick="openInAppleMusic(${idx})" style="background:linear-gradient(145deg,#fc6c7c,#d42040);color:#fff;border:none;font-size:12px">
        🎵 Otevřít v Apple Music
      </button>`;
  }
  musicAudio.play().catch(() => notify('❌ Chyba přehrávání', 'Soubor nelze přehrát.'));
  musicAudio.addEventListener('timeupdate', () => {
    const cur = document.getElementById('lf-cur');
    const prog = document.getElementById('lf-prog');
    const dur = document.getElementById('lf-dur');
    if (cur) cur.textContent = secToTime(Math.floor(musicAudio.currentTime));
    if (prog && musicAudio.duration) prog.value = (musicAudio.currentTime / musicAudio.duration) * 100;
    if (dur && musicAudio.duration) dur.textContent = secToTime(Math.floor(musicAudio.duration));
  });
  musicAudio.addEventListener('ended', () => {
    if (idx + 1 < localMusicFiles.length) playLocalFile(idx + 1);
  });
  // Highlight row
  document.querySelectorAll('[id^="lf-"]').forEach(e => e.classList.remove('playing'));
  document.getElementById('lf-' + idx)?.classList.add('playing');
}

function toggleLocalAudio() {
  if (!musicAudio) return;
  const btn = document.getElementById('lf-play-btn');
  if (musicAudio.paused) { musicAudio.play(); if (btn) btn.textContent = '⏸'; }
  else { musicAudio.pause(); if (btn) btn.textContent = '▶'; }
}

function seekLocalFile(pct) {
  if (musicAudio && musicAudio.duration) {
    musicAudio.currentTime = (pct / 100) * musicAudio.duration;
  }
}

function openInAppleMusic(idx) {
  // Try to open the track in Apple Music using a deep link
  const track = localMusicFiles[idx];
  if (!track) return;
  // Apple Music URL scheme
  const searchQuery = encodeURIComponent(track.name);
  const appleMusicUrl = `music://music.apple.com/search?term=${searchQuery}`;
  // Try music:// protocol first, fallback to Apple Music web
  const a = document.createElement('a');
  a.href = appleMusicUrl;
  a.style.display = 'none';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  // Also notify and offer web fallback
  setTimeout(() => {
    notify('🎵 Apple Music', `Hledám "${track.name}" v Apple Music...`);
  }, 500);
}

function renderMusicAlbums() {
  const el = document.getElementById('music-list');
  if (!el) return;
  const albums = {};
  MUSIC_LIBRARY.forEach(t => {
    if (!albums[t.album]) albums[t.album] = {tracks:[], artist:t.artist, bg:t.bg, emoji:t.emoji};
    albums[t.album].tracks.push(t);
  });
  el.innerHTML = `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:14px;padding:16px">${Object.entries(albums).map(([album, data]) => `
    <div onclick="renderMusicList()" style="cursor:pointer;text-align:center">
      <div style="background:${data.bg};border-radius:12px;aspect-ratio:1;display:flex;align-items:center;justify-content:center;font-size:40px;margin-bottom:8px;box-shadow:var(--shadow-sm)">${data.emoji}</div>
      <div style="font-size:13px;font-weight:600;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${album}</div>
      <div style="font-size:11px;color:var(--text-sec)">${data.artist}</div>
    </div>`).join('')}</div>`;
}

function renderMusicArtists() {
  const el = document.getElementById('music-list');
  if (!el) return;
  const artists = {};
  MUSIC_LIBRARY.forEach(t => {
    if (!artists[t.artist]) artists[t.artist] = [];
    artists[t.artist].push(t);
  });
  el.innerHTML = Object.entries(artists).map(([artist, tracks]) => `
    <div class="music-track-row" onclick="renderMusicList()">
      <div class="mtr-art" style="background:${tracks[0].bg};border-radius:50%">${tracks[0].emoji}</div>
      <div class="mtr-info">
        <div class="mtr-name">${artist}</div>
        <div class="mtr-artist">${tracks.length} skladeb</div>
      </div>
    </div>`).join('');
}

function parseDur(dur){const[m,s]=(dur||'3:00').split(':');return parseInt(m)*60+parseInt(s);}
function secToTime(s){return Math.floor(s/60)+':'+(s%60).toString().padStart(2,'0');}
function renderMusicNP(){
  const el=document.getElementById('music-now-playing');if(!el)return;
  const t=MUSIC_LIBRARY[S.musicCurrentIdx];const dur=parseDur(t.dur);const pct=(musicSec/dur)*100;
  el.innerHTML=`<div class="music-art" style="background:${t.bg}">${t.emoji}</div><div class="music-track-info"><div class="music-track-name">${t.title}</div><div class="music-track-artist">${t.artist}</div><div class="music-track-album">${t.album}</div></div><div class="music-progress-wrap" style="max-width:260px;width:100%"><span>${secToTime(musicSec)}</span><input type="range" class="music-progress" min="0" max="100" value="${pct}" oninput="seekMusic(this.value)"><span>${t.dur}</span></div><div class="music-controls"><button class="mc-btn" onclick="musicShuffle()">⇄</button><button class="mc-btn" onclick="prevTrack()">⏮</button><button class="mc-btn play" id="music-play-btn" onclick="toggleMusic()">${S.musicPlaying?'⏸':'▶'}</button><button class="mc-btn" onclick="nextTrack()">⏭</button><button class="mc-btn">↻</button></div><div class="music-volume" style="max-width:240px"><span style="font-size:16px">🔈</span><input type="range" class="range" min="0" max="100" value="${S.volume}" oninput="setVolume(this.value)"><span style="font-size:16px">🔊</span></div>`;
}
function renderMusicList(){
  const el=document.getElementById('music-list');if(!el)return;
  el.innerHTML=MUSIC_LIBRARY.map((t,i)=>`<div class="music-track-row ${i===S.musicCurrentIdx?'playing':''}" onclick="playTrack(${i})"><div class="mtr-num">${i===S.musicCurrentIdx&&S.musicPlaying?'▶':i+1}</div><div class="mtr-art" style="background:${t.bg}">${t.emoji}</div><div class="mtr-info"><div class="mtr-name">${t.title}</div><div class="mtr-artist">${t.artist} • ${t.album}</div></div><div class="mtr-dur">${t.dur}</div></div>`).join('');
}
function toggleMusic(){
  S.musicPlaying=!S.musicPlaying;
  if(S.musicPlaying){musicTimerInt=setInterval(()=>{musicSec++;const t=MUSIC_LIBRARY[S.musicCurrentIdx];const dur=parseDur(t.dur);if(musicSec>=dur){musicSec=0;nextTrack();return;}const prog=document.querySelector('.music-progress');const timeEl=document.querySelector('.music-progress-wrap span');if(prog)prog.value=(musicSec/dur)*100;if(timeEl)timeEl.textContent=secToTime(musicSec);},1000);}
  else clearInterval(musicTimerInt);
  const btn=document.getElementById('music-play-btn');if(btn)btn.textContent=S.musicPlaying?'⏸':'▶';
  saveState();
}
function playTrack(idx){musicSec=0;clearInterval(musicTimerInt);S.musicCurrentIdx=idx;S.musicPlaying=true;renderMusicNP();renderMusicList();toggleMusic();}
function prevTrack(){playTrack((S.musicCurrentIdx-1+MUSIC_LIBRARY.length)%MUSIC_LIBRARY.length);}
function nextTrack(){playTrack((S.musicCurrentIdx+1)%MUSIC_LIBRARY.length);}
function seekMusic(pct){const t=MUSIC_LIBRARY[S.musicCurrentIdx];musicSec=Math.floor(parseDur(t.dur)*pct/100);}
function musicShuffle(){playTrack(Math.floor(Math.random()*MUSIC_LIBRARY.length));}

// ================================================================
//   APPLE TV
// ================================================================
function openTV(){
  createWindow('tv','Apple TV',900,600,body=>{
    body.innerHTML=`<div class="tv-wrap"><div class="tv-top-nav"><div class="tv-nav-item active" onclick="tvNav(this,'home')">🏠 Domů</div><div class="tv-nav-item" onclick="tvNav(this,'originals')">🍎 Originály</div><div class="tv-nav-item" onclick="tvNav(this,'trending')">🔥 Trendy</div><div class="tv-nav-item" onclick="tvNav(this,'search')">🔍 Hledat</div></div><div id="tv-body" style="flex:1;overflow:hidden;display:flex;flex-direction:column"></div></div>`;
    showTVHome();
  });
}
function tvNav(el,view){document.querySelectorAll('.tv-nav-item').forEach(e=>e.classList.remove('active'));el.classList.add('active');if(view==='home')showTVHome();else if(view==='originals')showTVCat('originals','🍎 Apple Originály');else if(view==='trending')showTVCat('trending','🔥 Trendy');else showTVSearch();}
function tvCardHTML(v){return`<div class="tv-card" onclick="playTV('${v.id}','${v.title}')"><div class="tv-card-thumb" style="background:linear-gradient(135deg,hsl(${(v.title.charCodeAt(0)*7)%360},60%,25%),hsl(${(v.title.charCodeAt(0)*13)%360},60%,15%))">${v.emoji}</div><div class="tv-card-info"><div class="tv-card-title">${v.title}</div><div class="tv-card-sub">${v.genre} • ${v.sub}</div></div></div>`;}
function showTVHome(){const body=document.getElementById('tv-body');if(!body)return;body.innerHTML=`<div class="tv-content-area"><div class="tv-section-title">⭐ Doporučeno</div><div class="tv-row">${TV_CONTENT.featured.map(tvCardHTML).join('')}</div><div class="tv-section-title">🍎 Apple Originály</div><div class="tv-row">${TV_CONTENT.originals.map(tvCardHTML).join('')}</div><div class="tv-section-title">🔥 Trendy</div><div class="tv-row">${TV_CONTENT.trending.map(tvCardHTML).join('')}</div></div>`;}
function showTVCat(cat,title){const body=document.getElementById('tv-body');if(!body)return;body.innerHTML=`<div class="tv-content-area"><div class="tv-section-title">${title}</div><div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:14px">${TV_CONTENT[cat].map(tvCardHTML).join('')}</div></div>`;}
function showTVSearch(){const body=document.getElementById('tv-body');if(!body)return;body.innerHTML=`<div class="tv-search-bar"><input class="input" id="tv-si" placeholder="🔍 Hledat filmy, seriály..." onkeydown="if(event.key==='Enter')tvDoSearch()"><button class="btn btn-primary" onclick="tvDoSearch()">Hledat</button></div><div id="tv-sr" class="tv-content-area"><div style="color:var(--text-sec);font-size:14px">Zadejte hledaný výraz...</div></div>`;}
function tvDoSearch(){const q=document.getElementById('tv-si')?.value||'';if(!q)return;const sr=document.getElementById('tv-sr');if(sr)sr.innerHTML=`<div class="tv-section-title">Výsledky pro "${q}"</div><div class="tv-row">${[...TV_CONTENT.featured,...TV_CONTENT.originals,...TV_CONTENT.trending].filter(v=>v.title.toLowerCase().includes(q.toLowerCase())||v.genre.toLowerCase().includes(q.toLowerCase())).map(tvCardHTML).join('')||'<div style="color:var(--text-sec)">Nic nenalezeno.</div>'}</div>`;}
function playTV(ytId,title){const body=document.getElementById('tv-body');if(!body)return;body.innerHTML=`<div class="tv-player-wrap"><div class="tv-player-title"><button onclick="showTVHome()" style="background:none;border:none;cursor:pointer;color:var(--accent);font-size:13px;margin-right:10px">‹ Zpět</button>${title}</div><div class="tv-iframe-box"><iframe src="https://www.youtube.com/embed/${ytId}?autoplay=1&controls=1" allowfullscreen allow="autoplay;encrypted-media"></iframe></div></div>`;}

// ================================================================
//   SETTINGS
// ================================================================
const SETTINGS_NAV=[
  {id:'appearance',icon:'🎨',bg:'linear-gradient(135deg,#667eea,#764ba2)',name:'Vzhled'},
  {id:'dock',icon:'🚀',bg:'linear-gradient(135deg,#4facfe,#00f2fe)',name:'Dock & Lišta'},
  {id:'wallpaper',icon:'🖼️',bg:'linear-gradient(135deg,#43e97b,#38f9d7)',name:'Tapeta'},
  {id:'display',icon:'💻',bg:'linear-gradient(135deg,#fa709a,#fee140)',name:'Displej'},
  {id:'sound',icon:'🔊',bg:'linear-gradient(135deg,#f093fb,#f5576c)',name:'Zvuk'},
  {id:'privacy',icon:'🔒',bg:'linear-gradient(135deg,#232526,#414345)',name:'Soukromí'},
  {id:'general',icon:'⚙️',bg:'linear-gradient(135deg,#9fa8ba,#6b7a8d)',name:'Obecné'},
  {id:'about',icon:'💿',bg:'linear-gradient(135deg,#e0c3fc,#8ec5fc)',name:'O Macu'},
];
function openSettings(){
  createWindow('settings','Předvolby systému',780,540,body=>{
    body.innerHTML=`<div class="settings-wrap"><div class="settings-sidebar">${SETTINGS_NAV.map(s=>`<div class="settings-nav-item" id="sni-${s.id}" onclick="showSettingsSection('${s.id}')"><div class="sni-icon" style="background:${s.bg}">${s.icon}</div>${s.name}</div>`).join('')}</div><div class="settings-main-area" id="settings-main"></div></div>`;
    showSettingsSection('appearance');
  });
}
function showSettingsSection(id){
  document.querySelectorAll('.settings-nav-item').forEach(e=>e.classList.remove('active'));
  document.getElementById('sni-'+id)?.classList.add('active');
  const main=document.getElementById('settings-main');if(!main)return;
  const tg=(on,label,sub,onc)=>`<div class="set-row"><div class="set-row-icon"></div><div class="set-row-info"><div class="set-row-label">${label}</div>${sub?`<div class="set-row-sub">${sub}</div>`:''}</div><div class="set-row-ctrl"><div class="toggle ${on?'on':''}" onclick="${onc}"></div></div></div>`;
  if(id==='appearance')main.innerHTML=`<div class="set-title">Vzhled</div><div class="set-section"><div class="set-card">${tg(S.darkMode,'🌙 Dark Mode','Přepnout tmavý režim',"toggleDarkMode();this.classList.toggle('on')")}<div class="set-row"><div class="set-row-icon">🔵</div><div class="set-row-info"><div class="set-row-label">Barva akcentu</div></div><div class="set-row-ctrl"><input type="color" value="#0071e3" onchange="changeAccent(this.value)" style="width:36px;height:28px;border:none;background:none;cursor:pointer;border-radius:4px"></div></div>${tg(true,'✨ Průhlednost','Efekty průhlednosti oken','')}</div></div>`;
  else if(id==='dock')main.innerHTML=`<div class="set-title">Dock & Lišta menu</div><div class="set-section"><div class="set-card"><div class="set-row"><div class="set-row-icon">📏</div><div class="set-row-info"><div class="set-row-label">Velikost ikon: <span id="dock-size-label">${S.dockSize}px</span></div><input type="range" class="range" min="36" max="80" value="${S.dockSize}" oninput="changeDockSize(this.value)" style="margin-top:8px;width:100%"></div></div>${tg(true,'🔍 Zvětšení při najetí','Ikony se zvětší','')}${tg(false,'⬇️ Automaticky skrývat','Dock se skryje',"toggleDockAutoHide(this)")}<div class="set-row"><div class="set-row-icon">📌</div><div class="set-row-info"><div class="set-row-label">Pinnuté aplikace</div><div class="set-row-sub">${S.dockPinned.map(id=>APPS[id]?.name||id).join(', ')}</div></div></div></div></div>`;
  else if(id==='wallpaper')main.innerHTML=`<div class="set-title">Tapeta plochy</div><div class="set-section"><div class="set-card" style="padding:16px"><div class="wallpaper-grid">${Object.entries(WALLPAPERS).map(([key,wp])=>`<div class="wp-opt ${S.wallpaper===key?'selected':''}" style="background:${wp.bg}" onclick="setWallpaper('${key}',this)"><span class="wp-opt-label">${wp.label}</span></div>`).join('')}</div></div></div>`;
  else if(id==='display')main.innerHTML=`<div class="set-title">Displej</div><div class="set-section"><div class="set-card"><div class="set-row"><div class="set-row-icon">☀️</div><div class="set-row-info"><div class="set-row-label">Jas</div><input type="range" class="range" min="20" max="100" value="80" oninput="document.getElementById('desktop').style.filter='brightness('+this.value/100+')'" style="margin-top:8px;width:100%"></div></div><div class="set-row"><div class="set-row-icon">🌡️</div><div class="set-row-info"><div class="set-row-label">Teplota barev</div><input type="range" class="range" min="0" max="100" value="50" style="margin-top:8px;width:100%"></div></div><div class="set-row"><div class="set-row-icon">🔲</div><div class="set-row-info"><div class="set-row-label">Rozlišení</div></div><div class="set-row-ctrl"><span class="set-row-val">${window.innerWidth}×${window.innerHeight}</span></div></div></div></div>`;
  else if(id==='sound')main.innerHTML=`<div class="set-title">Zvuk</div><div class="set-section"><div class="set-card"><div class="set-row"><div class="set-row-icon">🔊</div><div class="set-row-info"><div class="set-row-label">Výstupní hlasitost: <span id="vol-label">${S.volume}%</span></div><input type="range" class="range" min="0" max="100" value="${S.volume}" oninput="setVolume(this.value)" style="margin-top:8px;width:100%"></div></div>${tg(true,'🔔 Zvukový efekt','Přehrávat zvuky','')}${tg(true,'🎙️ Siri','Aktivovat hlasovým příkazem','')}</div></div>`;
  else if(id==='privacy')main.innerHTML=`<div class="set-title">Soukromí & Bezpečnost</div><div class="set-section"><div class="set-card">${tg(false,'📍 Poloha','Sdílení polohy s aplikacemi','')}${tg(true,'🎤 Mikrofon','Přístup k mikrofonu','')}${tg(true,'📷 Kamera','Přístup ke kameře','')}${tg(false,'📊 Analytika','Sdílet diagnostická data','')}</div></div><div class="set-section"><div class="set-card"><div class="set-row"><div class="set-row-icon">🛡️</div><div class="set-row-info"><div class="set-row-label">FileVault</div></div><div class="set-row-ctrl"><span class="set-row-val" style="color:#34c759">Zapnuto</span></div></div></div></div>`;
  else if(id==='general')main.innerHTML=`<div class="set-title">Obecné</div><div class="set-section"><div class="set-card">${tg(true,'💾 Automatické ukládání','Ukládat do localStorage','')}${tg(true,'🗂️ Zavřít okna při ukončení','','')}</div></div><div class="set-section"><div class="set-card"><div class="set-row"><div class="set-row-icon">🔄</div><div class="set-row-info"><div class="set-row-label">Reset systému</div><div class="set-row-sub">Smazat všechna data</div></div><div class="set-row-ctrl"><button class="btn btn-danger btn-sm" onclick="resetSystem()">Reset</button></div></div></div></div>`;
  else if(id==='about')main.innerHTML=`<div style="display:flex;align-items:center;gap:20px;margin-bottom:24px;padding:20px"><div style="font-size:72px">🍎</div><div><div style="font-size:22px;font-weight:700;color:var(--text)">macOS Sonoma</div><div style="color:var(--text-sec);font-size:14px">Verze 14.0 (Simulace)</div></div></div><div class="set-card"><div class="set-row"><div class="set-row-icon">💻</div><div class="set-row-info"><div class="set-row-label">Procesor</div></div><div class="set-row-ctrl"><span class="set-row-val">Apple M3 Pro (Simulovaný)</span></div></div><div class="set-row"><div class="set-row-icon">🧠</div><div class="set-row-info"><div class="set-row-label">Paměť</div></div><div class="set-row-ctrl"><span class="set-row-val">18 GB Unified Memory</span></div></div><div class="set-row"><div class="set-row-icon">💾</div><div class="set-row-info"><div class="set-row-label">Úložiště</div></div><div class="set-row-ctrl"><span class="set-row-val">localStorage</span></div></div></div>`;
}
function changeDockSize(v){S.dockSize=parseInt(v);document.documentElement.style.setProperty('--dock-sz',v+'px');const l=document.getElementById('dock-size-label');if(l)l.textContent=v+'px';saveState();}
function changeAccent(hex){document.documentElement.style.setProperty('--accent',hex);const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);document.documentElement.style.setProperty('--accent-rgb',r+','+g+','+b);}
function setWallpaper(key,el){S.wallpaper=key;applyWallpaper();saveState();document.querySelectorAll('.wp-opt').forEach(e=>e.classList.remove('selected'));if(el)el.classList.add('selected');}
function applyWallpaper(){const wp=WALLPAPERS[S.wallpaper]||WALLPAPERS.sonoma;document.getElementById('desktop').style.background=wp.bg;}
function _setVolumeLegacy(v){S.volume=parseInt(v);saveState();}
function toggleDockAutoHide(el){const dw=document.getElementById('dock-wrap');if(!dw)return;if(dw.dataset.ah==='1'){dw.style.transform='translateX(-50%)';dw.dataset.ah='0';}else{dw.dataset.ah='1';}}

// ================================================================
//   APP STORE
// ================================================================
let storeFilter='all';
function openAppStore(){
  createWindow('appstore','App Store',800,580,body=>{
    body.innerHTML=`<div class="appst-wrap"><div class="appst-header"><div class="appst-title">🛍️ App Store</div><div class="appst-cats"><div class="appst-cat active" onclick="filterStore('all',this)">Vše</div><div class="appst-cat" onclick="filterStore('Vývojáři',this)">Vývojáři</div><div class="appst-cat" onclick="filterStore('Kancelář',this)">Kancelář</div><div class="appst-cat" onclick="filterStore('Hry',this)">Hry</div><div class="appst-cat" onclick="filterStore('Grafika',this)">Grafika</div><div class="appst-cat" onclick="filterStore('Komunikace',this)">Komunikace</div></div></div><div class="appst-grid" id="store-grid"></div></div>`;
    storeFilter='all';renderStore();
  });
}
function filterStore(cat,el){storeFilter=cat;document.querySelectorAll('.appst-cat').forEach(e=>e.classList.remove('active'));if(el)el.classList.add('active');renderStore();}
function renderStore(){
  const grid=document.getElementById('store-grid');if(!grid)return;
  const filtered=storeFilter==='all'?STORE_APPS:STORE_APPS.filter(a=>a.cat===storeFilter);
  grid.innerHTML=filtered.map(app=>{const inst=S.installedApps.includes(app.id);return`<div class="app-card"><div class="app-card-ico" style="background:${app.bg}">${APPS[app.id]?.icon||'📦'}</div><div class="app-card-body"><div class="app-card-name">${app.name}</div><div class="app-card-cat">${app.cat}</div><div class="app-card-stars">${'★'.repeat(Math.floor(app.stars))}${'☆'.repeat(5-Math.floor(app.stars))} ${app.stars}</div><div class="app-card-desc">${app.desc}</div><button class="inst-btn ${inst?'installed':''}" onclick="toggleInstall('${app.id}',this)">${inst?'✓ Nainstalováno':'Instalovat'}</button></div></div>`;}).join('');
}
function toggleInstall(appId,btn){
  const idx=S.installedApps.indexOf(appId);
  if(idx>-1){S.installedApps.splice(idx,1);btn.textContent='Instalovat';btn.classList.remove('installed');removeAppFromFS(appId);notify('🗑️ Odinstalováno',APPS[appId]?.name+' byl odinstalován.');}
  else{S.installedApps.push(appId);btn.textContent='✓ Nainstalováno';btn.classList.add('installed');addAppToFS(appId);notify('✅ Nainstalováno',APPS[appId]?.name+' byl nainstalován!');}
  buildLaunchpad();saveState();buildDock();
}
function addAppToFS(appId){const app=APPS[appId];if(!app)return;const fname=app.name+'.app';const fpath='/Applications/'+fname;if(!S.fs[fpath])S.fs[fpath]={type:'app',appId,ext:'app'};const dir=S.fs['/Applications'];if(dir&&!dir.children.includes(fname))dir.children.push(fname);}
function removeAppFromFS(appId){const app=APPS[appId];if(!app)return;const fname=app.name+'.app';delete S.fs['/Applications/'+fname];const dir=S.fs['/Applications'];if(dir)dir.children=dir.children.filter(n=>n!==fname);}

// ================================================================
//   VS CODE
// ================================================================
const VSC_SAMPLES={'main.js':'// JavaScript\nconsole.log("Ahoj světe! 👋");\n\nconst nums = [1,2,3,4,5];\nconst doubled = nums.map(n => n * 2);\nconsole.log("Zdvojené:", doubled);\n\nconst greet = name => `Ahoj, ${name}!`;\nconsole.log(greet("macOS"));\n','index.html':'<!DOCTYPE html>\n<html lang="cs">\n<head><meta charset="UTF-8"><title>Moje stránka</title>\n<style>body{font-family:sans-serif;background:#1a1a2e;color:#e0e0e0;display:flex;align-items:center;justify-content:center;height:100vh}h1{font-size:3em;background:linear-gradient(135deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent}</style>\n</head><body><h1>Hello from macOS! 🍎</h1></body></html>','script.py':'# Python 3\nprint("Ahoj z Pythonu! 🐍")\n\ndef fibonacci(n):\n    a, b = 0, 1\n    result = []\n    while a < n:\n        result.append(a)\n        a, b = b, a+b\n    return result\n\nprint("Fibonacci do 100:", fibonacci(100))\n'};
let vscFiles={},vscCurrent='main.js';
function openVSCode(fpath,fname,fobj){
  if(!S.installedApps.includes('vscode')){notify('⚠️ VS Code není nainstalován','Nainstalujte VS Code z App Store.');return;}
  vscFiles=Object.assign({},VSC_SAMPLES);
  if(fpath&&fname&&fobj){vscFiles[fname]=fobj.content||'';vscCurrent=fname;}else vscCurrent='main.js';
  createWindow('vscode','Visual Studio Code',940,580,body=>{
    body.innerHTML=`<div class="vsc-wrap"><div class="vsc-activity"><div class="vsc-act-btn active" title="Průzkumník">📁</div><div class="vsc-act-btn" title="Hledat">🔍</div><div class="vsc-act-btn" title="Git">🔀</div><div class="vsc-act-btn" title="Debug">🐛</div><div class="vsc-act-btn" title="Rozšíření">🧩</div></div><div class="vsc-sidebar"><div class="vsc-sidebar-title">Průzkumník</div><div style="padding:0 4px" id="vsc-file-list">${Object.keys(vscFiles).map(f=>`<div class="vsc-file-item" id="vfi-${f.replace(/\./g,'_')}" onclick="vscOpenFile('${f}')">${vscFileIcon(f)} ${f}</div>`).join('')}</div><div style="padding:8px;margin-top:8px"><button class="btn btn-sm" style="width:100%;font-size:11px" onclick="vscNewFile()">+ Nový soubor</button></div></div><div class="vsc-main"><div class="vsc-tabs" id="vsc-tabs"></div><div class="vsc-run-bar"><select class="vsc-lang-sel" id="vsc-lang" onchange="vscLangChange(this.value)"><option value="js">JavaScript</option><option value="html">HTML</option><option value="py">Python</option><option value="css">CSS</option></select><button class="vsc-run-btn" onclick="vscRun()">▶ Spustit</button><button class="vsc-save-btn" onclick="vscSave()">💾 Uložit</button><button class="btn btn-sm" onclick="vscClear()">🗑️ Vymazat</button><span style="margin-left:auto;font-size:11px;color:var(--text-sec)" id="vsc-cursor">Ln 1, Col 1</span></div><div class="vsc-editor-wrap"><textarea class="vsc-editor" id="vsc-editor" spellcheck="false" onkeydown="vscKeydown(event)" oninput="vscInput()" onclick="vscUpdateCursor(this)" onkeyup="vscUpdateCursor(this)"></textarea></div><div class="vsc-output" id="vsc-output"><div class="vsc-out-prompt">> Konzola připravena. Klikněte ▶ Spustit.</div></div><div class="vsc-status"><span id="vsc-status-lang">JavaScript</span><span>UTF-8</span><span>LF</span><span id="vsc-status-file">main.js</span></div></div></div>`;
    vscOpenFile(vscCurrent);
  });
}
function vscFileIcon(f){const e=getExt(f);return e==='js'?'📜':e==='html'?'🌐':e==='py'?'🐍':e==='css'?'🎨':'📄';}
function vscOpenFile(fname){
  const ed=document.getElementById('vsc-editor');if(ed&&vscCurrent)vscFiles[vscCurrent]=ed.value;
  vscCurrent=fname;if(ed)ed.value=vscFiles[fname]||'';
  const tabs=document.getElementById('vsc-tabs');
  if(tabs)tabs.innerHTML=Object.keys(vscFiles).map(f=>`<div class="vsc-tab ${f===fname?'active':''}" onclick="vscOpenFile('${f}')">${vscFileIcon(f)} ${f}</div>`).join('');
  document.querySelectorAll('.vsc-file-item').forEach(el=>el.classList.remove('active'));
  document.getElementById('vfi-'+fname.replace(/\./g,'_'))?.classList.add('active');
  const ext=getExt(fname);const lang=document.getElementById('vsc-lang');if(lang)lang.value=ext==='html'?'html':ext==='py'?'py':ext==='css'?'css':'js';
  const sl=document.getElementById('vsc-status-lang');if(sl)sl.textContent=ext==='html'?'HTML':ext==='py'?'Python':ext==='css'?'CSS':'JavaScript';
  const sf=document.getElementById('vsc-status-file');if(sf)sf.textContent=fname;
}
function vscInput(){const ed=document.getElementById('vsc-editor');if(ed&&vscCurrent)vscFiles[vscCurrent]=ed.value;}
function vscNewFile(){const name=prompt('Název souboru (s příponou):');if(!name)return;vscFiles[name]='// '+name+'\n';const fl=document.getElementById('vsc-file-list');if(fl)fl.innerHTML+=`<div class="vsc-file-item" id="vfi-${name.replace(/\./g,'_')}" onclick="vscOpenFile('${name}')">${vscFileIcon(name)} ${name}</div>`;vscOpenFile(name);}
function vscKeydown(e){if(e.key==='Tab'){e.preventDefault();const ed=e.target;const s=ed.selectionStart;ed.value=ed.value.substring(0,s)+'  '+ed.value.substring(ed.selectionEnd);ed.selectionStart=ed.selectionEnd=s+2;}if((e.ctrlKey||e.metaKey)&&e.key==='s'){e.preventDefault();vscSave();}if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){e.preventDefault();vscRun();}}
function vscUpdateCursor(el){const t=el.value.substring(0,el.selectionStart);const ln=t.split('\n').length;const col=t.split('\n').pop().length+1;const cur=document.getElementById('vsc-cursor');if(cur)cur.textContent='Ln '+ln+', Col '+col;}
function vscLangChange(lang){const el=document.getElementById('vsc-status-lang');if(el)el.textContent=lang==='html'?'HTML':lang==='py'?'Python':lang==='css'?'CSS':'JavaScript';}
function vscRun(){
  const ed=document.getElementById('vsc-editor');const out=document.getElementById('vsc-output');const lang=document.getElementById('vsc-lang')?.value;
  if(!ed||!out)return;out.innerHTML='';
  if(lang==='html'){const w=window.open('','_blank','width=800,height=600');if(w){w.document.write(ed.value);w.document.close();}addVscOut(out,'🌐 HTML otevřen v novém okně.',false);return;}
  if(lang==='py'){const lines=ed.value.split('\n');lines.forEach(l=>{const m=l.match(/^\s*print\((.+)\)/);if(m)addVscOut(out,m[1].replace(/f?["'](.*)["']/,'$1'),false);});addVscOut(out,'✓ Python simulace dokončena.',false);return;}
  const logs=[],errs=[];const ol=console.log,oe=console.error,ow=console.warn;
  console.log=(...a)=>logs.push(a.map(x=>typeof x==='object'?JSON.stringify(x,null,2):String(x)).join(' '));
  console.error=(...a)=>errs.push(a.join(' '));console.warn=(...a)=>logs.push('⚠️ '+a.join(' '));
  try{eval(ed.value);}catch(e){errs.push('Chyba: '+e.message);}
  console.log=ol;console.error=oe;console.warn=ow;
  if(!logs.length&&!errs.length)addVscOut(out,'(žádný výstup)',false);
  logs.forEach(l=>addVscOut(out,l,false));errs.forEach(l=>addVscOut(out,l,true));
}
function addVscOut(container,text,isErr){const d=document.createElement('div');d.className=isErr?'vsc-out-line vsc-out-error':'vsc-out-line';d.textContent='> '+text;container.appendChild(d);container.scrollTop=container.scrollHeight;}
function vscSave(){const ed=document.getElementById('vsc-editor');if(!ed)return;const fp='/Documents/'+vscCurrent;S.fs[fp]={type:'file',ext:getExt(vscCurrent),content:ed.value};const dir=S.fs['/Documents'];if(dir&&!dir.children.includes(vscCurrent))dir.children.push(vscCurrent);saveState();notify('💾 Uloženo',vscCurrent+' → /Documents/');}
function vscClear(){const out=document.getElementById('vsc-output');if(out)out.innerHTML='<div class="vsc-out-prompt">> Výstup vymazán.</div>';}

// ================================================================
//   WORD
// ================================================================
function openWord(fpath,fname){
  if(!S.installedApps.includes('word')){notify('⚠️ Word není nainstalován','Nainstalujte Word z App Store.');return;}
  const content=fpath&&S.fs[fpath]?S.fs[fpath].content:'';const title=fname||'Nový dokument';
  createWindow('word',title,780,600,body=>{
    body.innerHTML=`<div class="word-wrap"><div class="word-toolbar"><div class="wt-group"><select class="wt-sel" onchange="document.execCommand('fontName',false,this.value)" style="width:100px"><option>Inter</option><option>Georgia</option><option>Times New Roman</option><option>Courier New</option><option>Arial</option></select><select class="wt-sel" onchange="document.execCommand('fontSize',false,this.value)" style="width:54px"><option value="2">10</option><option value="3" selected>12</option><option value="4">14</option><option value="5">18</option><option value="6">24</option><option value="7">36</option></select></div><div class="wt-group"><button class="wt-btn" onclick="document.execCommand('bold')" title="B"><b>B</b></button><button class="wt-btn" onclick="document.execCommand('italic')" title="I"><i>I</i></button><button class="wt-btn" onclick="document.execCommand('underline')" title="U"><u>U</u></button><button class="wt-btn" onclick="document.execCommand('strikeThrough')" title="S"><s>S</s></button></div><div class="wt-group"><button class="wt-btn" onclick="document.execCommand('justifyLeft')">⬅</button><button class="wt-btn" onclick="document.execCommand('justifyCenter')">↔</button><button class="wt-btn" onclick="document.execCommand('justifyRight')">➡</button><button class="wt-btn" onclick="document.execCommand('justifyFull')">☰</button></div><div class="wt-group"><button class="wt-btn" onclick="document.execCommand('insertUnorderedList')">•≡</button><button class="wt-btn" onclick="document.execCommand('insertOrderedList')">1≡</button></div><div class="wt-group"><input type="color" onchange="document.execCommand('foreColor',false,this.value)" title="Barva textu" style="width:26px;height:26px;border:none;padding:0;cursor:pointer;border-radius:4px"><input type="color" value="#ffff00" onchange="document.execCommand('hiliteColor',false,this.value)" title="Zvýraznění" style="width:26px;height:26px;border:none;padding:0;cursor:pointer;border-radius:4px"></div><div class="wt-group"><button class="wt-btn" onclick="wSave('${fpath||''}','${title}')" title="Uložit">💾</button><button class="wt-btn" onclick="wExport()" title="Exportovat">📤</button><button class="wt-btn" onclick="window.print()" title="Tisk">🖨️</button></div></div><div class="word-canvas-wrap"><div class="word-page"><div class="word-editor" contenteditable="true" id="word-editor" onkeydown="if((event.ctrlKey||event.metaKey)&&event.key==='s'){event.preventDefault();wSave('${fpath||''}','${title}');}">${content.replace(/\n/g,'<br>')}</div></div></div></div>`;
    document.getElementById('word-editor')?.focus();
  });
}
function wSave(fpath,fname){const ed=document.getElementById('word-editor');if(!ed)return;const text=ed.innerText;const f=fname||'dokument.txt';const p=fpath||'/Documents/'+f;S.fs[p]={type:'file',ext:'txt',content:text};const dir=S.fs['/Documents'];if(dir&&!dir.children.includes(f))dir.children.push(f);saveState();notify('💾 Uloženo','"'+f+'" uložen.');}
function wExport(){const ed=document.getElementById('word-editor');if(!ed)return;const blob=new Blob([ed.innerText],{type:'text/plain;charset=utf-8'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='dokument.txt';a.click();}

// ================================================================
//   PHOTOS
// ================================================================
function openPhotos(){
  createWindow('photos','Fotky',780,560,body=>{
    body.innerHTML=`<div class="photos-wrap"><div class="photos-sidebar"><div style="padding:8px 12px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.6px;color:var(--text-sec)">Knihovna</div><div class="photos-nav active" onclick="showPhotosGrid()">🏛️ Vše</div><div class="photos-nav">❤️ Oblíbené</div><div class="photos-nav">📷 Screenshoty</div></div><div class="photos-main" id="photos-main"><div class="photos-year">2024</div><div class="photos-grid" id="photos-grid"></div></div></div>`;
    showPhotosGrid();
  });
}
function showPhotosGrid(){const grid=document.getElementById('photos-grid');if(!grid)return;grid.innerHTML=PHOTO_ITEMS.map((p,i)=>`<div class="photo-thumb" style="background:${p.bg}" onclick="viewPhoto(${i})" title="${p.name}">${p.emoji}</div>`).join('');}
function viewPhoto(idx){const p=PHOTO_ITEMS[idx];createWindow('pv-'+idx,p.name,540,420,body=>{body.innerHTML=`<div style="height:100%;display:flex;flex-direction:column"><div style="flex:1;display:flex;align-items:center;justify-content:center;background:${p.bg};font-size:120px">${p.emoji}</div><div style="padding:12px 16px;display:flex;justify-content:space-between;align-items:center"><span style="font-size:14px;font-weight:600;color:var(--text)">${p.name}</span><div style="display:flex;gap:8px"><button class="btn btn-sm" onclick="for(const[w,win]of Object.entries(WINS))if(win.appId==='pv-${idx}')closeWindow(w);viewPhoto(${(idx-1+PHOTO_ITEMS.length)%PHOTO_ITEMS.length})">‹</button><button class="btn btn-sm" onclick="for(const[w,win]of Object.entries(WINS))if(win.appId==='pv-${idx}')closeWindow(w);viewPhoto(${(idx+1)%PHOTO_ITEMS.length})">›</button><button class="btn btn-sm">❤️</button></div></div></div>`;});}
function openPhotosFile(fpath,name,fobj){createWindow('photos',name,540,420,body=>{body.innerHTML=`<div style="height:100%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#e8e8e8,#d0d0d0);font-size:80px;flex-direction:column;gap:16px">🖼️<div style="font-size:14px;color:#666">${name}</div></div>`;});}

// ================================================================
//   MAIL
// ================================================================
function openMail(){
  createWindow('mail','Mail',860,560,body=>{
    body.innerHTML=`<div class="mail-wrap"><div class="mail-sidebar"><div class="mail-box active">📥 Příchozí<span class="mail-cnt">${MAIL_MESSAGES.filter(m=>m.unread).length}</span></div><div class="mail-box">⭐ VIP</div><div class="mail-box">📝 Koncepty</div><div class="mail-box">📤 Odeslaná</div><div class="mail-box">🗑️ Smazaná</div></div><div class="mail-list">${MAIL_MESSAGES.map((m,i)=>`<div class="mail-item" onclick="showMailMessage(${i})"><div class="mail-sender">${m.unread?'<span style="color:var(--accent);font-size:8px;margin-right:4px">●</span>':''}<span>${m.from}</span><span class="mail-date">${m.date}</span></div><div class="mail-subject">${m.subject}</div><div class="mail-preview">${m.preview}</div></div>`).join('')}</div><div class="mail-viewer" id="mail-viewer"><div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--text-sec);font-size:14px">Vyberte email</div></div></div>`;
  });
}
function showMailMessage(idx){
  const m=MAIL_MESSAGES[idx];if(!m)return;
  const viewer=document.getElementById('mail-viewer');if(!viewer)return;
  viewer.innerHTML=`<div class="mv-subject">${m.subject}</div><div class="mv-meta"><div class="mv-avatar">${m.from[0]}</div><div class="mv-sender-info"><div class="mv-from">${m.from} &lt;${m.email}&gt;</div><div class="mv-to">Komu: mně · ${m.date}</div></div><div style="display:flex;gap:6px;margin-left:auto"><button class="btn btn-sm">↩ Odpovědět</button><button class="btn btn-sm">↪ Přeposlat</button><button class="btn btn-sm btn-danger">🗑</button></div></div><div class="mv-body">${m.body.replace(/\n/g,'<br>')}</div>`;
  document.querySelectorAll('.mail-item').forEach((el,i)=>el.classList.toggle('selected',i===idx));
}

// ================================================================
//   TRASH
// ================================================================
function openTrash(){createWindow('trash','Koš',540,440,body=>{renderTrashBody(body);});}
function renderTrashBody(body){if(!body)body=document.querySelector('.window[data-app="trash"] .win-body');if(!body)return;const items=S.trash;body.innerHTML=`<div class="trash-wrap"><div class="trash-header"><div class="trash-title">🗑️ Koš — ${items.length} položek</div><button class="btn btn-danger btn-sm" onclick="emptyTrash()">Vysypat koš</button></div><div class="trash-list">${items.length?items.map(it=>`<div class="trash-item"><div class="ti-icon">📄</div><div class="ti-info"><div class="ti-name">${it.name||it}</div><div class="ti-date">${it.date||''}</div></div><button class="btn btn-sm" onclick="restoreTrashItem('${it.name||it}')">Obnovit</button></div>`).join(''):'<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:200px;color:var(--text-sec);gap:12px"><div style="font-size:64px">🗑️</div><div>Koš je prázdný</div></div>'}</div></div>`;}
function emptyTrash(){const dir=S.fs['/Trash'];if(dir)dir.children.forEach(n=>delete S.fs['/Trash/'+n]);if(dir)dir.children=[];S.trash=[];saveState();renderTrashBody();notify('🗑️ Koš vysypán','Všechny položky byly trvale smazány.');}
function restoreTrashItem(name){S.trash=S.trash.filter(it=>(it.name||it)!==name);const fp='/Trash/'+name;const fobj=S.fs[fp];if(fobj){const dp='/Documents/'+name;S.fs[dp]=fobj;delete S.fs[fp];const dr=S.fs['/Documents'];if(dr&&!dr.children.includes(name))dr.children.push(name);const tr=S.fs['/Trash'];if(tr)tr.children=tr.children.filter(n=>n!==name);}saveState();renderTrashBody();notify('↩ Obnoveno',name+' obnoven do /Documents.');}

// ================================================================
//   SNAKE
// ================================================================
const SGRID=20,SCELL=18;let snakeState=null,snakeInt=null;
function openSnake(){
  createWindow('snake','🐍 Snake',440,530,body=>{
    body.innerHTML=`<div class="snake-wrap"><div class="snake-hud"><div class="snake-score-box"><div class="snake-score-label">Skóre</div><div class="snake-score-val" id="snake-score">0</div></div><div style="display:flex;flex-direction:column;gap:8px"><button class="btn btn-primary" id="snake-start-btn" onclick="snakeStart()">▶ Start</button><button class="btn" onclick="snakePause()">⏸ Pauza</button></div><div class="snake-score-box"><div class="snake-score-label">Rekord</div><div class="snake-score-val" id="snake-best">${localStorage.getItem('snake_best')||0}</div></div></div><canvas id="snake-canvas" width="${SGRID*SCELL}" height="${SGRID*SCELL}"></canvas><div class="snake-ctrl-hint">Šipky / WASD · Mezerník = Pauza</div></div>`;
    snakeInit();
  });
}
function snakeInit(){snakeState={snake:[{x:10,y:10},{x:9,y:10},{x:8,y:10}],dir:{x:1,y:0},nextDir:{x:1,y:0},food:snakeFood(),score:0,paused:false,running:false,dead:false,speed:150};snakeDraw();}
function snakeFood(){return{x:Math.floor(Math.random()*SGRID),y:Math.floor(Math.random()*SGRID)};}
function snakeStart(){if(!snakeState)snakeInit();if(snakeState.dead)snakeInit();snakeState.running=true;snakeState.paused=false;clearInterval(snakeInt);snakeInt=setInterval(snakeStep,snakeState.speed);document.getElementById('snake-start-btn').textContent='🔄 Restart';}
function snakePause(){if(!snakeState?.running)return;snakeState.paused=!snakeState.paused;if(snakeState.paused)clearInterval(snakeInt);else snakeInt=setInterval(snakeStep,snakeState.speed);snakeDraw();}
function snakeStep(){
  if(!snakeState||snakeState.paused||!snakeState.running)return;
  snakeState.dir=snakeState.nextDir;
  const h={x:snakeState.snake[0].x+snakeState.dir.x,y:snakeState.snake[0].y+snakeState.dir.y};
  if(h.x<0||h.x>=SGRID||h.y<0||h.y>=SGRID||snakeState.snake.some(s=>s.x===h.x&&s.y===h.y)){snakeDie();return;}
  snakeState.snake.unshift(h);
  if(h.x===snakeState.food.x&&h.y===snakeState.food.y){
    snakeState.score+=10;snakeState.food=snakeFood();
    if(snakeState.score%50===0&&snakeState.speed>60){snakeState.speed-=10;clearInterval(snakeInt);snakeInt=setInterval(snakeStep,snakeState.speed);}
    const sc=document.getElementById('snake-score');if(sc)sc.textContent=snakeState.score;
    const best=parseInt(localStorage.getItem('snake_best')||'0');if(snakeState.score>best){localStorage.setItem('snake_best',snakeState.score);const be=document.getElementById('snake-best');if(be)be.textContent=snakeState.score;}
  }else snakeState.snake.pop();
  snakeDraw();
}
function snakeDie(){clearInterval(snakeInt);snakeState.running=false;snakeState.dead=true;snakeDraw();notify('💀 Game Over','Skóre: '+snakeState.score+'. Stiskněte Start pro novou hru.');}
function snakeDraw(){
  const canvas=document.getElementById('snake-canvas');if(!canvas)return;
  const ctx=canvas.getContext('2d');const dark=document.body.classList.contains('dark');
  ctx.fillStyle=dark?'#1a1a2e':'#f0f0f8';ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle=dark?'rgba(255,255,255,0.03)':'rgba(0,0,0,0.04)';ctx.lineWidth=1;
  for(let i=0;i<=SGRID;i++){ctx.beginPath();ctx.moveTo(i*SCELL,0);ctx.lineTo(i*SCELL,canvas.height);ctx.stroke();ctx.beginPath();ctx.moveTo(0,i*SCELL);ctx.lineTo(canvas.width,i*SCELL);ctx.stroke();}
  if(!snakeState)return;
  // Food
  ctx.fillStyle='#ff3b30';ctx.beginPath();ctx.arc(snakeState.food.x*SCELL+SCELL/2,snakeState.food.y*SCELL+SCELL/2,SCELL/2-2,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#28c840';ctx.fillRect(snakeState.food.x*SCELL+SCELL/2-1,snakeState.food.y*SCELL+2,2,4);
  // Snake
  snakeState.snake.forEach((s,i)=>{
    ctx.fillStyle=snakeState.dead?`rgba(255,60,48,${1-i/snakeState.snake.length*0.4})`:`rgba(40,200,64,${1-i/snakeState.snake.length*0.4})`;
    if(i===0)ctx.fillStyle=snakeState.dead?'#ff3b30':'#28c840';
    ctx.beginPath();if(ctx.roundRect)ctx.roundRect(s.x*SCELL+2,s.y*SCELL+2,SCELL-4,SCELL-4,4);else ctx.rect(s.x*SCELL+2,s.y*SCELL+2,SCELL-4,SCELL-4);ctx.fill();
    if(i===0&&!snakeState.dead){ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(s.x*SCELL+5,s.y*SCELL+5,2,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(s.x*SCELL+SCELL-5,s.y*SCELL+5,2,0,Math.PI*2);ctx.fill();}
  });
  if(snakeState.dead){ctx.fillStyle='rgba(0,0,0,0.55)';ctx.fillRect(0,0,canvas.width,canvas.height);ctx.fillStyle='#fff';ctx.font='bold 24px Inter';ctx.textAlign='center';ctx.fillText('GAME OVER',canvas.width/2,canvas.height/2-16);ctx.font='16px Inter';ctx.fillText('Skóre: '+snakeState.score,canvas.width/2,canvas.height/2+16);}
  if(snakeState.paused&&!snakeState.dead){ctx.fillStyle='rgba(0,0,0,0.4)';ctx.fillRect(0,0,canvas.width,canvas.height);ctx.fillStyle='#fff';ctx.font='bold 28px Inter';ctx.textAlign='center';ctx.fillText('⏸ PAUZA',canvas.width/2,canvas.height/2);}
  if(!snakeState.running&&!snakeState.dead){ctx.fillStyle='rgba(0,0,0,0.3)';ctx.fillRect(0,0,canvas.width,canvas.height);ctx.fillStyle='#fff';ctx.font='bold 20px Inter';ctx.textAlign='center';ctx.fillText('Stiskněte ▶ Start',canvas.width/2,canvas.height/2);}
}
document.addEventListener('keydown',e=>{
  if(snakeState?.running&&!snakeState.paused){const d=snakeState.nextDir;if((e.key==='ArrowUp'||e.key==='w')&&d.y===0)snakeState.nextDir={x:0,y:-1};else if((e.key==='ArrowDown'||e.key==='s')&&d.y===0)snakeState.nextDir={x:0,y:1};else if((e.key==='ArrowLeft'||e.key==='a')&&d.x===0)snakeState.nextDir={x:-1,y:0};else if((e.key==='ArrowRight'||e.key==='d')&&d.x===0)snakeState.nextDir={x:1,y:0};}
  if(e.code==='Space'&&snakeState?.running){e.preventDefault();snakePause();}
});

// ================================================================
//   MEMORY GAME
// ================================================================
const MEMOJIS=['🍎','🚀','🌈','🎵','🦋','💻','🌺','🎮','🎸','🌍','🏆','💎','🐬','🌙','⚡','🎯'];
let memState=null,memTimerInt=null;
function openMemory(){
  createWindow('memory','🧠 Paměťová hra',500,580,body=>{
    body.innerHTML=`<div class="memory-wrap"><div class="memory-hud"><div class="memory-stat"><div class="memory-stat-label">Tahy</div><div class="memory-stat-val" id="mem-moves">0</div></div><div style="display:flex;gap:8px;align-items:center"><button class="btn btn-primary" onclick="memStart()">🔄 Nová hra</button><select class="btn" id="mem-diff" onchange="memStart()"><option value="8">Snadné 4×4</option><option value="12">Střední 6×4</option></select></div><div class="memory-stat"><div class="memory-stat-label">Čas</div><div class="memory-stat-val" id="mem-time">0:00</div></div></div><div id="memory-grid" style="display:grid;gap:10px;justify-content:center;margin-top:12px"></div></div>`;
    memStart();
  });
}
function memStart(){
  clearInterval(memTimerInt);
  const pairs=parseInt(document.getElementById('mem-diff')?.value||'8');
  const cols=pairs<=8?4:6;
  const emojis=MEMOJIS.slice(0,pairs);
  const cards=[...emojis,...emojis].sort(()=>Math.random()-0.5);
  memState={cards,flipped:[],matched:[],moves:0,startTime:Date.now(),cols};
  const grid=document.getElementById('memory-grid');if(!grid)return;
  grid.style.gridTemplateColumns=`repeat(${cols},80px)`;
  grid.innerHTML=cards.map((emoji,i)=>`<div class="mem-card" id="mc-${i}" onclick="memFlip(${i})" style="perspective:600px;cursor:pointer;transform-style:preserve-3d;position:relative;width:80px;height:80px;transition:transform 0.3s;border-radius:12px"><div class="mem-card-front" style="position:absolute;inset:0;border-radius:12px;display:flex;align-items:center;justify-content:center;background:var(--accent);font-size:28px;font-weight:700;color:#fff;backface-visibility:hidden;-webkit-backface-visibility:hidden">?</div><div class="mem-card-back" style="position:absolute;inset:0;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:36px;background:rgba(0,0,0,0.08);backface-visibility:hidden;-webkit-backface-visibility:hidden;transform:rotateY(180deg)">${emoji}</div></div>`).join('');
  const mv=document.getElementById('mem-moves');if(mv)mv.textContent='0';
  const tm=document.getElementById('mem-time');if(tm)tm.textContent='0:00';
  memTimerInt=setInterval(()=>{if(!memState)return;const el=document.getElementById('mem-time');if(el){const s=Math.floor((Date.now()-memState.startTime)/1000);el.textContent=secToTime(s);}},1000);
}
function memFlip(idx){
  if(!memState||memState.flipped.length>=2||memState.flipped.includes(idx)||memState.matched.includes(idx))return;
  memState.flipped.push(idx);
  document.getElementById('mc-'+idx).style.transform='rotateY(180deg)';
  if(memState.flipped.length===2){
    memState.moves++;const mv=document.getElementById('mem-moves');if(mv)mv.textContent=memState.moves;
    const[a,b]=memState.flipped;
    if(memState.cards[a]===memState.cards[b]){
      memState.matched.push(a,b);memState.flipped=[];
      document.getElementById('mc-'+a).style.background='rgba(52,199,89,0.15)';
      document.getElementById('mc-'+b).style.background='rgba(52,199,89,0.15)';
      if(memState.matched.length===memState.cards.length){clearInterval(memTimerInt);const el=Math.floor((Date.now()-memState.startTime)/1000);setTimeout(()=>notify('🎉 Výhra!','Dokončeno za '+memState.moves+' tahů a '+secToTime(el)+'!'),300);}
    }else{setTimeout(()=>{document.getElementById('mc-'+a).style.transform='';document.getElementById('mc-'+b).style.transform='';memState.flipped=[];},900);}
  }
}

// ================================================================
//   LAUNCHPAD
// ================================================================
function openLaunchpad(){buildLaunchpad();document.getElementById('launchpad').style.display='flex';setTimeout(()=>document.getElementById('lp-search')?.focus(),100);}
function buildLaunchpad(){
  const grid=document.getElementById('lp-grid');if(!grid)return;grid.innerHTML='';
  S.installedApps.filter(id=>id!=='finder'&&id!=='trash').forEach(appId=>{
    const app=APPS[appId];if(!app)return;
    const el=document.createElement('div');el.className='lp-item';el.dataset.appid=appId;
    el.innerHTML=`<div class="lp-icon" style="background:${app.bg}">${app.icon}</div><div class="lp-name">${app.name}</div>`;
    el.addEventListener('click',()=>{closeLaunchpad();openApp(appId);});
    el.addEventListener('contextmenu',e=>{
      e.preventDefault();e.stopPropagation();
      const isPinned=S.dockPinned.includes(appId);
      showCtxMenu(e,[
        {label:'🚀 Otevřít',action:()=>{closeLaunchpad();openApp(appId);}},
        null,
        {label:isPinned?'📌 Odebrat z Docku':'📌 Přidat do Docku',action:()=>{if(isPinned){S.dockPinned=S.dockPinned.filter(id=>id!==appId);}else{S.dockPinned.push(appId);}saveState();buildDock();notify(isPinned?'📌 Odebráno':'📌 Přidáno','');}},
        {label:'🖥️ Přidat na plochu',action:()=>addDesktopIcon(appId)},
      ]);
    });
    grid.appendChild(el);
  });
}
function filterLaunchpad(q){document.querySelectorAll('.lp-item').forEach(el=>{const name=el.querySelector('.lp-name')?.textContent?.toLowerCase()||'';const id=el.dataset.appid?.toLowerCase()||'';el.style.display=(!q||name.includes(q.toLowerCase())||id.includes(q.toLowerCase()))?'':'';}); }
function closeLaunchpad(){document.getElementById('launchpad').style.display='none';const si=document.getElementById('lp-search');if(si)si.value='';}
function closeLaunchpadIfOutside(e){if(e.target===document.getElementById('launchpad'))closeLaunchpad();}

// ================================================================
//   CONTEXT MENU
// ================================================================
function showCtxMenu(e,items){
  hideCtxMenu();hideDockCtx();
  const menu=document.getElementById('ctx-menu');
  menu.innerHTML=items.map(it=>it===null?`<div class="ctx-sep"></div>`:`<div class="ctx-item${it.disabled?' ctx-disabled':''}" data-label="${it.label}">${it.label}</div>`).join('');
  menu._actions={};items.filter(Boolean).forEach(it=>{if(it.action)menu._actions[it.label]=it.action;});
  menu.querySelectorAll('.ctx-item:not(.ctx-disabled)').forEach(el=>{el.addEventListener('click',()=>{const a=menu._actions[el.dataset.label];if(a)a();hideCtxMenu();});});
  menu.style.display='block';
  let x=e.clientX,y=e.clientY;
  if(x+210>window.innerWidth)x=window.innerWidth-215;
  if(y+menu.scrollHeight>window.innerHeight)y=window.innerHeight-menu.scrollHeight-10;
  menu.style.left=x+'px';menu.style.top=y+'px';
  setTimeout(()=>document.addEventListener('click',hideCtxMenu,{once:true}),10);
}
function hideCtxMenu(){const m=document.getElementById('ctx-menu');if(m){m.style.display='none';if(m._actions)m._actions={};}}
function ctxDesktop(e){
  e.preventDefault();
  if(e.target.closest('.window')||e.target.closest('#dock')||e.target.closest('#menubar')||e.target.closest('.desktop-icon'))return;
  showCtxMenu(e,[
    {label:'📁 Nová složka',action:()=>{const n=prompt('Název složky:');if(!n)return;const p='/Desktop/'+n;S.fs[p]={type:'dir',children:[]};const d=S.fs['/Desktop'];if(d&&!d.children.includes(n))d.children.push(n);saveState();}},
    {label:'📄 Nový textový soubor',action:()=>{const n=prompt('Název souboru:');if(!n)return;const fn=n.includes('.')?n:n+'.txt';const p='/Desktop/'+fn;S.fs[p]={type:'file',ext:getExt(fn),content:''};const d=S.fs['/Desktop'];if(d&&!d.children.includes(fn))d.children.push(fn);saveState();}},
    null,
    {label:'🎨 Změnit tapetu',action:()=>openSettings()},
    {label:'🌙 Přepnout Dark Mode',action:toggleDarkMode},
    null,
    {label:'🗂️ Otevřít Finder',action:()=>openApp('finder')},
    {label:'🔍 Spotlight',action:toggleSpotlight},
  ]);
}

// ================================================================
//   SPOTLIGHT
// ================================================================
function toggleSpotlight(){
  const wrap=document.getElementById('spotlight-wrap');if(!wrap)return;
  const vis=wrap.style.display==='flex';
  wrap.style.display=vis?'none':'flex';
  if(!vis){const inp=document.getElementById('spotlight-input');if(inp){inp.value='';inp.focus();}document.getElementById('spotlight-results').innerHTML='';}
}
function closeSpotlightIfOutside(e){if(e.target===document.getElementById('spotlight-wrap'))toggleSpotlight();}
function spotlightSearch(q){
  const res=document.getElementById('spotlight-results');if(!res)return;
  if(!q.trim()){res.innerHTML='';return;}
  const results=[];
  Object.entries(APPS).forEach(([id,app])=>{if(app.name.toLowerCase().includes(q.toLowerCase())&&S.installedApps.includes(id))results.push({icon:`<div class="sp-icon" style="background:${app.bg}">${app.icon}</div>`,name:app.name,sub:'Aplikace',action:()=>openApp(id)});});
  Object.keys(S.fs).forEach(k=>{const name=k.split('/').pop();if(name&&name.toLowerCase().includes(q.toLowerCase())&&S.fs[k].type==='file'){const icon=getFileIcon(name,S.fs[k].type);results.push({icon:`<div class="sp-icon" style="font-size:22px">${icon}</div>`,name,sub:k,action:()=>openFSFile(k,name)});}});
  if(!results.length)results.push({icon:'<div class="sp-icon">🌐</div>',name:'Hledat "'+q+'" na webu',sub:'Safari',action:()=>openSafari('https://www.google.com/search?q='+encodeURIComponent(q))});
  res._results=results;
  res.innerHTML=results.map((r,i)=>`<div class="sp-result ${i===0?'focused':''}" data-idx="${i}">${r.icon}<div class="sp-info"><div class="sp-name">${r.name}</div><div class="sp-sub">${r.sub}</div></div></div>`).join('');
  res.querySelectorAll('.sp-result').forEach(el=>{el.addEventListener('click',()=>{res._results[parseInt(el.dataset.idx)]?.action?.();toggleSpotlight();});});
}
function spotlightKeydown(e){
  const res=document.getElementById('spotlight-results');
  if(e.key==='Escape'){toggleSpotlight();return;}
  if(e.key==='Enter'){const f=res?.querySelector('.sp-result.focused');if(f&&res._results){res._results[parseInt(f.dataset.idx)]?.action?.();toggleSpotlight();}return;}
  if(e.key==='ArrowDown'||e.key==='ArrowUp'){
    const items=[...(res?.querySelectorAll('.sp-result')||[])];if(!items.length)return;
    const cur=res?.querySelector('.sp-result.focused');let idx=cur?items.indexOf(cur):-1;items[idx]?.classList.remove('focused');
    idx=e.key==='ArrowDown'?Math.min(idx+1,items.length-1):Math.max(idx-1,0);items[idx]?.classList.add('focused');
    e.preventDefault();
  }
}

// ================================================================
//   NOTIFICATIONS
// ================================================================
function notify(title,message,duration=4000){
  const container=document.getElementById('notif-container');if(!container)return;
  const n=document.createElement('div');n.className='notif';
  n.innerHTML=`<div class="notif-icon">${title.match(/[^\x00-\x7F]/)?.[0]||'ℹ️'}</div><div class="notif-body"><div class="notif-title">${title}</div>${message?`<div class="notif-msg">${message}</div>`:''}</div><div class="notif-close" onclick="this.parentElement.remove()">✕</div>`;
  container.appendChild(n);
  setTimeout(()=>{n.style.animation='notifOut 0.3s ease forwards';setTimeout(()=>n.remove(),300);},duration);
}

// ================================================================
//   SYSTEM
// ================================================================
// ================================================================
//   MENUBAR SYSTEM (FUNCTIONAL)
// ================================================================
let _mbOpen = null;

function mbToggle(id, btn, e) {
  e && e.stopPropagation();
  const el = document.getElementById(id);
  if (!el) return;
  // Close all first
  if (_mbOpen === id) {
    mbCloseAll();
    return;
  }
  mbCloseAll();
  el.classList.add('active');
  if (btn) btn.classList.add('mb-open');
  _mbOpen = id;
  // Update window list in Window menu
  if (id === 'win-dropdown') updateWinDropdownList();
  // Position left edge of dropdown to button left
  if (btn && !el.style.right) {
    const r = btn.getBoundingClientRect();
    el.style.left = r.left + 'px';
    el.style.right = 'auto';
  }
  setTimeout(() => document.addEventListener('click', mbCloseAll, {once:true}), 10);
}

function mbCloseAll() {
  document.querySelectorAll('.mb-menu-dropdown').forEach(d => d.classList.remove('active'));
  document.querySelectorAll('.mb-item, .mb-apple').forEach(b => b.classList.remove('mb-open'));
  _mbOpen = null;
}

function updateWinDropdownList() {
  const list = document.getElementById('win-dropdown-list');
  if (!list) return;
  const wins = Object.values(WINS);
  if (!wins.length) {
    list.innerHTML = '<div class="mbd-item disabled">Žádná okna</div>';
    return;
  }
  list.innerHTML = wins.map(w => `<div class="mbd-item" onclick="focusWindow('${Object.keys(WINS).find(k=>WINS[k]===w)}');mbCloseAll()">${w.minimized?'− ':''} ${w.title}</div>`).join('');
}

// Menubar actions
function mbNewFile() {
  mbCloseAll();
  const activeWinId = Object.keys(WINS).find(k => WINS[k]?.el?.style?.zIndex == Z);
  if (activeWinId) {
    const win = WINS[activeWinId];
    if (win.appId === 'finder') { createFinderFile(); return; }
    if (win.appId === 'notes') { notesNew(); return; }
  }
  const n = prompt('Název nového souboru (s příponou):');
  if (!n) return;
  const fpath = '/Desktop/' + n;
  S.fs[fpath] = {type:'file', ext:getExt(n), content:''};
  const d = S.fs['/Desktop'];
  if (d && !d.children.includes(n)) d.children.push(n);
  saveState(); renderDesktopIcons();
  notify('📄 Nový soubor', n + ' vytvořen na ploše.');
}

function mbOpenFile() {
  mbCloseAll();
  openApp('finder');
}

function mbSaveFile() {
  mbCloseAll();
  // Find active editable window
  const editor = document.querySelector('.word-editor, .notes-editor');
  if (editor) {
    const name = prompt('Uložit jako:') || 'dokument.txt';
    const blob = new Blob([editor.textContent || editor.innerText], {type:'text/plain'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name;
    a.click();
    notify('💾 Uloženo', name + ' byl stažen.');
  } else {
    notify('💾 Uložit', 'Žádný dokument k uložení.');
  }
}

function mbPrintFile() {
  mbCloseAll();
  window.print();
}

function mbMinimizeFront() {
  mbCloseAll();
  const wid = Object.keys(WINS).reduce((best, k) => {
    const z = parseInt(WINS[k]?.el?.style?.zIndex || 0);
    return z > (parseInt(WINS[best]?.el?.style?.zIndex || 0)) ? k : best;
  }, Object.keys(WINS)[0]);
  if (wid) minimizeWindow(wid);
}

function mbZoomFront() {
  mbCloseAll();
  const wid = Object.keys(WINS).reduce((best, k) => {
    const z = parseInt(WINS[k]?.el?.style?.zIndex || 0);
    return z > (parseInt(WINS[best]?.el?.style?.zIndex || 0)) ? k : best;
  }, Object.keys(WINS)[0]);
  if (wid) toggleMaxWin(wid);
}

function mbCloseFront() {
  mbCloseAll();
  const wid = Object.keys(WINS).reduce((best, k) => {
    const z = parseInt(WINS[k]?.el?.style?.zIndex || 0);
    return z > (parseInt(WINS[best]?.el?.style?.zIndex || 0)) ? k : best;
  }, Object.keys(WINS)[0]);
  if (wid) closeWindow(wid);
}

function mbEnterFullscreen() {
  mbCloseAll();
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen?.();
  } else {
    document.exitFullscreen?.();
  }
}

function mbTileWindows() {
  mbCloseAll();
  const wins = Object.keys(WINS).filter(k => !WINS[k].minimized);
  if (!wins.length) return;
  const cols = Math.ceil(Math.sqrt(wins.length));
  const rows = Math.ceil(wins.length / cols);
  const w = Math.floor(window.innerWidth / cols);
  const h = Math.floor((window.innerHeight - 28 - 90) / rows);
  wins.forEach((wid, i) => {
    const col = i % cols, row = Math.floor(i / cols);
    const el = WINS[wid].el;
    el.style.left = (col * w) + 'px';
    el.style.top = (28 + row * h) + 'px';
    el.style.width = w + 'px';
    el.style.height = h + 'px';
  });
}

function toggleMissionControl() {
  mbCloseAll();
  // Simple mission control: scale down all windows
  const wins = Object.values(WINS).filter(w => !w.minimized);
  if (document.body.dataset.mc === '1') {
    wins.forEach(w => { w.el.style.transition = 'all 0.4s ease'; w.el.style.transform = ''; });
    document.body.dataset.mc = '0';
    setTimeout(() => wins.forEach(w => w.el.style.transition = ''), 400);
  } else {
    wins.forEach(w => { w.el.style.transition = 'all 0.4s ease'; w.el.style.transform = 'scale(0.5) translateY(-20%)'; });
    document.body.dataset.mc = '1';
    notify('🖥️ Mission Control', 'Klikni na okno nebo znovu Mission Control pro obnovení.');
    setTimeout(() => wins.forEach(w => w.el.style.transition = ''), 400);
  }
}

function lockScreen() {
  const lock = document.createElement('div');
  lock.id = 'lock-screen';
  lock.style.cssText = `position:fixed;inset:0;z-index:99999;background:#000;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;cursor:pointer;`;
  lock.innerHTML = `<div style="font-size:70px;opacity:0.8">🔒</div><div id="lock-clock" style="font-size:72px;font-weight:100;color:#fff;letter-spacing:-4px"></div><div style="font-size:18px;color:rgba(255,255,255,0.6)">${new Date().toLocaleDateString('cs-CZ',{weekday:'long',month:'long',day:'numeric'})}</div><div style="font-size:13px;color:rgba(255,255,255,0.4);margin-top:20px">Klikni pro odemknutí</div>`;
  document.body.appendChild(lock);
  const lc = () => { const n = new Date(); lock.querySelector('#lock-clock').textContent = n.toLocaleTimeString('cs-CZ',{hour:'2-digit',minute:'2-digit'}); };
  lc(); const lockInt = setInterval(lc, 1000);
  lock.addEventListener('click', () => { clearInterval(lockInt); lock.remove(); });
}

function cycleWallpaper() {
  const keys = Object.keys(WALLPAPERS);
  const cur = keys.indexOf(S.wallpaper);
  S.wallpaper = keys[(cur + 1) % keys.length];
  applyWallpaper();
  saveState();
  notify('🖼️ Tapeta', WALLPAPERS[S.wallpaper].label);
}

// Control Center toggle
function toggleControlCenter(e) {
  e && e.stopPropagation();
  const cc = document.getElementById('control-center');
  if (!cc) return;
  const vis = cc.style.display === 'block';
  mbCloseAll();
  cc.style.display = vis ? 'none' : 'block';
  if (!vis) {
    updateCCDarkmode();
    setTimeout(() => document.addEventListener('click', () => { cc.style.display='none'; }, {once:true}), 10);
  }
}
function toggleCCWifi() {
  const btn = document.getElementById('cc-wifi');
  btn.classList.toggle('on');
  const on = btn.classList.contains('on');
  document.getElementById('mb-wifi-icon').innerHTML = on ? '<i class="fas fa-wifi" style="font-size:12px"></i>' : '<i class="fas fa-wifi-slash" style="font-size:12px;opacity:0.4"></i>';
}
function toggleCCBtn(id) { document.getElementById(id)?.classList.toggle('on'); }
function toggleCCDarkmode() { toggleDarkMode(); updateCCDarkmode(); }
function updateCCDarkmode() { const btn = document.getElementById('cc-darkmode'); if (btn) btn.classList.toggle('on', S.darkMode); }

// Notification Center
function toggleNotifCenter() {
  const nc = document.getElementById('notif-center');
  if (!nc) return;
  nc.classList.toggle('open');
  updateNCClock();
}
function updateNCClock() {
  const nc = document.getElementById('nc-clock-big');
  const nd = document.getElementById('nc-date-label');
  const cal = document.getElementById('nc-calendar-label');
  const now = new Date();
  if (nc) nc.textContent = now.toLocaleTimeString('cs-CZ',{hour:'2-digit',minute:'2-digit'});
  if (nd) nd.textContent = now.toLocaleDateString('cs-CZ',{weekday:'long',day:'numeric',month:'long'});
  if (cal) cal.textContent = now.toLocaleDateString('cs-CZ',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
}
setInterval(updateNCClock, 1000);

// ================================================================
//   MUSIC PLAYER – APPLE MUSIC STYLE WITH MP3 SUPPORT
// ================================================================

// ================================================================
//   SYSTEM FUNCTIONS
// ================================================================
function toggleDarkMode(){S.darkMode=!S.darkMode;document.body.classList.toggle('dark',S.darkMode);saveState();updateCCDarkmode();}
function applyDarkMode(){document.body.classList.toggle('dark',S.darkMode);}
function restartConfirm(){if(confirm('Restartovat systém? Všechna neuložená data budou ztracena.'))resetSystem();}
function resetSystem(){if(confirm('Opravdu chcete smazat všechna data a začít znovu?')){localStorage.removeItem('macos24_v4');location.reload();}}
function aboutMac(){mbCloseAll();createWindow('about-mac','O tomto Macu',420,320,body=>{body.innerHTML=`<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:16px;padding:30px"><div style="font-size:80px">🍎</div><div style="text-align:center"><div style="font-size:24px;font-weight:700;color:var(--text)">AiOS — macOS Sonoma</div><div style="color:var(--text-sec);font-size:13px;margin-top:4px">Verze 14.6 Enhanced Edition</div><div style="color:var(--text-sec);font-size:12px;margin-top:2px">Simulace v prohlížeči</div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px;width:100%;max-width:320px"><div style="background:rgba(0,0,0,0.05);border-radius:8px;padding:10px;text-align:center"><div style="color:var(--text-sec)">Procesor</div><div style="font-weight:600;color:var(--text)">Apple M3 Pro</div></div><div style="background:rgba(0,0,0,0.05);border-radius:8px;padding:10px;text-align:center"><div style="color:var(--text-sec)">Paměť</div><div style="font-weight:600;color:var(--text)">18 GB</div></div><div style="background:rgba(0,0,0,0.05);border-radius:8px;padding:10px;text-align:center"><div style="color:var(--text-sec)">Úložiště</div><div style="font-weight:600;color:var(--text)">512 GB SSD</div></div><div style="background:rgba(0,0,0,0.05);border-radius:8px;padding:10px;text-align:center"><div style="color:var(--text-sec)">GPU</div><div style="font-weight:600;color:var(--text)">18-core GPU</div></div></div></div>`; });}

// ================================================================
//   SELECTION BOX
// ================================================================
let _sel=null;
function selStart(e){
  if(e.target!==document.getElementById('desktop')&&!e.target.id.includes('desktop-icons'))return;
  if(e.button!==0)return;mbCloseAll();hideCtxMenu();
  _sel={sx:e.clientX,sy:e.clientY};
  const box=document.getElementById('sel-box');
  box.style.display='block';box.style.left=e.clientX+'px';box.style.top=e.clientY+'px';box.style.width='0';box.style.height='0';
  document.addEventListener('mousemove',selMove,{passive:true});
  document.addEventListener('mouseup',selEnd);
}
function selMove(e){if(!_sel)return;const box=document.getElementById('sel-box');const x=Math.min(e.clientX,_sel.sx),y=Math.min(e.clientY,_sel.sy);box.style.left=x+'px';box.style.top=y+'px';box.style.width=Math.abs(e.clientX-_sel.sx)+'px';box.style.height=Math.abs(e.clientY-_sel.sy)+'px';}
function selEnd(){_sel=null;document.getElementById('sel-box').style.display='none';document.removeEventListener('mousemove',selMove);document.removeEventListener('mouseup',selEnd);}

// ================================================================
//   TERMINAL APP
// ================================================================
let termHistory = [];
let termHistIdx = -1;
const TERM_FS_ROOT = {
  '~': ['Documents', 'Downloads', 'Desktop', 'Applications', '.bash_profile'],
  '~/Documents': ['projekt.txt', 'notes.md', 'readme.md'],
  '~/Downloads': ['file1.zip', 'photo.jpg'],
  '~/Desktop': [],
};
let termCWD = '~';

const TERM_COMMANDS = {
  help: () => `Dostupné příkazy:
  ls          - seznam souborů
  cd <dir>    - změna adresáře
  pwd         - aktuální adresář
  echo <text> - výpis textu
  clear       - vyčistit terminál
  mkdir <dir> - vytvoření adresáře
  touch <f>   - vytvoření souboru
  rm <f>      - odstranění souboru
  cat <f>     - zobrazení souboru
  date        - aktuální datum/čas
  whoami      - aktuální uživatel
  uname       - systémové info
  history     - historie příkazů
  fortune     - náhodný citát
  matrix      - matrix efekt
  cowsay <t>  - moo!
  cal         - kalendář`,

  ls: (args) => {
    const dir = TERM_FS_ROOT[termCWD] || [];
    return dir.length ? dir.map(f => f.endsWith('/') ? `\x1b[34m${f}\x1b[0m` : f).join('  ') : '(prázdno)';
  },

  pwd: () => termCWD.replace('~', '/Users/admin'),

  cd: (args) => {
    const target = args[0];
    if (!target || target === '~' || target === '..') { termCWD = '~'; return ''; }
    const full = termCWD + '/' + target;
    if (TERM_FS_ROOT[full] !== undefined) { termCWD = full; return ''; }
    return `bash: cd: ${target}: No such file or directory`;
  },

  echo: (args) => args.join(' '),

  clear: () => { setTimeout(() => { const tb = document.getElementById('term-body'); if (tb) tb.innerHTML = ''; }, 0); return null; },

  mkdir: (args) => {
    if (!args[0]) return 'mkdir: missing operand';
    if (!TERM_FS_ROOT[termCWD]) TERM_FS_ROOT[termCWD] = [];
    TERM_FS_ROOT[termCWD].push(args[0] + '/');
    return '';
  },

  touch: (args) => {
    if (!args[0]) return 'touch: missing operand';
    if (!TERM_FS_ROOT[termCWD]) TERM_FS_ROOT[termCWD] = [];
    TERM_FS_ROOT[termCWD].push(args[0]);
    return '';
  },

  rm: (args) => {
    if (!args[0]) return 'rm: missing operand';
    if (TERM_FS_ROOT[termCWD]) {
      const idx = TERM_FS_ROOT[termCWD].indexOf(args[0]);
      if (idx >= 0) { TERM_FS_ROOT[termCWD].splice(idx, 1); return ''; }
    }
    return `rm: cannot remove '${args[0]}': No such file`;
  },

  cat: (args) => {
    if (!args[0]) return 'cat: missing operand';
    const contents = {
      '.bash_profile': '# Bash profile\nexport PATH="/usr/local/bin:$PATH"\nalias ll="ls -la"\nalias cls="clear"',
      'projekt.txt': 'Projekt AiOS v2.0\n================\nVylepšená simulace macOS v prohlížeči.',
      'notes.md': '# Poznámky\n\n- Dokončit frontend\n- Přidat nové aplikace\n- Otestovat vše',
      'readme.md': '# README\n\nAiOS – Apple-inspired OS Simulator\n\nPůjčuje si designové prvky z macOS.',
    };
    return contents[args[0]] || `cat: ${args[0]}: No such file or directory`;
  },

  date: () => new Date().toLocaleString('cs-CZ', {weekday:'long', year:'numeric', month:'long', day:'numeric', hour:'2-digit', minute:'2-digit', second:'2-digit'}),

  whoami: () => 'admin',

  uname: (args) => {
    if (args[0] === '-a') return 'AiOS 14.6.0 Enhanced RELEASE arm64';
    return 'AiOS';
  },

  history: () => termHistory.slice(-20).map((h,i) => `  ${i+1}  ${h}`).join('\n') || '(prázdná historie)',

  fortune: () => {
    const fortunes = [
      '"Nejlepší způsob, jak předpovědět budoucnost, je vytvořit ji." – Alan Kay',
      '"Jakákoli dostatečně vyspělá technologie je k nerozeznání od magie." – Arthur C. Clarke',
      '"Design není jen to, jak to vypadá. Design je to, jak to funguje." – Steve Jobs',
      '"The computer was born to solve problems that did not exist before." – Bill Gates',
      '"Code is poetry." – WordPress motto',
      '"Jednoduchost je konečná sofistikovanost." – Leonardo da Vinci',
      '"Make it work, make it right, make it fast." – Kent Beck',
    ];
    return fortunes[Math.floor(Math.random() * fortunes.length)];
  },

  matrix: () => {
    const tb = document.getElementById('term-body');
    if (!tb) return '';
    let mc = '';
    const chars = 'アイウエオカキクケコサシスセソタチツテトナニヌネノ0123456789';
    for (let i = 0; i < 10; i++) {
      let line = '';
      for (let j = 0; j < 60; j++) line += chars[Math.floor(Math.random() * chars.length)];
      mc += `<div class="terminal-line" style="color:#0f0">${line}</div>`;
    }
    setTimeout(() => { const t = document.getElementById('term-body'); if (t) t.innerHTML += mc; }, 0);
    return null;
  },

  cowsay: (args) => {
    const text = args.join(' ') || 'Moo!';
    const line = '-'.repeat(text.length + 2);
    return `  +${line}+\n  | ${text} |\n  +${line}+\n       \\   ^__^\n        \\  (oo)\\_____\n           (__)\\       )\\/\\\n               ||----w |\n               ||     ||`;
  },

  cal: () => {
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth();
    const days = ['Ne', 'Po', 'Út', 'St', 'Čt', 'Pá', 'So'];
    const months = ['Leden','Únor','Březen','Duben','Květen','Červen','Červenec','Srpen','Září','Říjen','Listopad','Prosinec'];
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    let cal = `      ${months[month]} ${year}\n${days.join('  ')}\n`;
    let cells = Array(firstDay).fill('  ');
    for (let d = 1; d <= daysInMonth; d++) cells.push(d < 10 ? ' ' + d : String(d));
    while (cells.length % 7 !== 0) cells.push('  ');
    for (let i = 0; i < cells.length; i += 7) cal += cells.slice(i, i+7).join('  ') + '\n';
    return cal;
  },
};

function openTerminal() {
  createWindow('terminal', 'Terminál', 680, 460, body => {
    body.innerHTML = `
      <div class="terminal-wrap">
        <div class="terminal-titlebar">
          <span style="font-size:9px;color:#3fb950">●</span>
          <span style="font-size:9px;color:#e3b341">●</span>
          <span style="font-size:9px;color:#f85149">●</span>
          <span style="margin-left:6px">admin@AiOS: ${termCWD}</span>
        </div>
        <div class="terminal-body" id="term-body">
          <div class="terminal-line" style="color:#8b9094">Vítej v AiOS Terminálu. Napiš 'help' pro seznam příkazů.</div>
          <div class="terminal-line" style="color:#8b9094">──────────────────────────────────────────────────</div>
        </div>
        <div class="terminal-input-row">
          <span class="terminal-input-prompt" id="term-prompt">admin@AiOS:${termCWD}$ </span>
          <input class="terminal-input" id="term-input" placeholder="..." autocomplete="off" spellcheck="false"
            onkeydown="termKeydown(event)">
        </div>
      </div>`;
    document.getElementById('term-input')?.focus();
  });
}

function termKeydown(e) {
  const input = document.getElementById('term-input');
  if (!input) return;
  if (e.key === 'Enter') {
    const cmd = input.value.trim();
    if (!cmd) { termAppend('', ''); return; }
    termHistory.push(cmd);
    termHistIdx = termHistory.length;
    termAppend(`admin@AiOS:${termCWD}$ `, cmd, 'prompt');
    const [command, ...args] = cmd.split(/\s+/);
    const fn = TERM_COMMANDS[command];
    if (fn) {
      const result = fn(args);
      if (result !== null && result !== undefined && result !== '') {
        const isError = result.includes('No such file') || result.includes('missing') || result.includes('bash:');
        result.split('\n').forEach(line => termAppend('', line, isError ? 'error' : 'output'));
      }
    } else {
      termAppend('', `bash: ${command}: command not found`, 'error');
    }
    input.value = '';
    updateTermPrompt();
    const tb = document.getElementById('term-body');
    if (tb) tb.scrollTop = tb.scrollHeight;
  } else if (e.key === 'ArrowUp') {
    if (termHistIdx > 0) { termHistIdx--; input.value = termHistory[termHistIdx]; }
    e.preventDefault();
  } else if (e.key === 'ArrowDown') {
    if (termHistIdx < termHistory.length - 1) { termHistIdx++; input.value = termHistory[termHistIdx]; }
    else { termHistIdx = termHistory.length; input.value = ''; }
    e.preventDefault();
  } else if (e.key === 'Tab') {
    e.preventDefault();
    const partial = input.value;
    const matches = Object.keys(TERM_COMMANDS).filter(k => k.startsWith(partial));
    if (matches.length === 1) input.value = matches[0] + ' ';
    else if (matches.length > 1) termAppend('', matches.join('  '), 'output');
  } else if (e.key === 'l' && e.ctrlKey) {
    e.preventDefault();
    const tb = document.getElementById('term-body');
    if (tb) tb.innerHTML = '';
  }
}

function termAppend(prefix, text, type = 'output') {
  const tb = document.getElementById('term-body');
  if (!tb) return;
  const line = document.createElement('div');
  line.className = 'terminal-line';
  if (type === 'prompt') {
    line.innerHTML = `<span class="terminal-prompt">${prefix}</span><span>${text}</span>`;
  } else if (type === 'error') {
    line.classList.add('terminal-error');
    line.textContent = text;
  } else {
    line.classList.add('terminal-success');
    line.textContent = text;
  }
  tb.appendChild(line);
}

function updateTermPrompt() {
  const p = document.getElementById('term-prompt');
  if (p) p.textContent = `admin@AiOS:${termCWD}$ `;
}

// ================================================================
//   NOTES APP
// ================================================================
let notesCurrentId = null;

function openNotes() {
  notesCurrentId = S.notesCurrentId || (S.notes && S.notes[0]?.id) || null;
  createWindow('notes', 'Poznámky', 680, 500, body => {
    body.innerHTML = `
      <div class="notes-wrap">
        <div class="notes-sidebar">
          <div class="notes-toolbar">
            <button class="btn btn-primary btn-sm" onclick="notesNew()" title="Nová poznámka">✏️</button>
            <button class="btn btn-sm" onclick="notesDelete()" title="Smazat">🗑️</button>
            <input class="input" style="flex:1;font-size:11px;padding:4px 8px" placeholder="Hledat..." oninput="notesSearch(this.value)">
          </div>
          <div class="notes-list" id="notes-list"></div>
        </div>
        <div class="notes-main">
          <div class="notes-main-toolbar">
            <button class="btn btn-sm" onclick="document.execCommand('bold')" style="font-weight:700">B</button>
            <button class="btn btn-sm" onclick="document.execCommand('italic')" style="font-style:italic">I</button>
            <button class="btn btn-sm" onclick="document.execCommand('underline')" style="text-decoration:underline">U</button>
            <button class="btn btn-sm" onclick="document.execCommand('insertUnorderedList')">• Odrážky</button>
            <button class="btn btn-sm" onclick="document.execCommand('insertOrderedList')">1. Seznam</button>
            <button class="btn btn-sm" onclick="notesExport()">💾 Uložit</button>
          </div>
          <div class="notes-editor" id="notes-editor" contenteditable="true" oninput="notesAutoSave()"></div>
        </div>
      </div>`;
    renderNotesList();
    if (notesCurrentId) loadNote(notesCurrentId);
  });
}

function renderNotesList(filter='') {
  const list = document.getElementById('notes-list');
  if (!list) return;
  const notes = S.notes || [];
  const filtered = filter ? notes.filter(n => n.title.toLowerCase().includes(filter) || (n.content||'').toLowerCase().includes(filter)) : notes;
  list.innerHTML = filtered.length ? filtered.map(n => `
    <div class="note-item ${n.id === notesCurrentId ? 'active' : ''}" onclick="loadNote(${n.id})" id="ni-${n.id}">
      <div class="note-item-title">${n.title || 'Bez názvu'}</div>
      <div class="note-item-preview">${(n.content || '').substring(0, 60)}</div>
      <div class="note-item-date">${n.date || 'Dnes'}</div>
    </div>`).join('') : '<div style="padding:16px;color:var(--text-sec);font-size:13px">Žádné poznámky</div>';
}

function loadNote(id) {
  notesCurrentId = id;
  S.notesCurrentId = id;
  const note = (S.notes || []).find(n => n.id === id);
  if (!note) return;
  const editor = document.getElementById('notes-editor');
  if (editor) editor.innerHTML = note.content || '';
  document.querySelectorAll('.note-item').forEach(e => e.classList.toggle('active', parseInt(e.id.split('-')[1]) === id));
}

function notesNew() {
  const maxId = Math.max(0, ...(S.notes || []).map(n => n.id));
  const note = {id: maxId + 1, title: 'Nová poznámka', content: '', date: new Date().toLocaleDateString('cs-CZ')};
  S.notes = S.notes || [];
  S.notes.unshift(note);
  saveState();
  renderNotesList();
  loadNote(note.id);
  setTimeout(() => document.getElementById('notes-editor')?.focus(), 100);
}

function notesAutoSave() {
  if (!notesCurrentId) return;
  const editor = document.getElementById('notes-editor');
  if (!editor) return;
  const content = editor.innerText || '';
  const note = (S.notes || []).find(n => n.id === notesCurrentId);
  if (!note) return;
  note.content = editor.innerHTML;
  note.title = content.split('\n')[0].substring(0, 50) || 'Bez názvu';
  note.date = new Date().toLocaleDateString('cs-CZ');
  saveState();
  const ni = document.getElementById('ni-' + notesCurrentId);
  if (ni) {
    const tt = ni.querySelector('.note-item-title');
    const pr = ni.querySelector('.note-item-preview');
    if (tt) tt.textContent = note.title;
    if (pr) pr.textContent = content.substring(0, 60);
  }
}

function notesDelete() {
  if (!notesCurrentId) return;
  if (!confirm('Smazat tuto poznámku?')) return;
  S.notes = (S.notes || []).filter(n => n.id !== notesCurrentId);
  notesCurrentId = S.notes[0]?.id || null;
  saveState();
  renderNotesList();
  if (notesCurrentId) loadNote(notesCurrentId);
  else { const e = document.getElementById('notes-editor'); if (e) e.innerHTML = ''; }
}

function notesSearch(q) { renderNotesList(q.toLowerCase()); }

function notesExport() {
  const note = (S.notes || []).find(n => n.id === notesCurrentId);
  if (!note) return;
  const blob = new Blob([note.content.replace(/<[^>]+>/g,'\n')], {type:'text/plain'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = (note.title || 'poznámka') + '.txt'; a.click();
}

// ================================================================
//   MAPS APP
// ================================================================
const MAPS_PLACES = [
  {name:'Praha, Česko', lat:50.08, lng:14.43, emoji:'🏙️', desc:'Hlavní město České republiky'},
  {name:'Brno', lat:49.19, lng:16.61, emoji:'🏛️', desc:'Druhé největší město ČR'},
  {name:'Ostrava', lat:49.83, lng:18.29, emoji:'🏭', desc:'Průmyslové centrum Moravy'},
  {name:'Plzeň', lat:49.74, lng:13.37, emoji:'🍺', desc:'Město proslulé pivem'},
  {name:'Eiffelova věž, Paříž', lat:48.86, lng:2.29, emoji:'🗼', desc:'Ikonická věž v Paříži'},
  {name:'Londýn, UK', lat:51.51, lng:-0.13, emoji:'🎡', desc:'Hlavní město Spojeného království'},
  {name:'New York, USA', lat:40.71, lng:-74.00, emoji:'🗽', desc:'Největší město USA'},
  {name:'Tokio, Japonsko', lat:35.68, lng:139.69, emoji:'⛩️', desc:'Hlavní město Japonska'},
];

function openMaps() {
  createWindow('maps', 'Mapy', 780, 560, body => {
    body.innerHTML = `
      <div class="maps-wrap">
        <div class="maps-search-bar">
          <span style="font-size:16px">🔍</span>
          <input class="maps-input" id="maps-input" placeholder="Hledat místo..." oninput="mapsSearch(this.value)" onkeydown="if(event.key==='Enter')mapsSearchGo()">
          <button class="btn btn-primary btn-sm" onclick="mapsSearchGo()">Hledat</button>
        </div>
        <div class="maps-canvas" id="maps-canvas">
          <div class="maps-grid-overlay"></div>
          <!-- Roads -->
          <div class="maps-road-h" style="top:30%;left:0;width:100%"></div>
          <div class="maps-road-h" style="top:50%;left:0;width:100%"></div>
          <div class="maps-road-h" style="top:70%;left:0;width:100%"></div>
          <div class="maps-road-v" style="left:25%;top:0;height:100%"></div>
          <div class="maps-road-v" style="left:50%;top:0;height:100%"></div>
          <div class="maps-road-v" style="left:75%;top:0;height:100%"></div>
          <!-- Buildings -->
          <div class="maps-building" style="width:60px;height:40px;top:20%;left:10%"></div>
          <div class="maps-building" style="width:40px;height:60px;top:35%;left:35%"></div>
          <div class="maps-building" style="width:80px;height:50px;top:55%;left:60%"></div>
          <div class="maps-building" style="width:50px;height:70px;top:20%;left:70%"></div>
          <div class="maps-building" style="width:90px;height:35px;top:65%;left:15%"></div>
          <div class="maps-pin" id="maps-pin">📍</div>
          <div class="maps-info-panel" id="maps-info"></div>
        </div>
        <div style="background:var(--bg-glass);backdrop-filter:blur(20px);border-top:1px solid var(--border);padding:8px 16px;display:flex;gap:8px;flex-wrap:wrap">
          ${MAPS_PLACES.map(p => `<button class="btn btn-sm" onclick="mapsShowPlace('${p.name}','${p.emoji}','${p.desc}')">${p.emoji} ${p.name}</button>`).join('')}
        </div>
      </div>`;
  });
}

function mapsSearch(q) {
  // Live search preview — filter places
  if (!q) return;
}

function mapsSearchGo() {
  const q = document.getElementById('maps-input')?.value?.trim() || '';
  if (!q) return;
  const found = MAPS_PLACES.find(p => p.name.toLowerCase().includes(q.toLowerCase()));
  if (found) mapsShowPlace(found.name, found.emoji, found.desc);
  else {
    mapsShowPlace(q, '📍', 'Výsledky hledání');
  }
}

function mapsShowPlace(name, emoji, desc) {
  const pin = document.getElementById('maps-pin');
  const info = document.getElementById('maps-info');
  if (pin) {
    pin.textContent = emoji;
    pin.style.animation = 'none';
    setTimeout(() => { pin.style.animation = ''; pin.style.animation = 'mapPinBounce 0.8s ease'; }, 10);
    // Random position on map
    pin.style.left = (25 + Math.random() * 50) + '%';
    pin.style.top = (25 + Math.random() * 50) + '%';
  }
  if (info) {
    info.innerHTML = `
      <div style="display:flex;align-items:center;gap:12px">
        <span style="font-size:28px">${emoji}</span>
        <div>
          <div style="font-size:15px;font-weight:700;color:var(--text)">${name}</div>
          <div style="font-size:12px;color:var(--text-sec)">${desc}</div>
        </div>
        <button class="btn btn-primary btn-sm" onclick="openSafari('https://maps.google.com/?q='+encodeURIComponent('${name}'))" style="margin-left:auto">🗺️ Google Maps</button>
      </div>`;
    info.classList.add('visible');
  }
}

// ================================================================
//   CLOCK APP
// ================================================================
let clockInterval = null;
let stopwatchRunning = false;
let stopwatchStart = 0;
let stopwatchElapsed = 0;
let stopwatchLaps = [];
let stopwatchInterval = null;

function openClock() {
  createWindow('clock', 'Hodiny', 500, 520, body => {
    body.innerHTML = `
      <div class="clock-wrap">
        <div class="clock-tabs">
          <div class="clock-tab active" id="ct-analog" onclick="clockTab('analog',this)">🕐 Hodiny</div>
          <div class="clock-tab" id="ct-world" onclick="clockTab('world',this)">🌍 Světový čas</div>
          <div class="clock-tab" id="ct-stop" onclick="clockTab('stop',this)">⏱ Stopky</div>
        </div>
        <div class="clock-body" id="clock-body"></div>
      </div>`;
    clockTab('analog', document.getElementById('ct-analog'));
  });
}

function clockTab(tab, el) {
  document.querySelectorAll('.clock-tab').forEach(t => t.classList.remove('active'));
  if (el) el.classList.add('active');
  clearInterval(clockInterval);
  const body = document.getElementById('clock-body');
  if (!body) return;

  if (tab === 'analog') {
    body.innerHTML = `
      <div class="analog-clock-wrap">
        <div style="font-size:13px;color:var(--text-sec);font-weight:500" id="analog-date-label"></div>
        <div class="analog-clock" id="analog-clock">
          ${Array.from({length:60}, (_,i) => `<div class="clock-tick ${i%5===0?'major':''}" style="transform:rotate(${i*6}deg)"></div>`).join('')}
          <div class="clock-hand clock-hand-hour" id="hand-h"></div>
          <div class="clock-hand clock-hand-min" id="hand-m"></div>
          <div class="clock-hand clock-hand-sec" id="hand-s"></div>
          <div class="clock-center-dot"></div>
        </div>
        <div style="font-size:36px;font-weight:200;color:var(--text);letter-spacing:-1px" id="digital-clock"></div>
        <div style="display:flex;gap:10px;margin-top:8px">
          <button class="btn" onclick="openApp('settings')">⚙️ Nastavení data a času</button>
        </div>
      </div>`;
    clockInterval = setInterval(updateAnalogClock, 1000);
    updateAnalogClock();
  } else if (tab === 'world') {
    const zones = [
      {city:'Praha', tz:'Europe/Prague', flag:'🇨🇿'},
      {city:'Londýn', tz:'Europe/London', flag:'🇬🇧'},
      {city:'New York', tz:'America/New_York', flag:'🇺🇸'},
      {city:'Los Angeles', tz:'America/Los_Angeles', flag:'🇺🇸'},
      {city:'Tokio', tz:'Asia/Tokyo', flag:'🇯🇵'},
      {city:'Sydney', tz:'Australia/Sydney', flag:'🇦🇺'},
      {city:'Dubai', tz:'Asia/Dubai', flag:'🇦🇪'},
      {city:'São Paulo', tz:'America/Sao_Paulo', flag:'🇧🇷'},
    ];
    body.innerHTML = `<div class="worldclock-list" id="world-clocks">${zones.map(z => `
      <div class="worldclock-item">
        <div>
          <div class="wc-city">${z.flag} ${z.city}</div>
          <div class="wc-country">${z.tz}</div>
        </div>
        <div class="wc-time" id="wc-${z.city.replace(/\s/g,'')}">--:--</div>
      </div>`).join('')}</div>`;
    function updateWorld() {
      zones.forEach(z => {
        const el = document.getElementById('wc-' + z.city.replace(/\s/g,''));
        if (!el) return;
        const time = new Date().toLocaleTimeString('cs-CZ', {hour:'2-digit', minute:'2-digit', timeZone: z.tz});
        el.textContent = time;
      });
    }
    updateWorld();
    clockInterval = setInterval(updateWorld, 1000);
  } else if (tab === 'stop') {
    body.innerHTML = `
      <div style="display:flex;flex-direction:column;align-items:center;padding:20px">
        <div class="stopwatch-display" id="sw-display">00:00.00</div>
        <div style="display:flex;gap:12px;margin-bottom:16px">
          <button class="btn btn-primary" id="sw-start-btn" onclick="swToggle()">▶ Start</button>
          <button class="btn" onclick="swLap()">🏁 Kolo</button>
          <button class="btn" onclick="swReset()">↺ Reset</button>
        </div>
        <div class="stopwatch-laps" id="sw-laps"></div>
      </div>`;
  }
}

function updateAnalogClock() {
  const now = new Date();
  const h = now.getHours() % 12, m = now.getMinutes(), s = now.getSeconds();
  const hd = document.getElementById('hand-h');
  const md = document.getElementById('hand-m');
  const sd = document.getElementById('hand-s');
  const dl = document.getElementById('analog-date-label');
  const dc = document.getElementById('digital-clock');
  if (hd) hd.style.transform = `rotate(${h * 30 + m * 0.5}deg)`;
  if (md) md.style.transform = `rotate(${m * 6}deg)`;
  if (sd) sd.style.transform = `rotate(${s * 6}deg)`;
  if (dl) dl.textContent = now.toLocaleDateString('cs-CZ', {weekday:'long', month:'long', day:'numeric'});
  if (dc) dc.textContent = now.toLocaleTimeString('cs-CZ', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
}

function swToggle() {
  if (stopwatchRunning) {
    clearInterval(stopwatchInterval);
    stopwatchElapsed += Date.now() - stopwatchStart;
    stopwatchRunning = false;
    document.getElementById('sw-start-btn').textContent = '▶ Start';
  } else {
    stopwatchStart = Date.now();
    stopwatchRunning = true;
    document.getElementById('sw-start-btn').textContent = '⏸ Stop';
    stopwatchInterval = setInterval(() => {
      const total = stopwatchElapsed + (Date.now() - stopwatchStart);
      const ms = Math.floor(total / 10) % 100;
      const sec = Math.floor(total / 1000) % 60;
      const min = Math.floor(total / 60000);
      const d = document.getElementById('sw-display');
      if (d) d.textContent = `${String(min).padStart(2,'0')}:${String(sec).padStart(2,'0')}.${String(ms).padStart(2,'0')}`;
    }, 10);
  }
}

function swLap() {
  if (!stopwatchRunning) return;
  const total = stopwatchElapsed + (Date.now() - stopwatchStart);
  const ms = Math.floor(total / 10) % 100;
  const sec = Math.floor(total / 1000) % 60;
  const min = Math.floor(total / 60000);
  const lapStr = `${String(min).padStart(2,'0')}:${String(sec).padStart(2,'0')}.${String(ms).padStart(2,'0')}`;
  stopwatchLaps.push(lapStr);
  const laps = document.getElementById('sw-laps');
  if (laps) laps.innerHTML = stopwatchLaps.map((l,i) => `<div class="lap-row"><span>Kolo ${i+1}</span><span>${l}</span></div>`).reverse().join('');
}

function swReset() {
  clearInterval(stopwatchInterval);
  stopwatchRunning = false;
  stopwatchElapsed = 0;
  stopwatchLaps = [];
  const d = document.getElementById('sw-display');
  if (d) d.textContent = '00:00.00';
  const laps = document.getElementById('sw-laps');
  if (laps) laps.innerHTML = '';
  const btn = document.getElementById('sw-start-btn');
  if (btn) btn.textContent = '▶ Start';
}

// ================================================================
//   WEATHER APP
// ================================================================
const WEATHER_DATA = {
  city: 'Praha',
  temp: 18,
  feels: 16,
  condition: '⛅ Polojasno',
  humidity: 62,
  wind: '15 km/h',
  pressure: '1013 hPa',
  visibility: '10 km',
  uv: 4,
  forecast: [
    {day:'Dnes', emoji:'⛅', hi:18, lo:10},
    {day:'Út', emoji:'🌧️', hi:14, lo:9},
    {day:'St', emoji:'🌦️', hi:16, lo:11},
    {day:'Čt', emoji:'☀️', hi:22, lo:13},
    {day:'Pá', emoji:'☀️', hi:25, lo:14},
    {day:'So', emoji:'⛅', hi:21, lo:12},
    {day:'Ne', emoji:'🌩️', hi:17, lo:10},
  ],
  hourly: [
    {time:'Nyní', emoji:'⛅', temp:18},
    {time:'14:00', emoji:'⛅', temp:19},
    {time:'15:00', emoji:'☀️', temp:20},
    {time:'16:00', emoji:'☀️', temp:21},
    {time:'17:00', emoji:'⛅', temp:20},
    {time:'18:00', emoji:'🌤️', temp:18},
    {time:'19:00', emoji:'🌤️', temp:16},
    {time:'20:00', emoji:'🌙', temp:14},
    {time:'21:00', emoji:'🌙', temp:13},
  ],
};

function openWeather() {
  createWindow('weather', 'Počasí', 680, 580, body => {
    const w = WEATHER_DATA;
    body.innerHTML = `
      <div class="weather-wrap">
        <div class="weather-bg-gradient"></div>
        <div class="weather-content">
          <div class="weather-city">${w.city}</div>
          <div class="weather-conditions">${w.condition}</div>
          <div class="weather-temp-big">${w.temp}°</div>
          <div style="display:flex;gap:20px;font-size:13px;opacity:0.85;margin-top:-8px;margin-bottom:4px">
            <span>Pociťováno: ${w.feels}°</span>
            <span>Vlhkost: ${w.humidity}%</span>
            <span>Vítr: ${w.wind}</span>
          </div>

          <div style="font-size:12px;font-weight:600;opacity:0.7;text-transform:uppercase;letter-spacing:0.5px;margin:16px 0 6px">Hodinová předpověď</div>
          <div class="weather-hourly">
            ${w.hourly.map(h => `<div class="weather-hour"><div class="weather-hour-time">${h.time}</div><div class="weather-hour-emoji">${h.emoji}</div><div class="weather-hour-temp">${h.temp}°</div></div>`).join('')}
          </div>

          <div style="font-size:12px;font-weight:600;opacity:0.7;text-transform:uppercase;letter-spacing:0.5px;margin:16px 0 6px">7denní předpověď</div>
          <div class="weather-forecast">
            ${w.forecast.map(f => `<div class="weather-day"><div class="weather-day-name">${f.day}</div><div class="weather-day-emoji">${f.emoji}</div><div class="weather-day-hi">${f.hi}°</div><div class="weather-day-lo">${f.lo}°</div></div>`).join('')}
          </div>

          <div style="font-size:12px;font-weight:600;opacity:0.7;text-transform:uppercase;letter-spacing:0.5px;margin:16px 0 6px">Detaily</div>
          <div class="weather-details">
            <div class="weather-detail"><div class="weather-detail-label">💧 Vlhkost</div><div class="weather-detail-val">${w.humidity}%</div></div>
            <div class="weather-detail"><div class="weather-detail-label">💨 Vítr</div><div class="weather-detail-val">${w.wind}</div></div>
            <div class="weather-detail"><div class="weather-detail-label">🌡️ Tlak</div><div class="weather-detail-val">${w.pressure}</div></div>
            <div class="weather-detail"><div class="weather-detail-label">👁️ Viditelnost</div><div class="weather-detail-val">${w.visibility}</div></div>
            <div class="weather-detail"><div class="weather-detail-label">☀️ UV index</div><div class="weather-detail-val">${w.uv}</div><div class="weather-detail-sub">Střední</div></div>
            <div class="weather-detail"><div class="weather-detail-label">🌡️ Pociťováno</div><div class="weather-detail-val">${w.feels}°C</div></div>
          </div>
        </div>
      </div>`;
    // Animate gradient based on time
    const hour = new Date().getHours();
    const wrap = body.querySelector('.weather-bg-gradient');
    if (hour < 6 || hour > 20) wrap.style.background = 'linear-gradient(160deg,#0c1445,#1a2455,#2a3a70)';
    else if (hour < 9) wrap.style.background = 'linear-gradient(160deg,#ff8c42,#ffb347,#ffd700,#87ceeb)';
    else if (hour > 17) wrap.style.background = 'linear-gradient(160deg,#ff4757,#ff6b6b,#ffa07a,#5e35b1)';
    else wrap.style.background = 'linear-gradient(160deg,#4facfe 0%,#00f2fe 50%,#a18cd1 100%)';
  });
}

// ================================================================
//   STOCKS APP
// ================================================================
const STOCKS_DATA = [
  {ticker:'AAPL', name:'Apple Inc.', price:182.52, change:+1.24, pct:+0.68, color:'up', history: [175,176,178,179,181,180,182,183,181,182,184,182]},
  {ticker:'MSFT', name:'Microsoft Corp.', price:415.30, change:+3.45, pct:+0.84, color:'up', history: [405,407,410,412,413,415,414,416,417,415,416,415]},
  {ticker:'GOOGL', name:'Alphabet Inc.', price:162.18, change:-0.82, pct:-0.50, color:'down', history: [165,164,163,162,163,161,162,163,162,161,163,162]},
  {ticker:'AMZN', name:'Amazon.com Inc.', price:193.61, change:+2.10, pct:+1.10, color:'up', history: [188,190,191,192,193,192,194,193,195,194,193,194]},
  {ticker:'META', name:'Meta Platforms', price:498.24, change:-5.32, pct:-1.06, color:'down', history: [510,508,505,503,500,502,498,499,497,498,499,498]},
  {ticker:'NVDA', name:'NVIDIA Corp.', price:875.39, change:+12.50, pct:+1.45, color:'up', history: [850,855,860,858,865,870,868,875,880,875,878,875]},
  {ticker:'TSLA', name:'Tesla Inc.', price:177.42, change:-3.18, pct:-1.76, color:'down', history: [185,183,180,178,181,179,177,178,176,178,177,177]},
  {ticker:'BTC-EUR', name:'Bitcoin EUR', price:56840, change:+840, pct:+1.50, color:'up', history: [54000,54500,55000,55500,56000,55800,56200,56500,56800,56400,56700,56840]},
];

function openStocks() {
  createWindow('stocks', 'Akcie', 700, 540, body => {
    const now = new Date().toLocaleDateString('cs-CZ', {weekday:'long', day:'numeric', month:'long'});
    body.innerHTML = `
      <div class="stocks-wrap">
        <div class="stocks-header">
          <div>
            <div class="stocks-date">${now}</div>
            <div style="font-size:12px;color:var(--text-sec)">Newyorská burza • Simulovaná data</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn btn-sm" onclick="stocksRefreshData()">🔄 Obnovit</button>
          </div>
        </div>
        <div class="stocks-list" id="stocks-list"></div>
      </div>`;
    renderStocksList();
  });
}

function renderStocksList() {
  const list = document.getElementById('stocks-list');
  if (!list) return;
  list.innerHTML = STOCKS_DATA.map((s, i) => `
    <div class="stock-row" onclick="stockDetail(${i})">
      <div style="width:44px;height:44px;border-radius:10px;background:${s.color==='up'?'linear-gradient(135deg,#30d158,#1a8a3a)':'linear-gradient(135deg,#ff3b30,#8a1a1a)'};display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;color:#fff;flex-shrink:0">${s.ticker.charAt(0)}</div>
      <div style="flex:1;min-width:0;margin-left:12px">
        <div class="stock-ticker">${s.ticker}</div>
        <div class="stock-company">${s.name}</div>
      </div>
      <canvas class="stock-sparkline" id="spark-${i}"></canvas>
      <div style="text-align:right;margin-left:12px">
        <div class="stock-price">$${typeof s.price === 'number' && s.price > 1000 ? s.price.toLocaleString('cs-CZ') : s.price.toFixed(2)}</div>
        <div class="stock-change ${s.color}">${s.change > 0 ? '+' : ''}${s.change.toFixed(2)} (${s.pct > 0 ? '+' : ''}${s.pct.toFixed(2)}%)</div>
      </div>
    </div>`).join('');
  // Draw sparklines
  STOCKS_DATA.forEach((s, i) => {
    const canvas = document.getElementById('spark-' + i);
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    canvas.width = 60; canvas.height = 30;
    const data = s.history;
    const min = Math.min(...data), max = Math.max(...data), range = max - min || 1;
    ctx.strokeStyle = s.color === 'up' ? '#30d158' : '#ff3b30';
    ctx.lineWidth = 1.5;
    ctx.beginPath();
    data.forEach((val, j) => {
      const x = (j / (data.length - 1)) * 58 + 1;
      const y = 28 - ((val - min) / range) * 26;
      j === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    });
    ctx.stroke();
  });
}

function stocksRefreshData() {
  // Simulate price updates
  STOCKS_DATA.forEach(s => {
    const change = (Math.random() - 0.48) * 3;
    s.price = Math.max(1, s.price + change);
    s.change = change;
    s.pct = (change / (s.price - change)) * 100;
    s.color = change >= 0 ? 'up' : 'down';
    s.history.push(s.price);
    if (s.history.length > 15) s.history.shift();
  });
  renderStocksList();
  notify('📈 Akcie', 'Data aktualizována.');
}

function stockDetail(idx) {
  const s = STOCKS_DATA[idx];
  notify(`${s.ticker} — $${s.price.toFixed(2)}`, `${s.name}\n${s.change > 0 ? '+' : ''}${s.change.toFixed(2)} (${s.pct.toFixed(2)}%)`);
}

// ================================================================
//   TETRIS GAME
// ================================================================
let tetrisGame = null;

function openTetris() {
  createWindow('tetris', '🎮 Tetris', 560, 600, body => {
    body.style.padding = '0';
    body.innerHTML = `
      <div class="tetris-wrap">
        <div class="tetris-board-wrap">
          <div style="position:relative">
            <canvas class="tetris-canvas" id="tetris-canvas" width="200" height="400"></canvas>
            <div class="tetris-overlay" id="tetris-overlay">
              <div class="tetris-overlay-title">🎮 TETRIS</div>
              <div style="font-size:14px;color:#8888aa;text-align:center">Skládej bloky a smaž řádky!</div>
              <button class="btn btn-primary" onclick="tetrisStart()" style="font-size:14px;padding:10px 28px">▶ Hrát</button>
            </div>
          </div>
        </div>
        <div class="tetris-side">
          <div class="tetris-stat">
            <div class="tetris-stat-label">Skóre</div>
            <div class="tetris-stat-val" id="tet-score">0</div>
          </div>
          <div class="tetris-stat">
            <div class="tetris-stat-label">Úroveň</div>
            <div class="tetris-stat-val" id="tet-level">1</div>
          </div>
          <div class="tetris-stat">
            <div class="tetris-stat-label">Řádky</div>
            <div class="tetris-stat-val" id="tet-lines">0</div>
          </div>
          <div class="tetris-stat">
            <div class="tetris-stat-label">Další</div>
            <canvas class="tetris-next-canvas" id="tetris-next" width="80" height="80"></canvas>
          </div>
          <div class="tetris-controls">
            ← → Pohyb<br>
            ↑ Rotace<br>
            ↓ Rychlý pád<br>
            Space Okamžitý pád<br>
            P Pauza
          </div>
          <button class="btn btn-sm" onclick="tetrisStart()" id="tet-restart-btn" style="display:none">🔄 Nová hra</button>
        </div>
      </div>`;
    // Don't auto-start — wait for click
  });
}

// Tetris implementation
const TETROMINOS = {
  I: {shape:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]], color:'#00f2fe'},
  J: {shape:[[1,0,0],[1,1,1],[0,0,0]], color:'#12c2e9'},
  L: {shape:[[0,0,1],[1,1,1],[0,0,0]], color:'#f64f59'},
  O: {shape:[[1,1],[1,1]], color:'#ffd200'},
  S: {shape:[[0,1,1],[1,1,0],[0,0,0]], color:'#43e97b'},
  T: {shape:[[0,1,0],[1,1,1],[0,0,0]], color:'#c471ed'},
  Z: {shape:[[1,1,0],[0,1,1],[0,0,0]], color:'#fc466b'},
};
const TET_COLS = 10;
const TET_ROWS = 20;
const TET_CELL = 20;

function tetrisStart() {
  const canvas = document.getElementById('tetris-canvas');
  const nextCanvas = document.getElementById('tetris-next');
  const overlay = document.getElementById('tetris-overlay');
  const restartBtn = document.getElementById('tet-restart-btn');
  if (!canvas) return;
  if (overlay) overlay.style.display = 'none';
  if (restartBtn) restartBtn.style.display = '';

  if (tetrisGame) {
    clearInterval(tetrisGame.interval);
  }

  const board = Array.from({length: TET_ROWS}, () => Array(TET_COLS).fill(0));
  const ctx = canvas.getContext('2d');
  const nctx = nextCanvas?.getContext('2d');

  let score = 0, level = 1, lines = 0;
  let currentPiece = null, nextPiece = null;
  let paused = false;

  function randomPiece() {
    const keys = Object.keys(TETROMINOS);
    const key = keys[Math.floor(Math.random() * keys.length)];
    const t = TETROMINOS[key];
    return {
      shape: t.shape.map(r => [...r]),
      color: t.color,
      x: Math.floor(TET_COLS / 2) - Math.floor(t.shape[0].length / 2),
      y: 0
    };
  }

  function drawCell(ctx, x, y, color, size=TET_CELL) {
    ctx.fillStyle = color;
    ctx.fillRect(x * size + 1, y * size + 1, size - 2, size - 2);
    ctx.fillStyle = 'rgba(255,255,255,0.2)';
    ctx.fillRect(x * size + 1, y * size + 1, size - 2, 4);
    ctx.fillStyle = 'rgba(0,0,0,0.15)';
    ctx.fillRect(x * size + 1, y * size + size - 5, size - 2, 4);
  }

  function drawBoard() {
    ctx.fillStyle = '#0a0a0f';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    // Grid
    ctx.strokeStyle = 'rgba(100,100,200,0.08)';
    ctx.lineWidth = 0.5;
    for (let c = 1; c < TET_COLS; c++) { ctx.beginPath(); ctx.moveTo(c*TET_CELL,0); ctx.lineTo(c*TET_CELL,canvas.height); ctx.stroke(); }
    for (let r = 1; r < TET_ROWS; r++) { ctx.beginPath(); ctx.moveTo(0,r*TET_CELL); ctx.lineTo(canvas.width,r*TET_CELL); ctx.stroke(); }
    // Board
    board.forEach((row, y) => row.forEach((val, x) => { if (val) drawCell(ctx, x, y, val); }));
    // Ghost piece
    if (currentPiece) {
      let ghostY = currentPiece.y;
      while (!collides(currentPiece.shape, currentPiece.x, ghostY + 1)) ghostY++;
      ctx.globalAlpha = 0.25;
      currentPiece.shape.forEach((row, dy) => row.forEach((val, dx) => {
        if (val) drawCell(ctx, currentPiece.x + dx, ghostY + dy, currentPiece.color);
      }));
      ctx.globalAlpha = 1;
      // Current piece
      currentPiece.shape.forEach((row, dy) => row.forEach((val, dx) => {
        if (val) drawCell(ctx, currentPiece.x + dx, currentPiece.y + dy, currentPiece.color);
      }));
    }
  }

  function drawNext() {
    if (!nctx || !nextPiece) return;
    nctx.fillStyle = '#0a0a0f';
    nctx.fillRect(0, 0, 80, 80);
    const size = 14;
    const offX = Math.floor((5 - nextPiece.shape[0].length) / 2);
    const offY = Math.floor((5 - nextPiece.shape.length) / 2);
    nextPiece.shape.forEach((row, y) => row.forEach((val, x) => {
      if (val) {
        nctx.fillStyle = nextPiece.color;
        nctx.fillRect((offX+x)*size+4, (offY+y)*size+4, size-2, size-2);
      }
    }));
  }

  function collides(shape, px, py) {
    return shape.some((row, dy) => row.some((val, dx) => {
      if (!val) return false;
      const nx = px + dx, ny = py + dy;
      return nx < 0 || nx >= TET_COLS || ny >= TET_ROWS || (ny >= 0 && board[ny][nx]);
    }));
  }

  function rotate(shape) {
    const rows = shape.length, cols = shape[0].length;
    const rotated = Array.from({length: cols}, (_, i) => Array.from({length: rows}, (_, j) => shape[rows - 1 - j][i]));
    return rotated;
  }

  function lockPiece() {
    currentPiece.shape.forEach((row, dy) => row.forEach((val, dx) => {
      if (val) {
        const y = currentPiece.y + dy;
        if (y >= 0) board[y][currentPiece.x + dx] = currentPiece.color;
      }
    }));
    // Clear lines
    let cleared = 0;
    for (let r = TET_ROWS - 1; r >= 0; r--) {
      if (board[r].every(c => c)) {
        board.splice(r, 1);
        board.unshift(Array(TET_COLS).fill(0));
        cleared++;
        r++;
      }
    }
    if (cleared) {
      const pts = [0, 100, 300, 500, 800];
      score += (pts[cleared] || 800) * level;
      lines += cleared;
      level = Math.floor(lines / 10) + 1;
      const el = document.getElementById('tet-score'); if (el) el.textContent = score.toLocaleString();
      const ll = document.getElementById('tet-lines'); if (ll) ll.textContent = lines;
      const lv = document.getElementById('tet-level'); if (lv) lv.textContent = level;
    }
    currentPiece = nextPiece;
    nextPiece = randomPiece();
    drawNext();
    if (collides(currentPiece.shape, currentPiece.x, currentPiece.y)) {
      // Game over
      clearInterval(tetrisGame.interval);
      ctx.fillStyle = 'rgba(0,0,0,0.75)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = '#c8c8ff';
      ctx.font = 'bold 20px monospace';
      ctx.textAlign = 'center';
      ctx.fillText('GAME OVER', canvas.width / 2, canvas.height / 2 - 20);
      ctx.font = '14px monospace';
      ctx.fillStyle = '#8888aa';
      ctx.fillText('Skóre: ' + score.toLocaleString(), canvas.width / 2, canvas.height / 2 + 10);
      notify('🎮 Tetris', 'Game Over! Skóre: ' + score.toLocaleString());
    }
  }

  function gameLoop() {
    if (paused) return;
    if (!collides(currentPiece.shape, currentPiece.x, currentPiece.y + 1)) {
      currentPiece.y++;
    } else {
      lockPiece();
    }
    drawBoard();
  }

  currentPiece = randomPiece();
  nextPiece = randomPiece();
  drawNext();
  drawBoard();

  const intervalMs = () => Math.max(100, 600 - (level - 1) * 50);
  let interval = setInterval(gameLoop, intervalMs());
  tetrisGame = {interval, board, paused: false};

  function handleKey(e) {
    if (!currentPiece) return;
    const pc = currentPiece;
    if (e.key === 'ArrowLeft') {
      if (!collides(pc.shape, pc.x - 1, pc.y)) pc.x--;
    } else if (e.key === 'ArrowRight') {
      if (!collides(pc.shape, pc.x + 1, pc.y)) pc.x++;
    } else if (e.key === 'ArrowDown') {
      if (!collides(pc.shape, pc.x, pc.y + 1)) pc.y++;
    } else if (e.key === 'ArrowUp') {
      const rot = rotate(pc.shape);
      if (!collides(rot, pc.x, pc.y)) pc.shape = rot;
    } else if (e.key === ' ') {
      while (!collides(pc.shape, pc.x, pc.y + 1)) pc.y++;
      lockPiece();
    } else if (e.key === 'p' || e.key === 'P') {
      paused = !paused;
      tetrisGame.paused = paused;
    }
    drawBoard();
    e.preventDefault();
  }

  canvas.setAttribute('tabindex', '0');
  canvas.focus();
  canvas.addEventListener('keydown', handleKey);
  // Also listen globally when window is focused
  const winEl = canvas.closest('.window');
  if (winEl) {
    winEl.addEventListener('keydown', handleKey);
  }
}

// ================================================================
//   OPENAPP ROUTING — ADD NEW APPS
// ================================================================
document.addEventListener('keydown',e=>{
  if((e.metaKey||e.ctrlKey)&&e.key===' '){e.preventDefault();toggleSpotlight();}
  if(e.key==='Escape'){mbCloseAll();hideCtxMenu();const lp=document.getElementById('launchpad');if(lp?.style.display==='flex'){closeLaunchpad();return;}const sw=document.getElementById('spotlight-wrap');if(sw?.style.display==='flex'){toggleSpotlight();return;}}
  if((e.metaKey||e.ctrlKey)&&e.shiftKey&&e.key==='d'){e.preventDefault();toggleDarkMode();}
});
document.addEventListener('click',e=>{
  if(!e.target.closest('.mb-menu-dropdown')&&!e.target.closest('.mb-apple')&&!e.target.closest('.mb-item')&&!e.target.closest('#control-center'))mbCloseAll();
});
document.addEventListener('contextmenu',e=>e.preventDefault());

// Dock autohide
document.addEventListener('mousemove',e=>{
  const dw=document.getElementById('dock-wrap');if(!dw||dw.dataset.ah!=='1')return;
  if(e.clientY>window.innerHeight-80)dw.style.transform='translateX(-50%) translateY(0)';
  else dw.style.transform='translateX(-50%) translateY(calc(100% + 10px))';
},{passive:true});

// ================================================================
//   CLOCK
// ================================================================
function startClock(){function update(){const now=new Date();const cl=document.getElementById('clock');if(cl)cl.textContent=now.toLocaleString('cs-CZ',{weekday:'short',hour:'2-digit',minute:'2-digit'});}update();setInterval(update,1000);}

// setVolume override
function setVolume(v) {
  S.volume = parseInt(v);
  saveState();
  const vs = document.getElementById('vol-slider');
  const vp = document.getElementById('vol-pct');
  const cvs = document.getElementById('cc-vol-slider');
  if (vs) vs.value = v;
  if (vp) vp.textContent = v + '%';
  if (cvs) cvs.value = v;
  // Apply to any playing audio
  if (musicAudio) musicAudio.volume = S.volume / 100;
}

// ================================================================
//   INIT
// ================================================================
function init(){
  applyDarkMode();applyWallpaper();
  document.documentElement.style.setProperty('--dock-sz',S.dockSize+'px');
  const PREINSTALLED=['finder','safari','calculator','music','tv','photos','settings','appstore','mail','trash','launchpad','tetris','terminal','notes','maps','clock','weather','stocks'];
  PREINSTALLED.forEach(id=>{if(!S.installedApps.includes(id))S.installedApps.push(id);});
  // Reset dock pins to include new apps on fresh install
  const expectedPins = ['finder','launchpad','safari','music','tv','notes','maps','weather','clock','settings','appstore','calculator'];
  if (S.dockPinned.length < 6) S.dockPinned = expectedPins;
  S.dockPinned=S.dockPinned.filter(id=>S.installedApps.includes(id)||['finder','launchpad','trash'].includes(id));
  if (!S.notes || !Array.isArray(S.notes)) {
    S.notes = [{id:1,title:'Vítejte v Poznámkách!',content:'Toto je vaše první poznámka.\nMůžete psát cokoliv chcete.',date:new Date().toLocaleDateString('cs-CZ')}];
  }
  initFS();saveState();buildDock();renderDesktopIcons();buildLaunchpad();startClock();
  // Battery simulation
  let batt = 87;
  setInterval(() => {
    batt = Math.max(5, batt - Math.random() * 0.05);
    const b = document.getElementById('mb-battery-pct');
    if (b) b.textContent = Math.floor(batt) + '%';
    const icon = document.getElementById('mb-battery-icon');
    if (icon) {
      const iconName = batt > 75 ? 'fa-battery-full' : batt > 50 ? 'fa-battery-three-quarters' : batt > 25 ? 'fa-battery-half' : batt > 10 ? 'fa-battery-quarter' : 'fa-battery-empty';
      icon.innerHTML = `<i class="fas ${iconName}" style="font-size:12px"></i> <span id="mb-battery-pct">${Math.floor(batt)}%</span>`;
    }
  }, 30000);
  setTimeout(()=>notify('🍎 Vítejte v AiOS!','Liquid Glass Edition • Dvojklikem otevřete aplikace. Klikněte na horní lištu pro menu.'),800);
  setTimeout(()=>notify('🎵 Apple Music','Přidejte vlastní MP3 soubory v aplikaci Hudba → "Moje soubory"'),3500);
}
init();

</script>
</body>
</html>